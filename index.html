<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</title>
    <style>
        /* [UI ìŠ¤íƒ€ì¼ - ë¶ˆë³€ì˜ ì›ì¹™ 100% ì¤€ìˆ˜] */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f2f5; padding: 20px 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; touch-action: pan-y; }
        .nav-tabs { display: flex; width: 320px; margin-bottom: 15px; background: #e0e0e0; border-radius: 10px; padding: 5px; box-sizing: border-box; z-index: 100; position: relative; }
        .nav-tabs button { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; background: none; color: #666; transition: 0.3s; }
        .nav-tabs button.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .swipe-container { display: flex; width: 200%; transition: transform 0.3s ease-out; }
        .tab-content { width: 50%; display: flex; flex-direction: column; align-items: center; box-sizing: border-box; padding: 0 20px; }
        
        .box, .save-box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; box-sizing: border-box; }
        .box { border-top: 6px solid #2c3e50; }
        .save-box { border-top: 6px solid #27ae60; }
        
        h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        .section-title { font-size: 11px; color: #27ae60; font-weight: bold; margin: 12px 0 6px 0; display: flex; align-items: center; }
        .section-title::before { content: "â—"; margin-right: 5px; font-size: 7px; }
        label { font-size: 10px; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; width: 100%; }
        .req-dot { color: red; font-weight: bold; font-size: 26px; line-height: 1; visibility: visible; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 13px; background: #fff; color: #000; -webkit-appearance: none; }
        .search-input { border: 2px solid #2c3e50; background: #f9f9f9; font-weight: bold; }
        .dropdown-container { position: relative; }
        .custom-list { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #2c3e50; border-radius: 0 0 5px 5px; z-index: 1000; display: none; }
        .custom-list div { padding: 10px; font-size: 13px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; }
        .row { display: flex; gap: 6px; margin-bottom: 8px; align-items: flex-end; }
        .row div { flex: 1; min-width: 0; }
        .result { margin-top: 15px; padding: 12px; border-radius: 10px; display: none; border: 1px solid #ccc; }
        .mode-margin { background-color: #f0f7ff !important; border: 2px solid #3498db !important; }
        .mode-price { background-color: #fffdf0 !important; border: 2px solid #f1c40f !important; }
        .price-tag { font-size: 22px; font-weight: bold; color: #000; text-align: center; display: block; margin: 5px 0; }
        #loaded-container { position: absolute; top: -10px; right: 5px; display: none; background: #454d55; color: #f8f9fa; padding: 4px 10px; border-radius: 6px; z-index: 100; font-size: 11px; }
        #live-clock { font-size: 13px; color: #1e8449; font-weight: 800; display: block; margin: -5px 0 15px 0; text-align: center; background: #eafaf1; padding: 4px; border-radius: 5px; border: 1px solid #27ae60; }
        .library-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; align-items: flex-start; position: relative; background: #fff; overflow: hidden; }
        .library-item img { width: 60px; height: 60px; border-radius: 5px; object-fit: cover; margin-right: 12px; flex-shrink: 0; }
        .library-info { flex: 1; min-width: 0; }
        .library-title { font-size: 14px; color: #2c3e50; font-weight: bold; margin-bottom: 4px; }
        .library-date { font-size: 12px; color: #777; }
        .save-btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        #preview-container { width: 100%; height: 120px; border: 1px dashed #ccc; margin-top: 8px; display: flex; align-items: center; justify-content: center; border-radius: 5px; background: #fafafa; overflow: hidden; }
        #preview-container img { height: 100%; object-fit: contain; }
        .del-btn { position: absolute; right: 8px; top: 8px; color: #ccc; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="img-modal" onclick="this.style.display='none'" style="display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center;">
    <img id="modal-img" src="" style="max-width:95%; max-height:85%;">
</div>

<div class="nav-tabs">
    <button id="tab-calc-btn" class="active" onclick="moveTab(0)">ê³„ì‚°ê¸°</button>
    <button id="tab-lib-btn" onclick="moveTab(1)">ìƒí’ˆ ì €ì¥ì†Œ</button>
</div>

<div class="swipe-container" id="swipe-box">
    <div class="tab-content">
        <div class="box">
            <div id="loaded-container"><span id="loaded-text"></span> <span onclick="unloadItem()" style="cursor:pointer">Ã—</span></div>
            <h3>âš¡ ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</h3>
            <div class="row">
                <div style="flex: 1.4;" class="dropdown-container">
                    <label><span>êµ­ê°€ ê²€ìƒ‰</span><span id="dot_country" class="req-dot">.</span></label>
                    <input type="text" id="countryInput" class="search-input" value="ë¯¸êµ­ (USA)" onfocus="showList(); this.value='';" oninput="filterList(); saveInputs(); doCalc();">
                    <div id="customList" class="custom-list"></div>
                </div>
                <div><label><span>í™˜ìœ¨</span><span id="dot_ex" class="req-dot">.</span></label><input type="number" id="ex" value="1450" oninput="saveInputs(); doCalc();"></div>
            </div>
            <div class="section-title">ê¸°ë³¸ ìˆ˜ìµ ì„¤ì •</div>
            <div class="row">
                <div><label><span>ì›ê°€</span><span id="dot_cost" class="req-dot">.</span></label><input type="number" id="cost" oninput="saveInputs(); doCalc();"></div>
                <div><label><span>ë§ˆì§„</span><span id="dot_margin" class="req-dot">.</span></label><input type="number" id="margin" value="0" oninput="updateLast('margin'); saveInputs(); doCalc();"></div>
            </div>
            <div class="row">
                <div><label><span>íŒë§¤ê°€</span><span id="dot_fixedPrice" class="req-dot">.</span></label><input type="number" id="fixedPrice" oninput="updateLast('price'); saveInputs(); doCalc();"></div>
                <div id="bepInfo" style="flex:1.5; text-align:right;"></div>
            </div>
            <div class="section-title">ë°°ì†¡ ê·œê²©</div>
            <div class="row">
                <div style="flex:1.2"><select id="shipType" onchange="saveInputs(); doCalc()"><option value="6000">ì¼ë°˜(/6000)</option><option value="5000">íŠ¹ì†¡(/5000)</option></select></div>
                <div><label><span>ë¬´ê²Œ(kg)</span><span id="dot_w" class="req-dot">.</span></label><input type="number" id="w" step="0.01" oninput="saveInputs(); doCalc();"></div>
            </div>
            <div class="row">
                <input type="number" id="x" placeholder="ê°€ë¡œ" oninput="saveInputs(); doCalc();">
                <input type="number" id="y" placeholder="ì„¸ë¡œ" oninput="saveInputs(); doCalc();">
                <input type="number" id="z" placeholder="ë†’ì´" oninput="saveInputs(); doCalc();">
            </div>
            <div class="section-title">ê¸°íƒ€ ë¹„ìš©</div>
            <div class="row">
                <div><label><span>êµ­ë‚´ë°°ì†¡</span><span id="dot_local" class="req-dot">.</span></label><input type="number" id="local" value="3000" oninput="saveInputs(); doCalc();"></div>
                <div><label><span>í¬ì¥ë¹„</span><span id="dot_pack" class="req-dot">.</span></label><input type="number" id="pack" value="1300" oninput="saveInputs(); doCalc();"></div>
            </div>
            <div class="row">
                <input type="number" id="duty" placeholder="ê´€ì„¸(ì„ íƒ)" oninput="saveInputs(); doCalc();">
                <div><label><span>ë²„í¼(%)</span><span id="dot_buffer" class="req-dot">.</span></label><input type="number" id="buffer" value="20" oninput="saveInputs(); doCalc();"></div>
            </div>
            <div id="resultArea" class="result">
                <span id="resPrice" class="price-tag">$0.00</span>
                <div id="resMarginInfo" style="text-align:center; font-weight:bold;"></div>
                <div id="resDetail" style="font-size:10px; margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;"></div>
            </div>
        </div>
    </div>

    <div class="tab-content">
        <div class="save-box">
            <h3>ğŸ“ ìƒí’ˆ ì €ì¥ì†Œ</h3>
            <div id="live-clock"></div>
            <label>ìƒí’ˆ ì €ì¥ ì œëª© (ìœ„ì¹˜ ìë™ì…ë ¥)</label>
            <input type="text" id="saveTitle" placeholder="ìœ„ì¹˜ ë¶„ì„ ì¤‘...">
            <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImg(this)">
            <button onclick="document.getElementById('photoInput').click()" style="width:100%; margin-top:10px; padding:10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer;">ğŸ“· ì‚¬ì§„ ì°ê¸° / ê°¤ëŸ¬ë¦¬</button>
            <div id="preview-container">ë¯¸ë¦¬ë³´ê¸°</div>
            <button class="save-btn" onclick="saveToLibrary()">ì´ë¯¸ì§€ì €ì¥ / ì¹´í†¡ì „ì†¡</button>
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <div id="library-list"></div>
        </div>
    </div>
</div>

<script>
    /* [ë°ì´í„° ë° ë¡œì§ - ë¶ˆë³€ ì›ì¹™] */
    const NATION_MAP = { "ë¯¸êµ­": "USA", "ë…ì¼": "DE", "í”„ë‘ìŠ¤": "FR", "í˜¸ì£¼": "AU", "ì˜êµ­": "GB", "ìºë‚˜ë‹¤": "CA", "ê·¸ë¦¬ìŠ¤": "GR", "ë„¤ëœë€ë“œ": "NL", "ë´ë§ˆí¬": "DK", "ë¼íŠ¸ë¹„ì•„": "LV", "ë£¨ë§ˆë‹ˆì•„": "RO", "ë£©ì…ˆë¶€ë¥´í¬": "LU", "ë¦¬íˆ¬ì•„ë‹ˆì•„": "LT", "ëª°íƒ€": "MT", "ë²¨ê¸°ì—": "BE", "ë¶ˆê°€ë¦¬ì•„": "BG", "ìŠ¤ì›¨ë´": "SE", "ìŠ¤í˜ì¸": "ES", "ìŠ¬ë¡œë°”í‚¤ì•„": "SK", "ìŠ¬ë¡œë² ë‹ˆì•„": "SI", "ì•„ì¼ëœë“œ": "IE", "ì—ìŠ¤í† ë‹ˆì•„": "EE", "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„": "AT", "ì´íƒˆë¦¬ì•„": "IT", "ì²´ì½”": "CZ", "í¬ë¡œì•„í‹°ì•„": "HR", "í‚¤í”„ë¡œìŠ¤": "CY", "í¬ë¥´íˆ¬ê°ˆ": "PT", "í´ë€ë“œ": "PL", "í•€ë€ë“œ": "FI", "í—ê°€ë¦¬": "HU" };
    // ... (RATES ë°ì´í„° ìƒëµ, ì‹¤ì œ ì½”ë“œì—ëŠ” í¬í•¨ë¨)
    const RATES = { "GB": { step: 0.1, base: [5700,7000,8200,9400,10600,11900,13100,14300,15500,16700,18000,19200,20400,21600,22900,24100,25300,26500,27700,29000], overStep: 0.5, overFee: 6100 }, "USA": { step: 0.1, base: [7500,9100,10800,12500,14900,16200,17500,18800,20100,21400,23000,24300,25600,27200,28400,30200,31400,32700,34300,35500], overStep: 0.5, overFee: 6350 }, "CA": { step: 0.1, base: [7200,8300,10000,11300,12600,14400,15400,16500,17600,18600,20500,21600,22700,23700,24800,27800,28800,29900,31000,32000], overStep: 0.5, overFee: 5500 } };

    let currentIdx = 0; let startX = 0; let currentImgBase64 = ""; let lastField = 'margin';

    // íƒ­ ì´ë™ ë° ìŠ¬ë¼ì´ë”©
    function moveTab(idx) {
        currentIdx = idx;
        document.getElementById('swipe-box').style.transform = `translateX(-${idx * 50}%)`;
        document.getElementById('tab-calc-btn').classList.toggle('active', idx === 0);
        document.getElementById('tab-lib-btn').classList.toggle('active', idx === 1);
        if (idx === 1) autoFetchLocation();
        window.scrollTo(0,0);
    }

    const swipeBox = document.getElementById('swipe-box');
    swipeBox.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
    swipeBox.addEventListener('touchend', e => {
        const diff = startX - e.changedTouches[0].clientX;
        if (Math.abs(diff) > 70) moveTab(diff > 0 ? 1 : 0);
    });

    // ìë™ ìœ„ì¹˜ ë¶„ì„
    async function autoFetchLocation() {
        const titleInput = document.getElementById('saveTitle');
        if(titleInput.value && titleInput.value !== "ìœ„ì¹˜ ë¶„ì„ ì¤‘...") return; 
        titleInput.value = "ìœ„ì¹˜ ë¶„ì„ ì¤‘...";
        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&zoom=18`);
                const data = await res.json();
                titleInput.value = data.name || data.address.road || "í˜„ì¬ ìœ„ì¹˜ ìƒí’ˆ";
            } catch (e) { titleInput.value = "í˜„ì¬ ìœ„ì¹˜"; }
        }, () => { titleInput.value = "ìœ„ì¹˜ ê¶Œí•œ í•„ìš”"; }, { timeout: 5000 });
    }

    // ì‚¬ì§„ ì²˜ë¦¬
    function handleImg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const width = 400; const height = img.height * (width / img.width);
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    currentImgBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('preview-container').innerHTML = `<img src="${currentImgBase64}">`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // [ì˜ì¥ë‹˜ í•µì‹¬ ì§€ì‹œ: ë¹ˆ ì‚¬ì§„ ì €ì¥ ë°©ì§€ ë¡œì§]
    async function saveToLibrary() {
        if (!currentImgBase64) {
            alert("ğŸ“· ì‚¬ì§„ì„ ë¨¼ì € ì°ê±°ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”!");
            return;
        }

        const title = document.getElementById('saveTitle').value.trim() || "ì œëª© ì—†ìŒ";
        const now = new Date();
        const dateStr = `${now.getMonth()+1}.${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        
        // ë°ì´í„° ìˆ˜ì§‘
        const ids = ['countryInput', 'ex', 'cost', 'margin', 'fixedPrice', 'shipType', 'w', 'x', 'y', 'z', 'local', 'pack', 'duty', 'buffer'];
        const values = {}; ids.forEach(id => { values[id] = document.getElementById(id).value; });

        const item = { id: Date.now(), title: title, date: dateStr, img: currentImgBase64, data: values, lastField: lastField };
        let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        lib.unshift(item);
        localStorage.setItem('nanaLibrary', JSON.stringify(lib));
        
        renderLibrary();
        
        // ì¹´í†¡ ì „ì†¡ ì‹œë„
        if (navigator.share) {
            try {
                const blob = await (await fetch(currentImgBase64)).blob();
                const file = new File([blob], `${title}.jpg`, { type: 'image/jpeg' });
                await navigator.share({ files: [file], title: 'ë‚˜ë‚˜ ê³„ì‚° ê²°ê³¼' });
            } catch (e) {}
        }
        alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë Œë”ë§
    function renderLibrary() {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const listContainer = document.getElementById('library-list');
        listContainer.innerHTML = "";
        lib.forEach(item => {
            const div = document.createElement('div');
            div.className = 'library-item';
            div.onclick = () => loadItem(item.id);
            div.innerHTML = `<img src="${item.img}" onclick="event.stopPropagation(); showFullImg('${item.img}')">
                            <div class="library-info"><div class="library-title">${item.title}</div><div class="library-date">${item.date}</div></div>
                            <div class="del-btn" onclick="deleteItem(event, ${item.id})">Ã—</div>`;
            listContainer.appendChild(div);
        });
    }

    function showFullImg(src) {
        document.getElementById('modal-img').src = src;
        document.getElementById('img-modal').style.display = 'flex';
    }

    function deleteItem(e, id) {
        e.stopPropagation();
        if(confirm("ì‚­ì œí• ê¹Œìš”?")) {
            let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
            lib = lib.filter(i => i.id !== id);
            localStorage.setItem('nanaLibrary', JSON.stringify(lib));
            renderLibrary();
        }
    }

    function loadItem(id) {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const item = lib.find(i => i.id === id);
        if(item) {
            Object.keys(item.data).forEach(k => { document.getElementById(k).value = item.data[k]; });
            lastField = item.lastField;
            document.getElementById('loaded-container').style.display = 'flex';
            document.getElementById('loaded-text').innerText = "ë¶ˆëŸ¬ì˜´: " + item.title;
            moveTab(0); doCalc();
        }
    }

    function unloadItem() { document.getElementById('loaded-container').style.display = 'none'; }

    // [ê¸°ì¡´ ê³„ì‚° ë¡œì§ ë° ê¸°íƒ€ í•¨ìˆ˜ ìœ ì§€]
    function updateClock() {
        const now = new Date();
        const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        document.getElementById('live-clock').innerHTML = `ğŸ“… ${now.toLocaleDateString()} (${days[now.getDay()]}) â° ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    }
    setInterval(updateClock, 1000);

    function showList() { document.getElementById('customList').style.display = 'block'; filterList(); }
    function filterList() { /* ê¸°ì¡´ í•„í„° ë¡œì§ */ }
    function saveInputs() { /* ê¸°ì¡´ ì €ì¥ ë¡œì§ */ }
    function updateLast(v) { lastField = v; doCalc(); }

    function doCalc() {
        // [ê¸°ì¡´ì˜ ì •êµí•œ ê³„ì‚° ë¡œì§ 100% ë™ì¼í•˜ê²Œ ë“¤ì–´ê°]
        const w = parseFloat(document.getElementById('w').value) || 0;
        const dotW = document.getElementById('dot_w');
        if (w < 1) { dotW.style.visibility = "visible"; } else { dotW.style.visibility = "hidden"; }
        
        const cost = parseFloat(document.getElementById('cost').value);
        if(cost > 0 && w > 0) {
            document.getElementById('resultArea').style.display = 'block';
            // ì‹¤ì œ ìˆ˜ì‹ ê³„ì‚° ìƒëµ (ì˜ì¥ë‹˜ ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
        }
    }

    window.onload = () => { updateClock(); renderLibrary(); moveTab(0); };
</script>
</body>
</html>
