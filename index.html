<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</title>
    <style>
        /* [UI ìŠ¤íƒ€ì¼ - ë¶ˆë³€ì˜ ì›ì¹™] */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        .nav-tabs { display: flex; width: 320px; margin-bottom: 15px; background: #e0e0e0; border-radius: 10px; padding: 5px; box-sizing: border-box; position: relative; z-index: 1000; }
        .nav-tabs button { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; background: none; color: #666; transition: 0.2s; }
        .nav-tabs button.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* [ìŠ¬ë¼ì´ë”© ìµœì í™”] transition ì†ë„ ë° ê°€ì†ë„ ì¡°ì ˆ */
        .swipe-viewport { width: 100vw; overflow: hidden; }
        .swipe-container { 
            display: flex; 
            width: 200vw; 
            transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* ì˜ˆì „ì˜ ì«€ë“í•œ ì†ë„ê° ë³µêµ¬ */
            will-change: transform;
        }
        .tab-content { width: 100vw; display: flex; flex-direction: column; align-items: center; box-sizing: border-box; flex-shrink: 0; }
        
        /* ê¸°ì¡´ ë°•ìŠ¤ ë””ìì¸ 100% ìœ ì§€ */
        .box, .save-box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; box-sizing: border-box; }
        .box { border-top: 6px solid #2c3e50; }
        .save-box { border-top: 6px solid #27ae60; }
        
        h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        .section-title { font-size: 11px; color: #27ae60; font-weight: bold; margin: 12px 0 6px 0; display: flex; align-items: center; }
        .section-title::before { content: "â—"; margin-right: 5px; font-size: 7px; }
        label { font-size: 10px; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; width: 100%; }
        .req-dot { color: red; font-weight: bold; font-size: 26px; line-height: 1; visibility: visible; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 13px; background: #fff; color: #000; -webkit-appearance: none; outline: none; }
        .search-input { border: 2px solid #2c3e50; background: #f9f9f9; font-weight: bold; }
        .dropdown-container { position: relative; }
        .custom-list { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #2c3e50; z-index: 1000; display: none; }
        .custom-list div { padding: 10px; font-size: 13px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; }
        .row { display: flex; gap: 6px; margin-bottom: 8px; align-items: flex-end; }
        .row div { flex: 1; min-width: 0; }
        .result { margin-top: 15px; padding: 12px; border-radius: 10px; display: none; border: 1px solid #ccc; }
        .mode-margin { background-color: #f0f7ff !important; border: 2px solid #3498db !important; }
        .mode-price { background-color: #fffdf0 !important; border: 2px solid #f1c40f !important; }
        .price-tag { font-size: 22px; font-weight: bold; color: #000; text-align: center; display: block; margin: 5px 0; }
        #loaded-container { position: absolute; top: -10px; right: 5px; display: none; background: #454d55; color: #f8f9fa; padding: 4px 10px; border-radius: 6px; z-index: 100; font-size: 11px; }
        #live-clock { font-size: 13px; color: #1e8449; font-weight: 800; display: block; margin: -5px 0 15px 0; text-align: center; background: #eafaf1; padding: 4px; border-radius: 5px; border: 1px solid #27ae60; }
        .library-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; align-items: flex-start; position: relative; background: #fff; }
        .library-item img { width: 60px; height: 60px; border-radius: 5px; object-fit: cover; margin-right: 12px; }
        .save-btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        #preview-container { width: 100%; height: 120px; border: 1px dashed #ccc; margin-top: 8px; display: flex; align-items: center; justify-content: center; border-radius: 5px; background: #fafafa; overflow: hidden; }
        #preview-container img { height: 100%; }
    </style>
</head>
<body>

<div id="img-modal" onclick="this.style.display='none'" style="display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center;">
    <img id="modal-img" src="" style="max-width:95%; max-height:85%;">
</div>

<div class="nav-tabs">
    <button id="tab-calc-btn" class="active" onclick="moveTab(0)">ê³„ì‚°ê¸°</button>
    <button id="tab-lib-btn" onclick="moveTab(1)">ìƒí’ˆ ì €ì¥ì†Œ</button>
</div>

<div class="swipe-viewport">
    <div class="swipe-container" id="swipe-box">
        <div class="tab-content" id="content-calc">
            <div class="box">
                <div id="loaded-container"><span id="loaded-text"></span> <span onclick="unloadItem()" style="cursor:pointer">Ã—</span></div>
                <h3>âš¡ ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</h3>
                <div class="row">
                    <div style="flex: 1.4;" class="dropdown-container">
                        <label><span>êµ­ê°€ ê²€ìƒ‰</span><span id="dot_country" class="req-dot">.</span></label>
                        <input type="text" id="countryInput" class="search-input" value="ë¯¸êµ­ (USA)" onfocus="showList(); this.value='';" oninput="filterList(); saveInputs(); doCalc();">
                        <div id="customList" class="custom-list"></div>
                    </div>
                    <div><label><span>í™˜ìœ¨</span><span id="dot_ex" class="req-dot">.</span></label><input type="number" id="ex" value="1450" oninput="saveInputs(); doCalc();"></div>
                </div>
                <div class="section-title">ê¸°ë³¸ ìˆ˜ìµ ì„¤ì •</div>
                <div class="row">
                    <div><label><span>ì›ê°€</span><span id="dot_cost" class="req-dot">.</span></label><input type="number" id="cost" oninput="saveInputs(); doCalc();"></div>
                    <div><label><span>ë§ˆì§„</span><span id="dot_margin" class="req-dot">.</span></label><input type="number" id="margin" value="0" oninput="updateLast('margin'); saveInputs(); doCalc();"></div>
                </div>
                <div class="row">
                    <div><label><span>íŒë§¤ê°€</span><span id="dot_fixedPrice" class="req-dot">.</span></label><input type="number" id="fixedPrice" oninput="updateLast('price'); saveInputs(); doCalc();"></div>
                    <div id="bepInfo" style="flex:1.5; text-align:right;"></div>
                </div>
                <div class="section-title">ë°°ì†¡ ê·œê²©</div>
                <div class="row">
                    <div style="flex:1.2"><select id="shipType" onchange="saveInputs(); doCalc()"><option value="6000">ì¼ë°˜(/6000)</option><option value="5000">íŠ¹ì†¡(/5000)</option></select></div>
                    <div><label><span>ë¬´ê²Œ(kg)</span><span id="dot_w" class="req-dot">.</span></label><input type="number" id="w" step="0.01" oninput="saveInputs(); doCalc();"></div>
                </div>
                <div class="row">
                    <input type="number" id="x" placeholder="ê°€ë¡œ" oninput="saveInputs(); doCalc();">
                    <input type="number" id="y" placeholder="ì„¸ë¡œ" oninput="saveInputs(); doCalc();">
                    <input type="number" id="z" placeholder="ë†’ì´" oninput="saveInputs(); doCalc();">
                </div>
                <div class="section-title">ê¸°íƒ€ ë¹„ìš©</div>
                <div class="row">
                    <div><label><span>êµ­ë‚´ë°°ì†¡</span><span id="dot_local" class="req-dot">.</span></label><input type="number" id="local" value="3000" oninput="saveInputs(); doCalc();"></div>
                    <div><label><span>í¬ì¥ë¹„</span><span id="dot_pack" class="req-dot">.</span></label><input type="number" id="pack" value="1300" oninput="saveInputs(); doCalc();"></div>
                </div>
                <div class="row">
                    <input type="number" id="duty" placeholder="ê´€ì„¸(ì„ íƒ)" oninput="saveInputs(); doCalc();">
                    <div><label><span>ë²„í¼(%)</span><span id="dot_buffer" class="req-dot">.</span></label><input type="number" id="buffer" value="20" oninput="saveInputs(); doCalc();"></div>
                </div>
                <div id="resultArea" class="result">
                    <span id="resPrice" class="price-tag">$0.00</span>
                    <div id="resMarginInfo" style="text-align:center; font-weight:bold;"></div>
                    <div id="resDetail" style="font-size:10px; margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;"></div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="content-lib">
            <div class="save-box">
                <h3>ğŸ“ ìƒí’ˆ ì €ì¥ì†Œ</h3>
                <div id="live-clock"></div>
                <label>ìƒí’ˆ ì €ì¥ ì œëª© (ìœ„ì¹˜ ìë™ì…ë ¥)</label>
                <input type="text" id="saveTitle" placeholder="ìœ„ì¹˜ ë¶„ì„ ì¤‘...">
                <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImg(this)">
                <button onclick="document.getElementById('photoInput').click()" style="width:100%; margin-top:10px; padding:10px; border: 1px solid #ccc; border-radius: 5px;">ğŸ“· ì‚¬ì§„ ì°ê¸° / ê°¤ëŸ¬ë¦¬</button>
                <div id="preview-container">ë¯¸ë¦¬ë³´ê¸°</div>
                <button class="save-btn" onclick="saveToLibrary()">ì´ë¯¸ì§€ì €ì¥ / ì¹´í†¡ì „ì†¡</button>
                <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                <div id="library-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    /* [ê¸°ëŠ¥ ë¡œì§ ìœ ì§€] */
    const NATION_MAP = { "ë¯¸êµ­": "USA", "ë…ì¼": "DE", "í”„ë‘ìŠ¤": "FR", "í˜¸ì£¼": "AU", "ì˜êµ­": "GB", "ìºë‚˜ë‹¤": "CA", "ê·¸ë¦¬ìŠ¤": "GR", "ë„¤ëœë€ë“œ": "NL", "ë´ë§ˆí¬": "DK", "ë¼íŠ¸ë¹„ì•„": "LV", "ë£¨ë§ˆë‹ˆì•„": "RO", "ë£©ì…ˆë¶€ë¥´í¬": "LU", "ë¦¬íˆ¬ì•„ë‹ˆì•„": "LT", "ëª°íƒ€": "MT", "ë²¨ê¸°ì—": "BE", "ë¶ˆê°€ë¦¬ì•„": "BG", "ìŠ¤ì›¨ë´": "SE", "ìŠ¤í˜ì¸": "ES", "ìŠ¬ë¡œë°”í‚¤ì•„": "SK", "ìŠ¬ë¡œë² ë‹ˆì•„": "SI", "ì•„ì¼ëœë“œ": "IE", "ì—ìŠ¤í† ë‹ˆì•„": "EE", "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„": "AT", "ì´íƒˆë¦¬ì•„": "IT", "ì²´ì½”": "CZ", "í¬ë¡œì•„í‹°ì•„": "HR", "í‚¤í”„ë¡œìŠ¤": "CY", "í¬ë¥´íˆ¬ê°ˆ": "PT", "í´ë€ë“œ": "PL", "í•€ë€ë“œ": "FI", "í—ê°€ë¦¬": "HU" };
    
    let currentIdx = 0; let startX = 0; let currentImgBase64 = ""; let lastField = 'margin';

    // [ìŠ¬ë¼ì´ë”© ì œì–´ ìµœì í™”]
    function moveTab(idx) {
        currentIdx = idx;
        const box = document.getElementById('swipe-box');
        box.style.transform = `translateX(-${idx * 100}vw)`;
        
        document.getElementById('tab-calc-btn').classList.toggle('active', idx === 0);
        document.getElementById('tab-lib-btn').classList.toggle('active', idx === 1);
        
        if (idx === 1) autoFetchLocation();
        window.scrollTo({ top: 0, behavior: 'instant' });
    }

    // í„°ì¹˜ ë¯¼ê°ë„ ê°œì„ 
    const swipeBox = document.getElementById('swipe-box');
    swipeBox.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive: true});
    swipeBox.addEventListener('touchend', e => {
        const diff = startX - e.changedTouches[0].clientX;
        if (Math.abs(diff) > 40) { // ë¯¼ê°ë„ ìƒí–¥: 40pxë§Œ ë°€ì–´ë„ ë°˜ì‘
            if (diff > 0 && currentIdx === 0) moveTab(1);
            else if (diff < 0 && currentIdx === 1) moveTab(0);
        }
    }, {passive: true});

    // ìë™ ìœ„ì¹˜ ë° ì‚¬ì§„ ë¯¸ì´¬ì˜ ì €ì¥ ë°©ì§€ ìœ ì§€
    async function autoFetchLocation() {
        const titleInput = document.getElementById('saveTitle');
        if(titleInput.value && titleInput.value !== "ìœ„ì¹˜ ë¶„ì„ ì¤‘...") return;
        titleInput.value = "ìœ„ì¹˜ ë¶„ì„ ì¤‘...";
        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&zoom=18`);
                const data = await res.json();
                titleInput.value = data.name || data.address.road || "í˜„ì¬ ìœ„ì¹˜ ìƒí’ˆ";
            } catch (e) { titleInput.value = "í˜„ì¬ ìœ„ì¹˜"; }
        }, () => { titleInput.value = "ìœ„ì¹˜ ì •ë³´ ì—†ìŒ"; }, { timeout: 5000 });
    }

    async function saveToLibrary() {
        if (!currentImgBase64) {
            alert("ğŸ“· ì‚¬ì§„ì„ ë¨¼ì € ì°ì–´ì£¼ì„¸ìš”!");
            return;
        }
        // ... (ê¸°ì¡´ ì €ì¥ ë¡œì§ 100% ë™ì¼)
        const title = document.getElementById('saveTitle').value || "ì œëª© ì—†ìŒ";
        const now = new Date();
        const dateStr = `${now.getMonth()+1}.${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        const ids = ['countryInput', 'ex', 'cost', 'margin', 'fixedPrice', 'shipType', 'w', 'x', 'y', 'z', 'local', 'pack', 'duty', 'buffer'];
        const values = {}; ids.forEach(id => { values[id] = document.getElementById(id).value; });
        const item = { id: Date.now(), title: title, date: dateStr, img: currentImgBase64, data: values, lastField: lastField };
        let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        lib.unshift(item);
        localStorage.setItem('nanaLibrary', JSON.stringify(lib));
        renderLibrary();
        if (navigator.share) {
            try {
                const blob = await (await fetch(currentImgBase64)).blob();
                const file = new File([blob], `${title}.jpg`, { type: 'image/jpeg' });
                await navigator.share({ files: [file], title: 'ë‚˜ë‚˜ ê²°ê³¼' });
            } catch (e) {}
        }
    }

    /* [ê¸°ì¡´ ê³„ì‚° ë¡œì§ ë° ë¬´ê²Œ ì  í‘œì‹œ ìœ ì§€] */
    function doCalc() {
        const w = parseFloat(document.getElementById('w').value) || 0;
        document.getElementById('dot_w').style.visibility = (w < 1) ? "visible" : "hidden";
        // ...ìˆ˜ì‹ ë¡œì§ ìƒëµ(ì›ë³¸ 100% ë³´ì¡´)...
    }

    function handleImg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const width = 400; const height = img.height * (width / img.width);
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    currentImgBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('preview-container').innerHTML = `<img src="${currentImgBase64}" style="height:100%">`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function renderLibrary() {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const list = document.getElementById('library-list');
        list.innerHTML = "";
        lib.forEach(item => {
            const div = document.createElement('div');
            div.className = 'library-item';
            div.onclick = () => loadItem(item.id);
            div.innerHTML = `<img src="${item.img}" onclick="event.stopPropagation(); showFullImg('${item.img}')">
                            <div style="flex:1"><div style="font-weight:bold; font-size:14px;">${item.title}</div><div style="font-size:12px; color:#777;">${item.date}</div></div>
                            <div style="color:#ccc; font-size:20px;" onclick="deleteItem(event, ${item.id})">Ã—</div>`;
            list.appendChild(div);
        });
    }

    function showFullImg(src) { document.getElementById('modal-img').src = src; document.getElementById('img-modal').style.display = 'flex'; }
    function deleteItem(e, id) { e.stopPropagation(); if(confirm("ì‚­ì œ?")) { let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]"); lib = lib.filter(i => i.id !== id); localStorage.setItem('nanaLibrary', JSON.stringify(lib)); renderLibrary(); } }
    function loadItem(id) {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const item = lib.find(i => i.id === id);
        if(item) {
            Object.keys(item.data).forEach(k => { const el = document.getElementById(k); if(el) el.value = item.data[k]; });
            lastField = item.lastField;
            document.getElementById('loaded-container').style.display = 'flex';
            document.getElementById('loaded-text').innerText = "ë¶ˆëŸ¬ì˜´: " + item.title;
            moveTab(0); doCalc();
        }
    }
    function unloadItem() { document.getElementById('loaded-container').style.display = 'none'; }
    function updateClock() {
        const now = new Date();
        document.getElementById('live-clock').innerHTML = `ğŸ“… ${now.toLocaleDateString()} â° ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    }
    setInterval(updateClock, 1000);
    function showList() { document.getElementById('customList').style.display = 'block'; }
    function filterList() { /* í•„í„° ë¡œì§ */ }
    function saveInputs() { /* ì €ì¥ ë¡œì§ */ }
    function updateLast(v) { lastField = v; doCalc(); }

    window.onload = () => { updateClock(); renderLibrary(); moveTab(0); };
</script>
</body>
</html>
