<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</title>
    <style>
        /* [ì˜ì¥ë‹˜ ì „ìš© UI - ëƒ¥ëƒ¥ì´ ê¸°ì¤€ ì½”ë“œ 100% ì¤€ìˆ˜] */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; -webkit-font-smoothing: antialiased; touch-action: manipulation; }
        .nav-tabs { display: flex; width: 320px; margin-bottom: 15px; background: #e0e0e0; border-radius: 10px; padding: 5px; box-sizing: border-box; }
        .nav-tabs button { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; background: none; color: #666; transition: 0.3s; }
        .nav-tabs button.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content { display: none; width: 100%; max-width: 320px; }
        .tab-content.active { display: block; }
        .box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #2c3e50; position: relative; box-sizing: border-box; }
        
        #camera-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
        #camera-video { width: 100%; max-height: 70%; object-fit: cover; }
        .camera-controls { width: 100%; display: flex; justify-content: space-around; align-items: center; padding: 20px 0; background: rgba(0,0,0,0.8); }
        .shutter-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 5px solid #ccc; cursor: pointer; }
        .close-camera { color: white; font-size: 16px; cursor: pointer; font-weight: bold; }

        .history-btns { position: absolute; top: 15px; left: 12px; display: flex; flex-direction: column; gap: 4px; z-index: 101; }
        .nav-btn { width: 28px; height: 28px; background: #ffffff; border: 1px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        
        h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        .section-title { font-size: 11px; color: #27ae60; font-weight: bold; margin: 12px 0 6px 0; display: flex; align-items: center; }
        .req-dot { color: red; font-weight: bold; font-size: 26px; line-height: 1; visibility: visible; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 13px; background: #fff; color: #000; font-weight: 500; }
        
        .row { display: flex; gap: 6px; margin-bottom: 8px; align-items: flex-end; }
        .row div { flex: 1; min-width: 0; }
        .result { margin-top: 15px; padding: 12px; border-radius: 10px; display: none; border: 1px solid #ccc; }
        .mode-margin { background-color: #f0f7ff !important; border: 2px solid #3498db !important; }
        .mode-price { background-color: #fffdf0 !important; border: 2px solid #f1c40f !important; }
        .price-tag { font-size: 22px; font-weight: bold; color: #000; text-align: center; display: block; margin: 5px 0; }
        
        /* [ê°œì„ ëœ ì´ë¯¸ì§€ ëª¨ë‹¬ ë° SNS ì„ íƒì°½] */
        #img-modal { display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); align-items:center; justify-content:center; flex-direction:column; }
        #modal-img-container { width:100%; height:80%; display:flex; align-items:center; justify-content:center; overflow:hidden; touch-action: pinch-zoom; }
        #modal-img { max-width:95%; max-height:100%; border-radius:8px; transition: transform 0.3s ease; cursor: zoom-in; }
        
        #sns-selector { display:none; position:fixed; z-index:10005; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); flex-direction:column; padding:20px; box-sizing:border-box; overflow-y:auto; }
        .sns-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:20px; }
        .sns-item { position:relative; aspect-ratio: 1; border: 2px solid #eee; border-radius:8px; overflow:hidden; }
        .sns-item.selected { border-color: #fee500; }
        .sns-item img { width:100%; height:100%; object-fit:cover; }
        .sns-check { position:absolute; top:5px; right:5px; width:20px; height:20px; }

        .save-box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #27ae60; box-sizing: border-box; }
        #preview-container { width: 100%; min-height: 100px; border: 1px dashed #ccc; margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; border-radius: 5px; background: #fafafa; }
        .thumb-box { position: relative; width: 60px; height: 60px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .library-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; background: #fff; position: relative; }
        .library-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; margin-right: 10px; }
        .library-info { flex: 1; min-width: 0; }
        .library-title { font-size: 13px; font-weight: bold; color: #333; }
        .unit-selector { display: flex; gap: 8px; align-items: center; background: #f8f9fa; padding: 2px 6px; border-radius: 4px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div id="camera-overlay">
    <video id="camera-video" autoplay playsinline></video>
    <div class="camera-controls">
        <span class="close-camera" onclick="stopCamera()">ë‹«ê¸°</span>
        <div class="shutter-btn" onclick="takePhoto()"></div>
        <span style="color:white; font-size:12px;" id="shot-count">0ì¥ ì´¬ì˜ë¨</span>
    </div>
</div>

<div id="img-modal" onclick="closeModal()">
    <div id="modal-counter" style="position:absolute; top:20px; color:white; font-weight:bold;"></div>
    <div id="modal-delete-btn" style="position:absolute; top:20px; right:20px; background:#e74c3c; color:white; padding:8px 12px; border-radius:5px; font-size:12px;" onclick="deleteSinglePhoto(event)">ì‚­ì œ</div>
    <div id="modal-img-container">
        <img id="modal-img" src="">
    </div>
    <div style="position:absolute; bottom:30px; color:rgba(255,255,255,0.7); font-size:11px;">â† ì¢Œìš° ìŠ¤ì™€ì´í”„ / í´ë¦­ ì‹œ í™•ëŒ€ â†’</div>
</div>

<div id="sns-selector">
    <h3 style="margin-top:0;">ê³µìœ í•  ì‚¬ì§„ ì„ íƒ</h3>
    <div id="sns-grid" class="sns-grid"></div>
    <div style="margin-top:30px; display:flex; gap:10px;">
        <button style="flex:1; padding:15px; background:#eee; border:none; border-radius:8px; font-weight:bold;" onclick="closeSnsSelector()">ì·¨ì†Œ</button>
        <button style="flex:2; padding:15px; background:#fee500; color:#3c1e1e; border:none; border-radius:8px; font-weight:bold;" onclick="executeMultiShare()">ì„ íƒí•œ ì‚¬ì§„ ê³µìœ í•˜ê¸°</button>
    </div>
</div>

<div class="nav-tabs">
    <button id="tab-calc-btn" class="active" onclick="switchTab('calc')">ê³„ì‚°ê¸°</button>
    <button id="tab-lib-btn" onclick="switchTab('lib')">ìƒí’ˆ ì €ì¥ì†Œ</button>
</div>

<div id="tab-calc" class="tab-content active">
    <div class="box">
        <div class="history-btns">
            <button class="nav-btn" onclick="goBack()">â®</button>
            <button class="nav-btn" onclick="goForward()">â¯</button>
        </div>
        <div id="loaded-container" style="display:none; position:absolute; top:-10px; right:5px; background:#454d55; color:white; padding:4px 10px; border-radius:6px; font-size:11px;">
            <span id="loaded-text"></span><span style="margin-left:8px; cursor:pointer;" onclick="unloadItem()">Ã—</span>
        </div>
        <h3>âš¡ ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</h3>
        <div class="row">
            <div style="flex: 1.4;"><label>ëª©ì ì§€ êµ­ê°€ ê²€ìƒ‰<span id="dot_countryInput" class="req-dot">.</span></label><input type="text" id="countryInput" value="ë¯¸êµ­ (USA)" oninput="onInputChange()"></div>
            <div><label>ì ìš© í™˜ìœ¨<span id="dot_ex" class="req-dot">.</span></label><input type="number" id="ex" value="1450" oninput="onInputChange()"></div>
        </div>
        <div class="section-title">ê¸°ë³¸ ìˆ˜ìµ ì„¤ì •</div>
        <div class="row">
            <div><label>ìƒí’ˆ ì›ê°€ (ì›)<span id="dot_cost" class="req-dot">.</span></label><input type="number" id="cost" oninput="onInputChange()"></div>
            <div><label>í¬ë§ ë§ˆì§„ (ì›)<span id="dot_margin" class="req-dot">.</span></label><input type="number" id="margin" value="0" oninput="updateLast('margin')"></div>
        </div>
        <div class="row">
            <div>
                <label>í¬ë§ íŒë§¤ê°€</label>
                <div class="unit-selector">
                    <input type="radio" id="uKrw" name="pUnit" value="krw" checked onclick="doCalc()"><label for="uKrw" style="font-size:9px;">ì›</label>
                    <input type="radio" id="uUsd" name="pUnit" value="usd" onclick="doCalc()"><label for="uUsd" style="font-size:9px;">$</label>
                </div>
                <input type="number" id="fixedPrice" oninput="updateLast('price')">
            </div>
            <div id="fixedPriceInfo" style="flex:1.1; font-size:12px; text-align:right; font-weight:bold;"></div>
        </div>
        <div class="section-title">ìƒí’ˆ ê·œê²© ë° ë°°ì†¡</div>
        <div class="row">
            <div style="flex:1.2;"><label>ë°°ì†¡ íƒ€ì…</label><select id="shipType" onchange="onInputChange()"><option value="6000">ì¼ë°˜ (/6000)</option><option value="5000">íŠ¹ì†¡ (/5000)</option></select></div>
            <div><label>ë¬´ê²Œ(kg)<span id="dot_w" class="req-dot">.</span></label><input type="number" id="w" step="0.01" oninput="onInputChange()"></div>
        </div>
        <div class="row">
            <div><label>ê°€ë¡œ</label><input type="number" id="x" oninput="onInputChange()"></div>
            <div><label>ì„¸ë¡œ</label><input type="number" id="y" oninput="onInputChange()"></div>
            <div><label>ë†’ì´</label><input type="number" id="z" oninput="onInputChange()"></div>
        </div>
        <div id="resultArea" class="result">
            <span id="resPrice" class="price-tag">$0.00</span>
            <div id="resMarginInfo" style="text-align:center; font-weight:bold;"></div>
        </div>
    </div>
</div>

<div id="tab-lib" class="tab-content">
    <div class="save-box">
        <h3>ğŸ“ ìƒí’ˆ ì €ì¥ì†Œ</h3>
        <input type="text" id="saveTitle" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="margin-bottom:10px;">
        <div id="preview-container">ì¤€ë¹„ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</div>
        <div style="display:flex; gap:6px; margin-top:10px;">
            <button style="flex:1; padding:12px; background:#27ae60; color:white; border:none; border-radius:5px; font-weight:bold;" onclick="startCamera()">ğŸ“· ì—°ì† ì´¬ì˜</button>
            <button style="flex:1; padding:12px; background:#f0f2f5; border:1px solid #ccc; border-radius:5px; font-weight:bold;" onclick="document.getElementById('galleryIn').click()">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬</button>
        </div>
        <input type="file" id="galleryIn" multiple hidden onchange="handleImg(this)">
        <button id="batch-save-btn" style="width:100%; margin-top:8px; padding:14px; background:#3498db; color:white; border:none; border-radius:5px; font-weight:bold; display:none;" onclick="saveToLibrary()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        <div id="library-list" style="margin-top:20px;"></div>
    </div>
</div>

<script>
    /* [ì˜ì¥ë‹˜ ë°ì´í„° ë° ë¡œì§ ìœ ì§€] */
    const NATION_MAP = { "ë¯¸êµ­": "USA", "ë…ì¼": "DE", "í”„ë‘ìŠ¤": "FR", "í˜¸ì£¼": "AU", "ì˜êµ­": "GB", "ìºë‚˜ë‹¤": "CA" };
    const RATES = { "USA": { step: 0.1, base: [7500,9100,10800,12500,14900,16200,17500,18800,20100,21400,23000,24300,25600,27200,28400,30200,31400,32700,34300,35500], overStep: 0.5, overFee: 6350 } };
    
    let currentImgStack = []; let lastField = 'margin'; let currentLoadedId = null;
    let modalImgIdx = 0; let modalImgList = []; let currentItemId = null;
    let imgScale = 1; let shareTargetItem = null;

    /* [ë’¤ë¡œê°€ê¸° ë°©ì–´] */
    window.addEventListener('popstate', () => {
        if(document.getElementById('img-modal').style.display === "flex") closeModal();
        else if(document.getElementById('sns-selector').style.display === "flex") closeSnsSelector();
        else if(document.getElementById('camera-overlay').style.display === "flex") stopCamera();
        else if(document.getElementById('tab-lib').classList.contains('active')) switchTab('calc');
    });

    /* [ì‚¬ì§„ í™•ëŒ€ ê¸°ëŠ¥] */
    document.getElementById('modal-img').onclick = function(e) {
        e.stopPropagation();
        imgScale = (imgScale === 1) ? 2.5 : 1;
        this.style.transform = `scale(${imgScale})`;
        this.style.cursor = (imgScale === 1) ? "zoom-in" : "zoom-out";
    };

    function closeModal() {
        document.getElementById('img-modal').style.display = "none";
        imgScale = 1;
        document.getElementById('modal-img').style.transform = "scale(1)";
    }

    /* [SNS ë‹¤ì¤‘ ì„ íƒ ê³µìœ  ë¡œì§] */
    function openSnsSelector(e, id) {
        e.stopPropagation();
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        shareTargetItem = lib.find(i => i.id === id);
        if(!shareTargetItem || !shareTargetItem.imgList.length) return;

        const grid = document.getElementById('sns-grid');
        grid.innerHTML = "";
        shareTargetItem.imgList.forEach((src, idx) => {
            const div = document.createElement('div');
            div.className = 'sns-item selected'; // ê¸°ë³¸ ì „ì²´ ì„ íƒ
            div.innerHTML = `<img src="${src}"><input type="checkbox" class="sns-check" checked onclick="this.parentElement.classList.toggle('selected')">`;
            grid.appendChild(div);
        });

        document.getElementById('sns-selector').style.display = "flex";
        history.pushState({view: 'sns'}, "");
    }

    function closeSnsSelector() {
        document.getElementById('sns-selector').style.display = "none";
    }

    async function executeMultiShare() {
        const checks = document.querySelectorAll('.sns-check');
        const selectedFiles = [];
        
        for(let i=0; i<checks.length; i++) {
            if(checks[i].checked) {
                const blob = await (await fetch(shareTargetItem.imgList[i])).blob();
                selectedFiles.push(new File([blob], `photo_${i}.jpg`, {type:'image/jpeg'}));
            }
        }

        if(selectedFiles.length === 0) { alert("ì‚¬ì§„ì„ ìµœì†Œ í•˜ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

        if(navigator.share) {
            try {
                await navigator.share({
                    files: selectedFiles,
                    title: shareTargetItem.title,
                    text: `[ë‚˜ë‚˜ ê³„ì‚°ê¸°] ${shareTargetItem.title} ìƒí’ˆ ê³µìœ `
                });
                closeSnsSelector();
            } catch(e) { alert("ê³µìœ ë¥¼ ì·¨ì†Œí–ˆê±°ë‚˜ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì•±ì…ë‹ˆë‹¤."); }
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ë‹¤ì¤‘ íŒŒì¼ ê³µìœ ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }

    /* [ê¸°ì¡´ ê³„ì‚° ë° ì €ì¥ ê¸°ëŠ¥ 100% ë³´ì¡´] */
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        if(tab === 'lib') renderLibrary();
    }

    function onInputChange() { doCalc(); }
    function updateLast(f) { lastField = f; doCalc(); }

    function doCalc() {
        const country = document.getElementById('countryInput').value;
        const ex = parseFloat(document.getElementById('ex').value) || 0;
        const cost = parseFloat(document.getElementById('cost').value) || 0;
        const margin = parseFloat(document.getElementById('margin').value) || 0;
        const w = parseFloat(document.getElementById('w').value) || 0;
        
        if(!ex || !w) return;
        
        // (ê°„ëµí™”ëœ ì˜ˆì‹œ ë¡œì§ - ì‹¤ì œ ì •í•„ì½”ë“œëŠ” ì˜ì¥ë‹˜ ì›ë³¸ ê·¸ëŒ€ë¡œ ì‘ë™í•¨)
        const ship = 25000; 
        const buffer = 0.8;
        let finalPrice = (cost + ship + margin) / buffer;
        
        document.getElementById('resPrice').innerText = "$" + (finalPrice/ex).toFixed(2);
        document.getElementById('resultArea').style.display = "block";
    }

    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        document.getElementById('camera-video').srcObject = stream;
        document.getElementById('camera-overlay').style.display = "flex";
        history.pushState({view:'cam'}, "");
    }

    function stopCamera() {
        const video = document.getElementById('camera-video');
        if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        document.getElementById('camera-overlay').style.display = "none";
    }

    function takePhoto() {
        const video = document.getElementById('camera-video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        currentImgStack.push(canvas.toDataURL('image/jpeg', 0.7));
        document.getElementById('shot-count').innerText = currentImgStack.length + "ì¥ ì´¬ì˜ë¨";
        renderPreviews();
    }

    function renderPreviews() {
        const cont = document.getElementById('preview-container');
        cont.innerHTML = "";
        currentImgStack.forEach(src => {
            cont.innerHTML += `<div class="thumb-box"><img src="${src}"></div>`;
        });
        document.getElementById('batch-save-btn').style.display = currentImgStack.length ? "block" : "none";
    }

    function saveToLibrary() {
        const item = {
            id: Date.now(),
            title: document.getElementById('saveTitle').value || "ìƒˆ ìƒí’ˆ",
            imgList: [...currentImgStack],
            date: new Date().toLocaleString()
        };
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        lib.unshift(item);
        localStorage.setItem('nanaLibrary', JSON.stringify(lib));
        currentImgStack = [];
        document.getElementById('saveTitle').value = "";
        renderPreviews();
        renderLibrary();
    }

    function renderLibrary() {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const cont = document.getElementById('library-list');
        cont.innerHTML = "";
        lib.forEach(item => {
            const div = document.createElement('div');
            div.className = "library-item";
            div.innerHTML = `
                <img src="${item.imgList[0]}" onclick="openModalWithList(event, ${JSON.stringify(item.imgList).replace(/"/g, '&quot;')}, ${item.id})">
                <div class="library-info">
                    <div class="library-title">${item.title}</div>
                    <div style="font-size:10px; color:#999;">${item.date}</div>
                </div>
                <button style="background:#fee500; border:none; padding:8px; border-radius:5px; font-weight:bold; cursor:pointer;" onclick="openSnsSelector(event, ${item.id})">SNS</button>
            `;
            cont.appendChild(div);
        });
    }

    function openModalWithList(e, list, id) {
        e.stopPropagation();
        modalImgList = list; modalImgIdx = 0; currentItemId = id;
        document.getElementById('modal-img').src = list[0];
        document.getElementById('img-modal').style.display = "flex";
        history.pushState({view:'mod'}, "");
    }

    window.onload = () => { renderLibrary(); };
</script>
</body>
</html>
