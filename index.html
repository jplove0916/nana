<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ÎÇòÎÇò ÌÜµÌï© Í≥ÑÏÇ∞Í∏∞</title>
    <style>
        /* [ÏùòÏû•Îãò ÏßÄÏãú: Í∏∞Ï°¥ UI Î∞è Ï†ïÍµêÌïú Î°úÏßÅ 100% Ïú†ÏßÄ] */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; -webkit-font-smoothing: antialiased; touch-action: manipulation; overflow-x: hidden; }
        .nav-tabs { display: flex; width: 320px; margin-bottom: 15px; background: #e0e0e0; border-radius: 10px; padding: 5px; box-sizing: border-box; }
        .nav-tabs button { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; background: none; color: #666; transition: 0.3s; }
        .nav-tabs button.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content { display: none; width: 100%; max-width: 320px; }
        .tab-content.active { display: block; }
        .box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #2c3e50; position: relative; box-sizing: border-box; }
        
        #camera-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
        #camera-video { width: 100%; max-height: 70%; object-fit: cover; }
        .camera-controls { width: 100%; display: flex; justify-content: space-around; align-items: center; padding: 20px 0; background: rgba(0,0,0,0.8); }
        .shutter-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 5px solid #ccc; cursor: pointer; }
        .close-camera { color: white; font-size: 16px; cursor: pointer; font-weight: bold; }

        .history-btns { position: absolute; top: 15px; left: 12px; display: flex; flex-direction: column; gap: 4px; z-index: 101; }
        .nav-btn { width: 28px; height: 28px; background: #ffffff; border: 1px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        .nav-btn:hover { background: #f0f2f5; border-color: #bbb; }
        .nav-btn:active { transform: scale(0.92); background: #e0e0e0; }
        .nav-btn:disabled { color: #ccc; cursor: default; background: #f9f9f9; }

        h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        .section-title { font-size: 11px; color: #27ae60; font-weight: bold; margin: 12px 0 6px 0; display: flex; align-items: center; }
        .section-title::before { content: "‚óè"; margin-right: 5px; font-size: 7px; }
        label { font-size: 10px; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; width: 100%; }
        
        .size-guide { font-size: 10px; color: #3498db; font-weight: bold; margin-left: 2px; }
        .req-dot { color: red; font-weight: bold; font-size: 26px; line-height: 1; visibility: visible; }
        
        input, select { 
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 13px; background: #fff; transition: all 0.2s ease; color: #000; -webkit-font-smoothing: antialiased; font-weight: 500;
            touch-action: pan-x pan-y !important; /* Í∞ÄÎ°ú/ÏÑ∏Î°ú ÎìúÎûòÍ∑∏ ÌóàÏö© */
        }
        
        input[type="text"], input[type="number"] { -webkit-appearance: none; }
        select { font-weight: 700; color: #000; -webkit-appearance: none; }
        .search-input { border: 2px solid #2c3e50; background: #f9f9f9; font-weight: bold; }
        .dropdown-container { position: relative; }
        .custom-list { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #2c3e50; border-top: none; border-radius: 0 0 5px 5px; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .custom-list div { padding: 10px; font-size: 13px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; }
        .custom-list div.highlight-country { background-color: #eafaf1; font-weight: bold; }
        
        .row { display: flex; gap: 6px; margin-bottom: 8px; align-items: flex-end; }
        .row div { flex: 1; min-width: 0; }
        .result { margin-top: 15px; padding: 12px; border-radius: 10px; display: none; transition: all 0.3s; border: 1px solid #ccc; }
        .mode-margin { background-color: #f0f7ff !important; border: 2px solid #3498db !important; }
        .mode-price { background-color: #fffdf0 !important; border: 2px solid #f1c40f !important; }
        .price-tag { font-size: 22px; font-weight: bold; color: #000; text-align: center; display: block; margin: 5px 0; word-break: break-all; }
        .footer-note { margin-top: 15px; font-size: 10px; color: #777; line-height: 1.5; border-top: 1px solid #eee; padding-top: 12px; }
        #fixedPriceInfo, #bepInfo { display: flex; flex-direction: column; align-items: flex-end; font-weight: bold; text-align: right; line-height: 1.3; }
        #fixedPriceInfo { font-size: 13px; margin-bottom: 5px; }
        #bepInfo { font-size: 13px; color: #e65100; }
        .price-sub { font-size: 13px; white-space: nowrap; }
        #resMarginInfo { text-align: center; font-size: 15px; font-weight: bold; margin-bottom: 8px; }
        #loaded-container { position: absolute; top: -10px; right: 5px; display: none; align-items: flex-start; background: #454d55; color: #f8f9fa; padding: 4px 10px; border-radius: 6px; z-index: 100; max-width: 170px; border: 1px solid #343a40; }
        #loaded-text { font-size: 11px; font-weight: 500; margin-right: 8px; word-break: break-all; white-space: normal; line-height: 1.1; }
        #close-loaded { cursor: pointer; font-size: 16px; font-weight: bold; line-height: 1; flex-shrink: 0; color: #adb5bd; margin-top: -2px; }
        
        #liveDetail { margin-top: 10px; padding: 10px; background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; font-size: 13px; color: #444; line-height: 1.6; display: none; }

        .save-box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #27ae60; box-sizing: border-box; }
        #live-clock { font-size: 13px; color: #1e8449; font-weight: 800; display: block; margin: -5px 0 15px 0; text-align: center; background: #eafaf1; padding: 4px; border-radius: 5px; border: 1px solid #27ae60; }
        
        #preview-container { width: 100%; min-height: 100px; border: 1px dashed #ccc; margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; border-radius: 5px; background: #fafafa; box-sizing: border-box; align-items: flex-start; }
        .thumb-box { position: relative; width: 60px; height: 60px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; background: #eee; }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-del { position: absolute; top: -2px; right: -2px; background: rgba(0,0,0,0.6); color: white; width: 18px; height: 18px; font-size: 12px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }

        .library-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; cursor: pointer; background: #fff; box-sizing: border-box; position: relative; min-height: 72px; transition: background 0.2s; }
        .library-item.editing { border-color: #3498db; background: #f0f7ff !important; }
        .library-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; margin-right: 10px; flex-shrink: 0; }
        .library-info { flex: 1; min-width: 0; display: flex; flex-direction: column; }
        .library-title-row { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
        .library-title { font-size: 13px; font-weight: bold; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .edit-icon { font-size: 14px; color: #999; cursor: pointer; padding: 5px; }
        .library-date { font-size: 10px; color: #999; }
        
        .lib-checkbox { width: 22px; height: 22px; margin-right: 10px; display: none; cursor: pointer; z-index: 5; }
        .lib-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .lib-edit-btn { font-size: 11px; padding: 6px 12px; background: #f0f2f5; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .batch-del-top-btn { font-size: 11px; padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: none; margin-right: 5px; }

        #img-modal { display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); align-items:center; justify-content:center; flex-direction:column; }
        #modal-img-container { width:100%; height:80%; display:flex; align-items:center; justify-content:center; overflow:hidden; position: relative; touch-action: none; }
        #modal-img { max-width:95%; max-height:100%; border-radius:8px; transition: transform 0.2s ease-out; cursor: zoom-in; touch-action: none; }
        #modal-top-bar { position:absolute; top:20px; left:0; width:100%; display:flex; justify-content:center; align-items:center; padding:0 20px; box-sizing:border-box; z-index:10002; }
        #modal-counter { color:white; font-size:14px; font-weight:bold; }
        .modal-bottom-btns { position: absolute; right: 20px; bottom: 40px; display: flex; flex-direction: column; gap: 12px; z-index: 10005; }
        #photo-edit-btn { background:rgba(255,255,255,0.25); color:white; border:1px solid rgba(255,255,255,0.5); padding:10px 18px; border-radius:25px; font-size:13px; cursor:pointer; backdrop-filter: blur(5px); pointer-events: auto; }
        #direct-del-btn { background:rgba(231,76,60,0.85); color:white; border:none; padding:10px 18px; border-radius:25px; font-size:13px; cursor:pointer; font-weight:bold; pointer-events: auto; }
        #photo-edit-view { display:none; width:90%; height:85%; overflow-y:auto; background:white; border-radius:12px; padding:20px; box-sizing:border-box; z-index:10003; }
        .edit-thumb-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; padding-bottom: 80px; }
        .edit-thumb-box { position:relative; aspect-ratio:1/1; border-radius:8px; overflow:hidden; border:2px solid #eee; }
        .edit-thumb-box img { width:100%; height:100%; object-fit:cover; }
        .photo-cb { position:absolute; top:5px; right:5px; width:22px; height:22px; z-index:2; }
        
        #edit-actions { display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); width:90%; justify-content:center; gap:10px; z-index:10004; background:white; padding:15px; border-radius:20px; box-shadow:0 -5px 20px rgba(0,0,0,0.1); box-sizing:border-box; }
        .action-btn { flex:1; padding:12px 0; border-radius:30px; border:none; font-weight:bold; cursor:pointer; font-size:14px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
        
        .unit-selector { display: flex; gap: 8px; align-items: center; background: #f8f9fa; padding: 2px 6px; border-radius: 4px; border: 1px solid #eee; margin-left: 10px; }
        .unit-selector input[type="radio"] { width: 13px; height: 13px; margin: 0; cursor: pointer; border: 1px solid #ccc; -webkit-appearance: radio !important; appearance: radio !important; }
        .unit-label { font-size: 9px; font-weight: bold; color: #555; cursor: pointer; margin-left: -4px; }
    </style>
</head>
<body>

<div id="camera-overlay">
    <video id="camera-video" autoplay playsinline></video>
    <div class="camera-controls">
        <span class="close-camera" onclick="stopCamera()">Îã´Í∏∞</span>
        <div class="shutter-btn" onclick="takePhoto()"></div>
        <span style="color:white; font-size:12px;" id="shot-count">0Ïû• Ï¥¨ÏòÅÎê®</span>
    </div>
</div>

<div id="img-modal" onclick="closeModal()">
    <div id="modal-top-bar"><span id="modal-counter"></span></div>
    <div id="modal-img-container"><img id="modal-img" src="" onclick="toggleZoom(event)"></div>
    <div class="modal-bottom-btns" id="modal-controls" onclick="event.stopPropagation()">
        <button id="direct-del-btn" onclick="deleteCurrentPhoto(event)">ÏÇ≠Ï†ú</button>
        <button id="photo-edit-btn" onclick="togglePhotoEdit(event)">Ìé∏Ïßë/Í≥µÏú†</button>
    </div>
    <div id="photo-edit-view" onclick="event.stopPropagation()">
        <h4 style="margin:0 0 15px 0; text-align:center; color:#333;">ÏÇ¨ÏßÑ ÏÑ†ÌÉù</h4>
        <div id="edit-thumb-grid" class="edit-thumb-grid"></div>
        <div id="edit-actions" onclick="event.stopPropagation()">
            <button class="action-btn" style="background:#e74c3c; color:white;" onclick="deleteSelectedPhotos(event)">ÏÇ≠Ï†ú</button>
            <button class="action-btn" style="background:#fee500; color:#3c1e1e;" onclick="shareSelectedPhotos(event)">Í≥µÏú†</button>
            <button class="action-btn" style="background:#95a5a6; color:white;" onclick="togglePhotoEdit(event)">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<div class="nav-tabs">
    <button id="tab-calc-btn" class="active" onclick="switchTab('calc')">Í≥ÑÏÇ∞Í∏∞</button>
    <button id="tab-lib-btn" onclick="switchTab('lib')">ÏÉÅÌíà Ï†ÄÏû•ÏÜå</button>
</div>

<div id="tab-calc" class="tab-content active">
    <div class="box">
        <div class="history-btns">
            <button class="nav-btn" onclick="goBack()">‚ùÆ</button>
            <button class="nav-btn" onclick="goForward()">‚ùØ</button>
        </div>
        <div id="loaded-container"><span id="loaded-text">Î∂àÎü¨Ïò¥: ÏóÜÏùå</span><span id="close-loaded" onclick="unloadItem()">√ó</span></div>
        <h3>‚ö° ÎÇòÎÇò ÌÜµÌï© Í≥ÑÏÇ∞Í∏∞</h3>
        <div class="row">
            <div style="flex: 1.4;" class="dropdown-container">
                <label><span>Î™©Ï†ÅÏßÄ Íµ≠Í∞Ä Í≤ÄÏÉâ</span><span id="dot_countryInput" class="req-dot">.</span></label>
                <input type="text" id="countryInput" class="search-input" value="ÎØ∏Íµ≠ (USA)" onfocus="clearField(this)" oninput="filterList(); onInputChange();" autocomplete="off">
                <div id="customList" class="custom-list"></div>
            </div>
            <div><label><span>Ï†ÅÏö© ÌôòÏú®</span><span id="dot_ex" class="req-dot">.</span></label><input type="number" id="ex" value="1450" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div class="section-title">Í∏∞Î≥∏ ÏàòÏùµ ÏÑ§Ï†ï</div>
        <div class="row">
            <div><label><span>ÏÉÅÌíà ÏõêÍ∞Ä (Ïõê)</span><span id="dot_cost" class="req-dot">.</span></label><input type="number" id="cost" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label><span>Ìù¨Îßù ÎßàÏßÑ (Ïõê)</span><span id="dot_margin" class="req-dot">.</span></label><input type="number" id="margin" value="0" onfocus="clearField(this, 'margin')" oninput="updateLast('margin'); onInputChange();"></div>
        </div>
        <div class="row">
            <div>
                <label><span>Ìù¨Îßù ÌåêÎß§Í∞Ä</span><div class="unit-selector"><input type="radio" id="unitKrw" name="priceUnit" value="krw" checked onclick="convertUnitPrice('krw')"><label for="unitKrw" class="unit-label">Ïõê</label><input type="radio" id="unitUsd" name="priceUnit" value="usd" onclick="convertUnitPrice('usd')"><label for="unitUsd" class="unit-label">Îã¨Îü¨</label></div></label>
                <input type="number" id="fixedPrice" onfocus="clearField(this, 'price')" oninput="updatePriceInput(this.value); onInputChange();">
            </div>
            <div style="flex: 1.1; display: flex; flex-direction: column; justify-content: flex-end;"><div id="fixedPriceInfo"></div><div id="bepInfo"></div></div>
        </div>
        <div class="section-title">ÏÉÅÌíà Í∑úÍ≤© Î∞è Î∞∞ÏÜ°</div>
        <div class="row">
            <div style="flex: 1.2;"><label>Î∞∞ÏÜ° ÌÉÄÏûÖ</label><select id="shipType" onchange="onInputChange()"><option value="6000">ÏùºÎ∞ò (/6000)</option><option value="5000">ÌäπÏÜ° (/5000)</option></select></div>
            <div><label><span>Î¨¥Í≤å(kg) <span id="boxGuide" class="size-guide"></span></span><span id="dot_w" class="req-dot">.</span></label><input type="number" id="w" step="0.01" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div class="row">
            <div><label>Í∞ÄÎ°ú(cm)</label><input type="number" id="x" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label>ÏÑ∏Î°ú(cm)</label><input type="number" id="y" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label>ÎÜíÏù¥(cm)</label><input type="number" id="z" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div id="liveDetail"></div>
        <div class="section-title">Í∏∞ÌÉÄ Î∂ÄÏàò ÎπÑÏö©</div>
        <div class="row">
            <div><label><span>Íµ≠ÎÇ¥ Î∞∞ÏÜ°ÎπÑ</span><span id="dot_local" class="req-dot">.</span></label><input type="number" id="local" value="3000" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label><span>Ìè¨Ïû•ÎπÑ</span><span id="dot_pack" class="req-dot">.</span></label><input type="number" id="pack" value="1000" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div class="row">
            <div><label>Í¥ÄÏÑ∏</label><input type="number" id="duty" placeholder="0" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label><span>ÏàòÏàòÎ£å Î≤ÑÌçº(%)</span><span id="dot_buffer" class="req-dot">.</span></label><input type="number" id="buffer" value="20" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div id="resultArea" class="result">
            <label id="resTitle" style="color:#2c3e50; display:block; text-align:center; font-size:11px; font-weight:bold;">Ïù¥Î≤†Ïù¥ ÌåêÎß§Í∞Ä</label>
            <span id="resPrice" class="price-tag">$0.00</span>
            <div id="resMarginInfo"></div>
        </div>
    </div>
</div>

<div id="tab-lib" class="tab-content">
    <div class="save-box">
        <h3>üìÅ ÏÉÅÌíà Ï†ÄÏû•ÏÜå</h3>
        <div id="live-clock"></div>
        <label>ÏÉÅÌíà Ï†ÄÏû• Ï†úÎ™©</label>
        <input type="text" id="saveTitle" placeholder="ÏÉÅÌíàÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
        <div id="preview-container">Ï§ÄÎπÑÎêú ÏÇ¨ÏßÑÏù¥ ÏóÜÏäµÎãàÎã§</div>
        <div style="display:flex; gap:6px; margin-top:10px;">
            <button style="flex:1; padding:12px; background:#27ae60; color:white; border:none; border-radius:5px; font-weight:bold;" onclick="startCamera()">üì∑ Ïó∞ÏÜç Ï¥¨ÏòÅ</button>
            <button style="flex:1; padding:12px; background:#f0f2f5; color:#333; border:1px solid #ccc; border-radius:5px; font-weight:bold;" onclick="openGallery()">üñºÔ∏è Í∞§Îü¨Î¶¨</button>
        </div>
        <button id="batch-save-btn" style="width:100%; margin-top:8px; padding:14px; background:#3498db; color:white; border:none; border-radius:5px; font-weight:800; display:none;" onclick="saveToLibrary()">üíæ Ïù¥ Íµ¨ÏÑ±ÏúºÎ°ú Ï†ÄÏû•ÌïòÍ∏∞</button>
        <input type="file" id="photoGallery" accept="image/*" multiple style="display:none;" onchange="handleImg(this)">
        <hr style="margin:20px 0 10px 0; border:0; border-top:1px solid #eee;">
        <div class="lib-header">
            <span style="font-size: 12px; font-weight: bold; color: #27ae60;">Ï†ÄÏû• Î™©Î°ù</span>
            <div style="display: flex;">
                <button id="lib-batch-del" class="batch-del-top-btn" onclick="deleteSelectedItems()">ÏÑ†ÌÉù ÏÇ≠Ï†ú</button>
                <button id="lib-edit-toggle" class="lib-edit-btn" onclick="toggleLibEdit()">Ìé∏Ïßë</button>
            </div>
        </div>
        <div id="library-list"></div>
    </div>
</div>

<script>
    const NATION_MAP = { "ÎØ∏Íµ≠": "USA", "ÎèÖÏùº": "DE", "ÌîÑÎûëÏä§": "FR", "Ìò∏Ï£º": "AU", "ÏòÅÍµ≠": "GB", "Ï∫êÎÇòÎã§": "CA", "Í∑∏Î¶¨Ïä§": "GR", "ÎÑ§ÎçúÎûÄÎìú": "NL", "Îç¥ÎßàÌÅ¨": "DK", "ÎùºÌä∏ÎπÑÏïÑ": "LV", "Î£®ÎßàÎãàÏïÑ": "RO", "Î£©ÏÖàÎ∂ÄÎ•¥ÌÅ¨": "LU", "Î¶¨Ìà¨ÏïÑÎãàÏïÑ": "LT", "Î™∞ÌÉÄ": "MT", "Î≤®Í∏∞Ïóê": "BE", "Î∂àÍ∞ÄÎ¶¨ÏïÑ": "BG", "Ïä§Ïõ®Îç¥": "SE", "Ïä§ÌéòÏù∏": "ES", "Ïä¨Î°úÎ∞îÌÇ§ÏïÑ": "SK", "Ïä¨Î°úÎ≤†ÎãàÏïÑ": "SI", "ÏïÑÏùºÎûúÎìú": "IE", "ÏóêÏä§ÌÜ†ÎãàÏïÑ": "EE", "Ïò§Ïä§Ìä∏Î¶¨ÏïÑ": "AT", "Ïù¥ÌÉàÎ¶¨ÏïÑ": "IT", "Ï≤¥ÏΩî": "CZ", "ÌÅ¨Î°úÏïÑÌã∞ÏïÑ": "HR", "ÌÇ§ÌîÑÎ°úÏä§": "CY", "Ìè¨Î•¥Ìà¨Í∞à": "PT", "Ìè¥ÎûÄÎìú": "PL", "ÌïÄÎûÄÎìú": "FI", "ÌóùÍ∞ÄÎ¶¨": "HU" };
    const RATES = { "GB": { step: 0.5, rates: [14100, 15150, 16200, 17250, 18300, 19350, 20400, 21450, 22500, 23550, 24600, 25650, 26700, 27750, 28800, 29850, 30900, 31950, 33000, 34050] }, "USA": { step: 0.5, rates: [16800, 18500, 20200, 21900, 23600, 25300, 27000, 28700, 30400, 32100, 33800, 35500, 37200, 38900, 40600, 42300, 44000, 45700, 47400, 49100] }, "DE": { step: 0.5, rates: [17900, 19600, 21300, 23000, 24700, 26400, 28100, 29800, 31500, 33200, 34900, 36600, 38300, 40000, 41700, 43400, 45100, 46800, 48500, 50200] }, "CA": { step: 0.5, rates: [17600, 19400, 21200, 23000, 24800, 26600, 28400, 30200, 32000, 33800, 35600, 37400, 39200, 41000, 42800, 44600, 46400, 48200, 50000, 51800] }, "FR": { step: 0.5, rates: [18100, 19800, 21500, 23200, 24900, 26600, 28300, 30000, 31700, 33400, 35100, 36800, 38500, 40200, 41900, 43600, 45300, 47000, 48700, 50400] }, "AU": { step: 0.5, rates: [16500, 18100, 19700, 21300, 22900, 24500, 26100, 27700, 29300, 30900, 32500, 34100, 35700, 37300, 38900, 40500, 42100, 43700, 45300, 46900] }, "EU_COMMON": { step: 0.5, rates: [20500, 22500, 24500, 26500, 28500, 30500, 32500, 34500, 36500, 38500, 40500, 42500, 44500, 46500, 48500, 50500, 52500, 54500, 56500, 58500] } };
    let history = [], historyStep = -1, lastMode = 'margin', tempPhotos = [], library = [], currentLoadedId = null, isLibEditing = false, currentModalPhotos = [], currentModalIdx = 0;

    // ÌÉ≠ Ï†ÑÌôò
    function switchTab(tab) {
        document.getElementById('tab-calc').classList.remove('active');
        document.getElementById('tab-lib').classList.remove('active');
        document.getElementById('tab-calc-btn').classList.remove('active');
        document.getElementById('tab-lib-btn').classList.remove('active');
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('tab-' + tab + '-btn').classList.add('active');
    }

    // ÌôïÎåÄ ÌåêÎ≥Ñ Î∞è ÌÑ∞Ïπò Ïä§ÏôÄÏù¥ÌîÑ Ï†úÏñ¥ (ÌïµÏã¨ Í∞úÏÑ†)
    function isZoomed() { return window.visualViewport && window.visualViewport.scale > 1.05; }

    let touchStartX = 0;
    document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
    document.addEventListener('touchend', e => {
        if (isZoomed()) return; // ÌôïÎåÄ Ï§ëÏù¥Î©¥ ÌÉ≠ Ï†ÑÌôò Ïä§ÏôÄÏù¥ÌîÑ Í∏àÏßÄ
        let diffX = e.changedTouches[0].screenX - touchStartX;
        if (Math.abs(diffX) > 70) {
            let cur = document.getElementById('tab-calc').classList.contains('active') ? 'calc' : 'lib';
            if (diffX < 0 && cur === 'calc') switchTab('lib');
            else if (diffX > 0 && cur === 'lib') switchTab('calc');
        }
    }, {passive: true});

    // Íµ≠Í∞Ä Í≤ÄÏÉâ
    function filterList() {
        const input = document.getElementById('countryInput').value.toLowerCase();
        const list = document.getElementById('customList');
        list.innerHTML = '';
        if (!input) { list.style.display = 'none'; return; }
        let hasItem = false;
        Object.keys(NATION_MAP).forEach(ko => {
            if (ko.includes(input) || NATION_MAP[ko].toLowerCase().includes(input)) {
                const div = document.createElement('div');
                div.textContent = `${ko} (${NATION_MAP[ko]})`;
                div.onclick = () => { document.getElementById('countryInput').value = div.textContent; list.style.display = 'none'; onInputChange(); };
                list.appendChild(div);
                hasItem = true;
            }
        });
        list.style.display = hasItem ? 'block' : 'none';
    }

    // Í≥ÑÏÇ∞ Î°úÏßÅ
    function updateLast(m) { lastMode = m; }
    function clearField(el, type) { 
        if (el.value == '0' || el.value == '1450' || el.value == '3000' || el.value == '1000' || el.value == '20') el.value = ''; 
        if (type === 'margin') { document.getElementById('fixedPrice').value = ''; lastMode = 'margin'; }
        if (type === 'price') { document.getElementById('margin').value = ''; lastMode = 'price'; }
    }

    function convertUnitPrice(unit) {
        let val = parseFloat(document.getElementById('fixedPrice').value);
        let ex = parseFloat(document.getElementById('ex').value) || 1;
        if (!val) return;
        document.getElementById('fixedPrice').value = (unit === 'krw') ? Math.round(val * ex) : (val / ex).toFixed(2);
        onInputChange();
    }

    function onInputChange() {
        const cost = parseFloat(document.getElementById('cost').value) || 0;
        const ex = parseFloat(document.getElementById('ex').value) || 1;
        const w = parseFloat(document.getElementById('w').value) || 0;
        const x = parseFloat(document.getElementById('x').value) || 0;
        const y = parseFloat(document.getElementById('y').value) || 0;
        const z = parseFloat(document.getElementById('z').value) || 0;
        const local = parseFloat(document.getElementById('local').value) || 0;
        const pack = parseFloat(document.getElementById('pack').value) || 0;
        const duty = parseFloat(document.getElementById('duty').value) || 0;
        const buffer = parseFloat(document.getElementById('buffer').value) || 0;
        const shipType = parseFloat(document.getElementById('shipType').value);
        
        // Îπ®Í∞Ñ Ï†ê Ï†úÏñ¥
        document.getElementById('dot_countryInput').style.visibility = document.getElementById('countryInput').value ? 'hidden' : 'visible';
        document.getElementById('dot_ex').style.visibility = document.getElementById('ex').value ? 'hidden' : 'visible';
        document.getElementById('dot_cost').style.visibility = document.getElementById('cost').value ? 'hidden' : 'visible';
        document.getElementById('dot_w').style.visibility = w >= 1 ? 'hidden' : 'visible';
        document.getElementById('dot_local').style.visibility = document.getElementById('local').value ? 'hidden' : 'visible';
        document.getElementById('dot_pack').style.visibility = document.getElementById('pack').value ? 'hidden' : 'visible';
        document.getElementById('dot_buffer').style.visibility = document.getElementById('buffer').value ? 'hidden' : 'visible';
        document.getElementById('dot_margin').style.visibility = (lastMode === 'margin' && document.getElementById('margin').value) ? 'hidden' : 'visible';

        const volW = (x * y * z) / shipType;
        const finalW = Math.max(w, volW);
        document.getElementById('boxGuide').textContent = finalW > 0 ? `(Ïã§Î¨¥Í≤å: ${finalW.toFixed(2)}kg)` : '';

        let countryKey = "USA";
        const cVal = document.getElementById('countryInput').value;
        for (let k in NATION_MAP) { if (cVal.includes(k)) { countryKey = NATION_MAP[k]; break; } }
        const shipData = RATES[countryKey] || RATES["EU_COMMON"];
        const idx = Math.max(0, Math.ceil(finalW / shipData.step) - 1);
        const shipFee = (shipData.rates[idx] || shipData.rates[shipData.rates.length - 1]) + duty;

        const totalCostWon = cost + local + pack + shipFee;
        const resultArea = document.getElementById('resultArea');
        const resPrice = document.getElementById('resPrice');
        const resMarginInfo = document.getElementById('resMarginInfo');

        if (lastMode === 'margin') {
            const margin = parseFloat(document.getElementById('margin').value) || 0;
            const targetUsd = ((totalCostWon + margin) / ex) / (1 - (buffer / 100));
            resPrice.textContent = `$${targetUsd.toFixed(2)}`;
            resMarginInfo.textContent = `ÏòàÏÉÅ ÎßàÏßÑ: ${margin.toLocaleString()}Ïõê`;
            resultArea.className = 'result mode-margin';
            document.getElementById('fixedPriceInfo').innerHTML = `<span class="price-sub">(${(targetUsd * ex).toLocaleString()}Ïõê)</span>`;
            document.getElementById('bepInfo').textContent = `ÏõêÍ∞ÄÎ∞©Ïñ¥ÏÑ†: $${(totalCostWon / ex / (1 - (buffer/100))).toFixed(2)}`;
        } else {
            const isUsd = document.getElementById('unitUsd').checked;
            let pVal = parseFloat(document.getElementById('fixedPrice').value) || 0;
            const saleUsd = isUsd ? pVal : pVal / ex;
            const netKrw = (saleUsd * ex * (1 - (buffer / 100))) - totalCostWon;
            resPrice.textContent = `$${saleUsd.toFixed(2)}`;
            resMarginInfo.textContent = netKrw >= 0 ? `ÏòàÏÉÅ ÎßàÏßÑ: ${Math.round(netKrw).toLocaleString()}Ïõê` : `ÏòàÏÉÅ ÏÜêÏã§: ${Math.abs(Math.round(netKrw)).toLocaleString()}Ïõê`;
            resMarginInfo.style.color = netKrw >= 0 ? '#27ae60' : '#e74c3c';
            resultArea.className = 'result mode-price';
            document.getElementById('fixedPriceInfo').innerHTML = `<span class="price-sub">(${(saleUsd * ex).toLocaleString()}Ïõê)</span>`;
            document.getElementById('bepInfo').textContent = `ÏõêÍ∞ÄÎ∞©Ïñ¥ÏÑ†: $${(totalCostWon / ex / (1 - (buffer/100))).toFixed(2)}`;
        }
        resultArea.style.display = 'block';
        saveHistory();
    }

    // ÌûàÏä§ÌÜ†Î¶¨ Í¥ÄÎ¶¨
    function saveHistory() {
        const data = {
            c: document.getElementById('countryInput').value, ex: document.getElementById('ex').value,
            cost: document.getElementById('cost').value, margin: document.getElementById('margin').value,
            fixed: document.getElementById('fixedPrice').value, unit: document.querySelector('input[name="priceUnit"]:checked').value,
            st: document.getElementById('shipType').value, w: document.getElementById('w').value,
            x: document.getElementById('x').value, y: document.getElementById('y').value, z: document.getElementById('z').value,
            l: document.getElementById('local').value, p: document.getElementById('pack').value,
            d: document.getElementById('duty').value, b: document.getElementById('buffer').value, mode: lastMode
        };
        const sData = JSON.stringify(data);
        if (historyStep >= 0 && history[historyStep] === sData) return;
        history = history.slice(0, historyStep + 1);
        history.push(sData);
        if (history.length > 30) history.shift();
        historyStep = history.length - 1;
    }

    function applyHistory(s) {
        const d = JSON.parse(s);
        document.getElementById('countryInput').value = d.c; document.getElementById('ex').value = d.ex;
        document.getElementById('cost').value = d.cost; document.getElementById('margin').value = d.margin;
        document.getElementById('fixedPrice').value = d.fixed;
        document.getElementById(d.unit === 'krw' ? 'unitKrw' : 'unitUsd').checked = true;
        document.getElementById('shipType').value = d.st; document.getElementById('w').value = d.w;
        document.getElementById('x').value = d.x; document.getElementById('y').value = d.y; document.getElementById('z').value = d.z;
        document.getElementById('local').value = d.l; document.getElementById('pack').value = d.p;
        document.getElementById('duty').value = d.d; document.getElementById('buffer').value = d.b;
        lastMode = d.mode; onInputChange();
    }
    function goBack() { if (historyStep > 0) applyHistory(history[--historyStep]); }
    function goForward() { if (historyStep < history.length - 1) applyHistory(history[++historyStep]); }

    // ÏÇ¨ÏßÑ Ï¥¨ÏòÅ Î∞è Í∞§Îü¨Î¶¨ (ÏùòÏû•Îãò ÏßÄÏπ® Ï†ÅÏö©: Ïó∞ÏÜçÏ¥¨ÏòÅ, Ïä§ÏôÄÏù¥ÌîÑ Î∑∞Ïñ¥)
    let stream = null;
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('camera-video').srcObject = stream;
            document.getElementById('camera-overlay').style.display = 'flex';
            document.getElementById('shot-count').textContent = `${tempPhotos.length}Ïû• Ï¥¨ÏòÅÎê®`;
        } catch (e) { alert("Ïπ¥Î©îÎùº Ï†ëÍ∑º Î∂àÍ∞Ä"); }
    }

    function stopCamera() {
        if (stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('camera-overlay').style.display = 'none';
        renderPreview();
    }

    function takePhoto() {
        const video = document.getElementById('camera-video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        tempPhotos.push(canvas.toDataURL('image/jpeg'));
        document.getElementById('shot-count').textContent = `${tempPhotos.length}Ïû• Ï¥¨ÏòÅÎê®`;
    }

    function openGallery() { document.getElementById('photoGallery').click(); }
    function handleImg(input) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => { tempPhotos.push(e.target.result); renderPreview(); };
            reader.readAsDataURL(file);
        });
    }

    function renderPreview() {
        const container = document.getElementById('preview-container');
        container.innerHTML = '';
        tempPhotos.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'thumb-box';
            div.innerHTML = `<img src="${p}"><div class="thumb-del" onclick="tempPhotos.splice(${i},1); renderPreview();">√ó</div>`;
            container.appendChild(div);
        });
        document.getElementById('batch-save-btn').style.display = tempPhotos.length > 0 ? 'block' : 'none';
    }

    // Ï†ÄÏû•ÏÜå Í∏∞Îä•
    function saveToLibrary() {
        const title = document.getElementById('saveTitle').value || "ÎØ∏ÏßÄÏ†ï ÏÉÅÌíà";
        const item = {
            id: currentLoadedId || Date.now(),
            title: title,
            date: new Date().toLocaleString(),
            photos: [...tempPhotos],
            data: history[historyStep]
        };
        if (currentLoadedId) {
            const idx = library.findIndex(li => li.id === currentLoadedId);
            if (idx > -1) library[idx] = item;
            currentLoadedId = null;
            document.getElementById('loaded-container').style.display = 'none';
        } else {
            library.unshift(item);
        }
        localStorage.setItem('nana_lib', JSON.stringify(library));
        tempPhotos = []; document.getElementById('saveTitle').value = '';
        renderPreview(); renderLibrary(); switchTab('lib');
    }

    function renderLibrary() {
        const list = document.getElementById('library-list');
        list.innerHTML = '';
        library.forEach(item => {
            const div = document.createElement('div');
            div.className = `library-item ${currentLoadedId === item.id ? 'editing' : ''}`;
            div.onclick = () => loadItem(item);
            div.innerHTML = `
                <input type="checkbox" class="lib-checkbox" data-id="${item.id}" onclick="event.stopPropagation()">
                <img src="${item.photos[0] || ''}" onclick="event.stopPropagation(); openModal(${JSON.stringify(item.photos).replace(/"/g, '&quot;')}, 0)">
                <div class="library-info">
                    <div class="library-title-row"><span class="library-title">${item.title}</span></div>
                    <span class="library-date">${item.date}</span>
                </div>
                <span class="edit-icon" onclick="event.stopPropagation(); startEditItem(${item.id})">‚úèÔ∏è</span>
            `;
            list.appendChild(div);
        });
    }

    function startEditItem(id) {
        const item = library.find(li => li.id === id);
        if (!item) return;
        currentLoadedId = id;
        document.getElementById('saveTitle').value = item.title;
        tempPhotos = [...item.photos];
        renderPreview();
        document.getElementById('loaded-text').textContent = `ÏàòÏ†ïÏ§ë: ${item.title}`;
        document.getElementById('loaded-container').style.display = 'flex';
        switchTab('lib');
    }

    function loadItem(item) {
        if (isLibEditing) return;
        applyHistory(item.data);
        currentLoadedId = item.id;
        document.getElementById('loaded-text').textContent = `Î∂àÎü¨Ïò¥: ${item.title}`;
        document.getElementById('loaded-container').style.display = 'flex';
        switchTab('calc');
    }

    function unloadItem() { currentLoadedId = null; document.getElementById('loaded-container').style.display = 'none'; }

    function toggleLibEdit() {
        isLibEditing = !isLibEditing;
        document.querySelectorAll('.lib-checkbox').forEach(cb => cb.style.display = isLibEditing ? 'block' : 'none');
        document.getElementById('lib-batch-del').style.display = isLibEditing ? 'block' : 'none';
        document.getElementById('lib-edit-toggle').textContent = isLibEditing ? 'Ï∑®ÏÜå' : 'Ìé∏Ïßë';
    }

    function deleteSelectedItems() {
        const checked = Array.from(document.querySelectorAll('.lib-checkbox:checked')).map(cb => parseInt(cb.dataset.id));
        library = library.filter(li => !checked.includes(li.id));
        localStorage.setItem('nana_lib', JSON.stringify(library));
        toggleLibEdit(); renderLibrary();
    }

    // Î™®Îã¨ Î∑∞Ïñ¥ (ÏùòÏû•Îãò ÏßÄÏπ®: Ïä§ÏôÄÏù¥ÌîÑ ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò, Î≤ÑÌäº Ï†úÍ±∞)
    function openModal(photos, idx) {
        currentModalPhotos = photos; currentModalIdx = idx;
        const modal = document.getElementById('img-modal');
        modal.style.display = 'flex';
        updateModalImg();
    }

    function closeModal() { document.getElementById('img-modal').style.display = 'none'; }

    function updateModalImg() {
        document.getElementById('modal-img').src = currentModalPhotos[currentModalIdx];
        document.getElementById('modal-counter').textContent = `${currentModalIdx + 1} / ${currentModalPhotos.length}`;
    }

    let modalStartX = 0;
    document.getElementById('modal-img-container').addEventListener('touchstart', e => { modalStartX = e.changedTouches[0].screenX; }, {passive: true});
    document.getElementById('modal-img-container').addEventListener('touchend', e => {
        const diffX = e.changedTouches[0].screenX - modalStartX;
        if (diffX > 50 && currentModalIdx > 0) { currentModalIdx--; updateModalImg(); }
        else if (diffX < -50 && currentModalIdx < currentModalPhotos.length - 1) { currentModalIdx++; updateModalImg(); }
    }, {passive: true});

    function deleteCurrentPhoto(e) {
        e.stopPropagation();
        if (!confirm("Ïù¥ ÏÇ¨ÏßÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
        currentModalPhotos.splice(currentModalIdx, 1);
        if (currentModalPhotos.length === 0) { closeModal(); }
        else { if (currentModalIdx >= currentModalPhotos.length) currentModalIdx--; updateModalImg(); }
        // ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏõêÎ≥∏ ÏóÖÎç∞Ïù¥Ìä∏
        const item = library.find(li => li.id === currentLoadedId);
        if (item) { item.photos = [...currentModalPhotos]; localStorage.setItem('nana_lib', JSON.stringify(library)); renderLibrary(); }
    }

    // ÏãúÍ≥Ñ Î∞è Ï¥àÍ∏∞Ìôî
    setInterval(() => {
        const now = new Date();
        document.getElementById('live-clock').textContent = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    }, 1000);

    window.onload = () => {
        const saved = localStorage.getItem('nana_lib');
        if (saved) { library = JSON.parse(saved); renderLibrary(); }
        onInputChange();
    };
</script>
</body>
</html>
