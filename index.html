<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</title>
    <style>
        /* [ìŠ¤íƒ€ì¼ - ë¶ˆë³€ì˜ ì›ì¹™ ì ìš©] */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .nav-tabs { display: flex; width: 320px; margin-bottom: 15px; background: #e0e0e0; border-radius: 10px; padding: 5px; box-sizing: border-box; }
        .nav-tabs button { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; background: none; color: #666; transition: 0.3s; }
        .nav-tabs button.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content { display: none; width: 100%; max-width: 320px; }
        .tab-content.active { display: block; }
        .box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #2c3e50; position: relative; box-sizing: border-box; }
        h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        .section-title { font-size: 11px; color: #27ae60; font-weight: bold; margin: 12px 0 6px 0; display: flex; align-items: center; }
        .section-title::before { content: "â—"; margin-right: 5px; font-size: 7px; }
        label { font-size: 10px; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; width: 100%; }
        .req-dot { color: red; font-weight: bold; font-size: 26px; line-height: 1; visibility: visible; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 13px; background: #fff; transition: all 0.2s ease; color: #000; -webkit-appearance: none; }
        input:focus { border-color: #2c3e50; outline: none; box-shadow: 0 0 5px rgba(44,62,80,0.2); }
        .search-input { border: 2px solid #2c3e50; background: #f9f9f9; font-weight: bold; }
        .dropdown-container { position: relative; }
        .custom-list { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #2c3e50; border-top: none; border-radius: 0 0 5px 5px; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .custom-list div { padding: 10px; font-size: 13px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; }
        .row { display: flex; gap: 6px; margin-bottom: 8px; align-items: flex-end; }
        .row div { flex: 1; min-width: 0; }
        .result { margin-top: 15px; padding: 12px; border-radius: 10px; display: none; transition: all 0.3s; border: 1px solid #ccc; }
        .mode-margin { background-color: #f0f7ff !important; border: 2px solid #3498db !important; }
        .mode-price { background-color: #fffdf0 !important; border: 2px solid #f1c40f !important; }
        .price-tag { font-size: 22px; font-weight: bold; color: #000; text-align: center; display: block; margin: 5px 0; word-break: break-all; }
        .footer-note { margin-top: 15px; font-size: 10px; color: #777; line-height: 1.5; border-top: 1px solid #eee; padding-top: 12px; }
        #bepInfo { font-size: 14px; margin-top: 4px; font-weight: bold; text-align: right; line-height: 1.3; white-space: nowrap; letter-spacing: -0.5px; color: #000; }
        #resMarginInfo { text-align: center; font-size: 15px; font-weight: bold; margin-bottom: 8px; }
        #loaded-container { position: absolute; top: -10px; right: 5px; display: none; align-items: center; background: #454d55; color: #f8f9fa; padding: 4px 10px; border-radius: 6px; z-index: 100; max-width: 170px; border: 1px solid #343a40; }
        #loaded-text { font-size: 11px; font-weight: 500; margin-right: 8px; word-break: break-all; white-space: normal; line-height: 1.1; }
        #close-loaded { cursor: pointer; font-size: 18px; font-weight: bold; line-height: 1; color: #adb5bd; padding: 0 2px; }
        
        /* ì €ì¥ì†Œ ìŠ¤íƒ€ì¼ */
        .save-box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #27ae60; box-sizing: border-box; }
        #live-clock { font-size: 13px; color: #1e8449; font-weight: 800; display: block; margin: -5px 0 15px 0; text-align: center; background: #eafaf1; padding: 4px; border-radius: 5px; border: 1px solid #27ae60; }
        .library-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; align-items: flex-start; cursor: pointer; position: relative; background: #fff; box-sizing: border-box; overflow: hidden; }
        .library-item img { width: 60px; height: 60px; border-radius: 5px; object-fit: cover; margin-right: 12px; flex-shrink: 0; background: #eee; border: 1px solid #ddd; }
        .library-info { flex: 1; min-width: 0; padding-right: 40px; }
        .library-title { font-size: 14px; color: #2c3e50; font-weight: bold; word-break: break-all; white-space: normal; line-height: 1.2; margin-bottom: 4px; display: flex; align-items: center; }
        .library-date { font-size: 15px; color: #444; font-weight: 700; } 
        .save-btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #preview-container { width: 100%; height: 120px; border: 1px dashed #ccc; margin-top: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 5px; background: #fafafa; }
        #preview-container img { height: 100%; }
        .del-btn { position: absolute; right: 8px; top: 8px; color: #ccc; font-size: 20px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; z-index: 5; }

        #img-modal { display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        #img-modal img { max-width: 95%; max-height: 85%; border-radius: 8px; }
        #img-modal .close-modal { position: absolute; top: 20px; right: 20px; color: white; font-size: 35px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="img-modal" onclick="closeModal()">
    <span class="close-modal">&times;</span>
    <img id="modal-img" src="">
</div>

<div class="nav-tabs">
    <button id="tab-calc-btn" class="active" onclick="switchTab('calc')">ê³„ì‚°ê¸°</button>
    <button id="tab-lib-btn" onclick="switchTab('lib')">ìƒí’ˆ ì €ì¥ì†Œ</button>
</div>

<div id="tab-calc" class="tab-content active">
    <div class="box">
        <div id="loaded-container">
            <span id="loaded-text">ë¶ˆëŸ¬ì˜´: ì—†ìŒ</span>
            <span id="close-loaded" onclick="event.stopPropagation(); unloadItem();">Ã—</span>
        </div>
        <h3>âš¡ ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</h3>
        <div class="row">
            <div style="flex: 1.4;" class="dropdown-container">
                <label><span>ëª©ì ì§€ êµ­ê°€ ê²€ìƒ‰</span><span id="dot_country" class="req-dot">.</span></label>
                <input type="text" id="countryInput" class="search-input" value="ë¯¸êµ­ (USA)" onfocus="showList(); this.value=''; this.style.backgroundColor='#fff0f0'; this.style.borderColor='#e74c3c'; doCalc();" oninput="filterList(); saveInputs(); doCalc();" autocomplete="off">
                <div id="customList" class="custom-list"></div>
            </div>
            <div>
                <label><span>ì ìš© í™˜ìœ¨</span><span id="dot_ex" class="req-dot">.</span></label>
                <input type="number" id="ex" value="1450" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()">
            </div>
        </div>
        <div class="section-title">ê¸°ë³¸ ìˆ˜ìµ ì„¤ì •</div>
        <div class="row">
            <div><label><span>ìƒí’ˆ ì›ê°€ <small>(ì›)</small></span><span id="dot_cost" class="req-dot">.</span></label><input type="number" id="cost" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()"></div>
            <div><label><span>í¬ë§ ë§ˆì§„ <small>(ì›)</small></span><span id="dot_margin" class="req-dot">.</span></label><input type="number" id="margin" value="0" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="updateLast('margin'); saveInputs(); doCalc()"></div>
        </div>
        <div class="row">
            <div><label><span>í¬ë§ íŒë§¤ê°€ <small>(ì›)</small></span><span id="dot_fixedPrice" class="req-dot">.</span></label><input type="number" id="fixedPrice" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="updateLast('price'); saveInputs(); doCalc()"></div>
            <div style="flex: 2; display: flex; flex-direction: column; justify-content: flex-end;"><div id="bepInfo"></div></div>
        </div>
        <div class="section-title">ìƒí’ˆ ê·œê²© ë° ë°°ì†¡</div>
        <div class="row">
            <div style="flex: 1.2;"><label>ë°°ì†¡ íƒ€ì…</label><select id="shipType" onchange="saveInputs(); doCalc()"><option value="6000">ì¼ë°˜ (/6000)</option><option value="5000">íŠ¹ì†¡ (/5000)</option></select></div>
            <div><label><span>ë¬´ê²Œ<small>(kg)</small></span><span id="dot_w" class="req-dot">.</span></label><input type="number" id="w" step="0.01" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()"></div>
        </div>
        <div class="row">
            <div><label>ê°€ë¡œ<small>(cm)</small></label><input type="number" id="x" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()"></div>
            <div><label>ì„¸ë¡œ<small>(cm)</small></label><input type="number" id="y" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()"></div>
            <div><label>ë†’ì´<small>(cm)</small></label><input type="number" id="z" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()"></div>
        </div>
        <div class="section-title">ê¸°íƒ€ ë¶€ìˆ˜ ë¹„ìš©</div>
        <div class="row">
            <div><label><span>êµ­ë‚´ ë°°ì†¡ë¹„ <small>(ì›)</small></span><span id="dot_local" class="req-dot">.</span></label><input type="number" id="local" value="3000" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()"></div>
            <div><label><span>í¬ì¥ë¹„ <small>(ì›)</small></span><span id="dot_pack" class="req-dot">.</span></label><input type="number" id="pack" value="1300" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()"></div>
        </div>
        <div class="row">
            <div><label>ê´€ì„¸ <small>(ì›/ì„ íƒ)</small></label><input type="number" id="duty" placeholder="0" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()"></div>
            <div><label><span>ìˆ˜ìˆ˜ë£Œ ë²„í¼ <small>(%)</small></span><span id="dot_buffer" class="req-dot">.</span></label><input type="number" id="buffer" value="20" onfocus="this.value=''; doCalc()" onblur="doCalc()" oninput="saveInputs(); doCalc()"></div>
        </div>
        <div id="resultArea" class="result">
            <label id="resTitle" style="color:#2c3e50; display:block; text-align:center; font-size:11px; font-weight:bold;">ì´ë² ì´ íŒë§¤ê°€</label>
            <span id="resPrice" class="price-tag">$0.00</span>
            <div id="resMarginInfo"></div>
            <div id="resDetail" style="font-size: 10px; color:#444; line-height: 1.6; border-top:1px dashed #ccc; padding-top:8px;"></div>
        </div>
        <div class="footer-note"><strong>* ì •ì‹ ìš”ìœ¨í‘œ ë¡œì§ ì ìš© ì™„ë£Œ</strong></div>
    </div>
</div>

<div id="tab-lib" class="tab-content">
    <div class="save-box">
        <h3>ğŸ“ ìƒí’ˆ ì €ì¥ì†Œ</h3>
        <div id="live-clock"></div>
        <label>ìƒí’ˆ ì €ì¥ ì œëª©</label>
        <input type="text" id="saveTitle" placeholder="ìœ„ì¹˜ ë¶„ì„ ì¤‘...">
        <label style="margin-top:10px;">ìƒí’ˆ ì‚¬ì§„</label>
        <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImg(this)">
        <button onclick="document.getElementById('photoInput').click()" style="width:100%; padding:10px; font-size:13px; cursor:pointer; background:#f9f9f9; border:1px solid #ccc; border-radius:5px;">ğŸ“· ì‚¬ì§„ ì°ê¸° / ê°¤ëŸ¬ë¦¬ ì„ íƒ</button>
        <div id="preview-container">ë¯¸ë¦¬ë³´ê¸°</div>
        <button class="save-btn" onclick="saveToLibrary()">ì´ë¯¸ì§€ì €ì¥ / ì¹´í†¡ì „ì†¡</button>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <div id="library-list"></div>
    </div>
</div>

<script>
    const NATION_MAP = { "ë¯¸êµ­": "USA", "ë…ì¼": "DE", "í”„ë‘ìŠ¤": "FR", "í˜¸ì£¼": "AU", "ì˜êµ­": "GB", "ìºë‚˜ë‹¤": "CA", "ê·¸ë¦¬ìŠ¤": "GR", "ë„¤ëœë€ë“œ": "NL", "ë´ë§ˆí¬": "DK", "ë¼íŠ¸ë¹„ì•„": "LV", "ë£¨ë§ˆë‹ˆì•„": "RO", "ë£©ì…ˆë¶€ë¥´í¬": "LU", "ë¦¬íˆ¬ì•„ë‹ˆì•„": "LT", "ëª°íƒ€": "MT", "ë²¨ê¸°ì—": "BE", "ë¶ˆê°€ë¦¬ì•„": "BG", "ìŠ¤ì›¨ë´": "SE", "ìŠ¤í˜ì¸": "ES", "ìŠ¬ë¡œë°”í‚¤ì•„": "SK", "ìŠ¬ë¡œë² ë‹ˆì•„": "SI", "ì•„ì¼ëœë“œ": "IE", "ì—ìŠ¤í† ë‹ˆì•„": "EE", "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„": "AT", "ì´íƒˆë¦¬ì•„": "IT", "ì²´ì½”": "CZ", "í¬ë¡œì•„í‹°ì•„": "HR", "í‚¤í”„ë¡œìŠ¤": "CY", "í¬ë¥´íˆ¬ê°ˆ": "PT", "í´ë€ë“œ": "PL", "í•€ë€ë“œ": "FI", "í—ê°€ë¦¬": "HU" };
    const RATES = { "GB": { step: 0.1, base: [5700,7000,8200,9400,10600,11900,13100,14300,15500,16700,18000,19200,20400,21600,22900,24100,25300,26500,27700,29000], overStep: 0.5, overFee: 6100 }, "USA": { step: 0.1, base: [7500,9100,10800,12500,14900,16200,17500,18800,20100,21400,23000,24300,25600,27200,28400,30200,31400,32700,34300,35500], overStep: 0.5, overFee: 6350 }, "CA": { step: 0.1, base: [7200,8300,10000,11300,12600,14400,15400,16500,17600,18600,20500,21600,22700,23700,24800,27800,28800,29900,31000,32000], overStep: 0.5, overFee: 5500 }, "DE": { step: 0.5, base: [11700, 26100, 54300, 101000], overStep: 0.5, overFee: 4800 }, "FR": { step: 0.5, base: [12600, 29200, 61900, 114500], overStep: 0.5, overFee: 5500 }, "BE": { step: 0.5, base: [12100, 27400, 56000, 104000], overStep: 0.5, overFee: 5000 }, "IT": { step: 0.5, base: [14100, 31000, 67000, 122400], overStep: 0.5, overFee: 5800 }, "NL": { step: 0.5, base: [14200, 28300, 56200, 102700], overStep: 0.5, overFee: 4900 }, "GR": { step: 0.5, base: [12400, 33000, 78800, 146300], overStep: 0.5, overFee: 7000 }, "PL": { step: 0.5, base: [12500, 28500, 63600, 117000], overStep: 0.5, overFee: 5600 }, "ES": { step: 0.5, base: [11700, 29900, 64700, 123800], overStep: 0.5, overFee: 6000 }, "AT": { step: 0.5, base: [15300, 31700, 64300, 118800], overStep: 0.5, overFee: 5800 }, "FI": { step: 0.5, base: [20200, 38800, 77700, 140500], overStep: 0.5, overFee: 6800 }, "IE": { step: 0.5, base: [14500, 32300, 67700, 126500], overStep: 0.5, overFee: 6200 }, "SE": { step: 0.5, base: [15500, 34000, 69600, 128900], overStep: 0.5, overFee: 6200 }, "DK": { step: 0.5, base: [14600, 29500, 59300, 109000], overStep: 0.5, overFee: 5200 }, "CZ": { step: 0.5, base: [14000, 31600, 65200, 120300], overStep: 0.5, overFee: 5800 }, "HU": { step: 0.5, base: [11600, 28500, 62500, 119100], overStep: 0.5, overFee: 6000 }, "RO": { step: 0.5, base: [11800, 28900, 63400, 119000], overStep: 0.5, overFee: 5800 }, "SK": { step: 0.5, base: [11800, 25200, 51900, 96600], overStep: 0.5, overFee: 4800 }, "SI": { step: 0.5, base: [22600, 40000, 74800, 132800], overStep: 0.5, overFee: 6200 } };
    
    let currentImgBase64 = "";
    let preFetchedLocation = "";
    let currentLoadedId = null;
    let lastField = 'margin';

    const listEl = document.getElementById('customList');
    const inputEl = document.getElementById('countryInput');

    function updateClock() {
        const now = new Date(); const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const clockEl = document.getElementById('live-clock');
        if(clockEl) clockEl.innerHTML = `ğŸ“… ${now.toLocaleDateString()} (${days[now.getDay()]}) &nbsp; â° ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    }
    setInterval(updateClock, 1000);

    function showList() {
        listEl.innerHTML = '';
        Object.keys(NATION_MAP).forEach(name => {
            const div = document.createElement('div');
            div.innerText = `${name} (${NATION_MAP[name]})`;
            div.onclick = () => { inputEl.value = div.innerText; listEl.style.display = 'none'; saveInputs(); doCalc(); };
            listEl.appendChild(div);
            if (name === "ìºë‚˜ë‹¤") {
                const hr = document.createElement('hr'); hr.style.border = "0"; hr.style.height = "3px"; hr.style.background = "#000"; hr.style.margin = "0";
                listEl.appendChild(hr);
            }
        });
        listEl.style.display = 'block';
    }

    function filterList() {
        const val = inputEl.value.toLowerCase();
        const items = listEl.querySelectorAll('div');
        items.forEach(item => { item.style.display = item.innerText.toLowerCase().includes(val) ? 'block' : 'none'; });
    }

    document.addEventListener('click', (e) => { if (!e.target.closest('.dropdown-container')) listEl.style.display = 'none'; });

    function updateLast(type) { lastField = type; }

    function saveInputs() {
        const ids = ['countryInput', 'ex', 'cost', 'margin', 'fixedPrice', 'shipType', 'w', 'x', 'y', 'z', 'local', 'pack', 'duty', 'buffer'];
        const data = {};
        ids.forEach(id => { const el = document.getElementById(id); if(el) data[id] = el.value; });
        data['lastField'] = lastField;
        data['currentLoadedId'] = currentLoadedId;
        data['loadedText'] = document.getElementById('loaded-text').innerText;
        localStorage.setItem('nanaCalcData', JSON.stringify(data));
    }

    function loadInputs() {
        const saved = localStorage.getItem('nanaCalcData');
        if (saved) {
            const data = JSON.parse(saved);
            Object.keys(data).forEach(id => {
                if (id === 'lastField') { lastField = data[id]; }
                else if (id === 'currentLoadedId') { currentLoadedId = data[id]; }
                else if (id === 'loadedText') {
                    if (currentLoadedId) {
                        document.getElementById('loaded-text').innerText = data[id];
                        document.getElementById('loaded-container').style.display = "flex";
                    }
                }
                else { const el = document.getElementById(id); if(el) el.value = data[id]; }
            });
        }
    }

    function doCalc() {
        const fields = ['cost', 'local', 'pack', 'buffer', 'w', 'ex'];
        let allFilled = true;
        fields.forEach(id => {
            const input = document.getElementById(id);
            const dot = document.getElementById('dot_' + id);
            if(!input) return;
            const val = input.value.trim();
            const numVal = parseFloat(val);
            let condition = (val === "" || (id === 'w' && (isNaN(numVal) || numVal < 1))); // ë¬´ê²Œ 1 ë¯¸ë§Œ ë¹¨ê°„ ì  ìœ ì§€ ë¡œì§
            if (condition) { allFilled = false; if(dot) dot.style.visibility = "visible"; }
            else { if(dot) dot.style.visibility = "hidden"; }
        });

        const marginInput = document.getElementById('margin');
        const priceInput = document.getElementById('fixedPrice');
        const marginDot = document.getElementById('dot_margin');
        const priceDot = document.getElementById('dot_fixedPrice');
        const resultArea = document.getElementById('resultArea');

        marginInput.style.backgroundColor = "#fff"; marginInput.style.border = "1px solid #ccc";
        priceInput.style.backgroundColor = "#fff"; priceInput.style.border = "1px solid #ccc";
        resultArea.classList.remove('mode-margin', 'mode-price');

        if (marginInput.value === "" && priceInput.value === "") {
            allFilled = false; marginDot.style.visibility = "visible"; priceDot.style.visibility = "visible";
        } else {
            marginDot.style.visibility = (marginInput.value === "") ? "visible" : "hidden";
            priceDot.style.visibility = (priceInput.value === "") ? "visible" : "hidden";
            if(lastField === 'margin') {
                marginInput.style.backgroundColor = "#f0f7ff"; marginInput.style.border = "2px solid #3498db";
                resultArea.classList.add('mode-margin');
            } else {
                priceInput.style.backgroundColor = "#fffdf0"; priceInput.style.border = "2px solid #f1c40f";
                resultArea.classList.add('mode-price');
            }
        }

        const countryDot = document.getElementById('dot_country');
        const countryVal = inputEl.value.trim();
        let selectedCode = "";
        for (let key in NATION_MAP) { if (countryVal !== "" && (key.includes(countryVal) || countryVal.includes(key))) { selectedCode = NATION_MAP[key]; break; } }
        
        if (selectedCode === "") { allFilled = false; countryDot.style.visibility = "visible"; inputEl.style.backgroundColor = "#fff0f0"; }
        else { countryDot.style.visibility = "hidden"; inputEl.style.backgroundColor = "#f9f9f9"; }

        if (!allFilled) { resultArea.style.display = 'none'; document.getElementById('bepInfo').innerText = ""; return; }

        const div = parseFloat(document.getElementById('shipType').value);
        const cost = parseFloat(document.getElementById('cost').value);
        const local = parseFloat(document.getElementById('local').value);
        const pack = parseFloat(document.getElementById('pack').value);
        const buffer = parseFloat(document.getElementById('buffer').value);
        const duty = parseFloat(document.getElementById('duty').value) || 0;
        const margin = parseFloat(marginInput.value) || 0;
        const fixedPrice = parseFloat(priceInput.value) || 0;
        const w = parseFloat(document.getElementById('w').value);
        const x = parseFloat(document.getElementById('x').value) || 0;
        const y = parseFloat(document.getElementById('y').value) || 0;
        const z = parseFloat(document.getElementById('z').value) || 0;
        const ex = parseFloat(document.getElementById('ex').value);

        const volW = (x * y * z) / div;
        const finalW = Math.max(w, volW);
        const data = RATES[selectedCode];
        let shipKrw = 0;
        if (finalW <= 2.0) {
            let idx = Math.ceil(finalW / data.step) - 1; if (idx < 0) idx = 0;
            shipKrw = data.base[idx] || data.base[data.base.length-1];
        } else {
            const lastBase = data.base[data.base.length-1];
            shipKrw = lastBase + (Math.ceil((finalW - 2.0) / data.overStep) * data.overFee);
        }

        const bufferRate = (100 - buffer) / 100;
        const expenseSum = cost + local + pack + duty + shipKrw;
        const bepKrw = (expenseSum / bufferRate);
        const bepUsd = bepKrw / ex;

        const bepInfo = document.getElementById('bepInfo');
        const resMarginInfo = document.getElementById('resMarginInfo');
        let finalPriceKrw = 0; let actualMargin = 0;

        if (lastField === 'price' && fixedPrice > 0) {
            finalPriceKrw = fixedPrice;
            actualMargin = (fixedPrice * bufferRate) - expenseSum;
            const marginLabel = actualMargin < 0 ? "ì†í•´" : "ì˜ˆìƒ ë§ˆì§„";
            const marginColor = actualMargin < 0 ? "#d32f2f" : "#2e7d32";
            bepInfo.innerHTML = `<span style="color:${marginColor}; font-size:12px;">${marginLabel}: $${(actualMargin/ex).toFixed(2)} (${Math.round(actualMargin).toLocaleString()}ì›)</span><br><span style="color:#e65100; font-size:12px;">ë¶„ê¸°ì : $${bepUsd.toFixed(2)} (${Math.round(bepKrw).toLocaleString()}ì›)</span>`;
        } else {
            finalPriceKrw = (expenseSum + margin) / bufferRate;
            actualMargin = margin;
            // [ë³µêµ¬: ì˜ˆìƒíŒë§¤ê°€ ë‹¬ëŸ¬+ì›í™” ë³‘ê¸°]
            bepInfo.innerHTML = `<span style="color:#3498db; font-size:12px;">ì˜ˆìƒíŒë§¤ê°€: $${(finalPriceKrw/ex).toFixed(2)} (${Math.round(finalPriceKrw).toLocaleString()}ì›)</span><br><span style="color:#e65100; font-size:12px;">ë¶„ê¸°ì : $${bepUsd.toFixed(2)} (${Math.round(bepKrw).toLocaleString()}ì›)</span>`;
        }

        const actualMarginUsd = actualMargin / ex;
        const finalUsd = finalPriceKrw / ex;

        resMarginInfo.style.color = (actualMargin < 0) ? "#d32f2f" : "#2e7d32";
        resMarginInfo.innerText = (actualMargin < 0 ? "ì†í•´: $" : "ì˜ˆìƒ ë§ˆì§„: $") + actualMarginUsd.toFixed(2) + " (" + Math.round(actualMargin).toLocaleString() + "ì›)";

        const resPriceEl = document.getElementById('resPrice');
        resPriceEl.style.color = (finalPriceKrw <= bepKrw + 1) ? "#d32f2f" : "#000";
        resPriceEl.innerText = "$" + finalUsd.toFixed(2) + " (" + Math.round(finalPriceKrw).toLocaleString() + "ì›)";
        
        document.getElementById('resDetail').innerHTML = `â€¢ ì‹¤ì¤‘ëŸ‰: ${w.toFixed(2)}kg / ë¶€í”¼: ${volW.toFixed(2)}kg<br>â€¢ <b>ìµœì¢… ì ìš©: ${finalW.toFixed(2)}kg</b><br>â€¢ í•´ì™¸ ë°°ì†¡ë¹„: <b>${shipKrw.toLocaleString()}ì›</b><br>â€¢ ì§€ì¶œ í•©ê³„: ${Math.round(expenseSum).toLocaleString()}ì›`;
        resultArea.style.display = 'block';
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('tab-' + tab + '-btn').classList.add('active');
        if (tab === 'lib') {
            const titleInput = document.getElementById('saveTitle');
            if (preFetchedLocation) titleInput.value = preFetchedLocation; else fetchLocation();
        }
        window.scrollTo(0, 0);
    }

    function handleImg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const width = 400; const height = img.height * (width / img.width);
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    currentImgBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('preview-container').innerHTML = `<img src="${currentImgBase64}">`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveToLibrary() {
        if (!currentImgBase64) { alert("ğŸ“· ì‚¬ì§„ì„ ë¨¼ì € ì°ê±°ë‚˜ ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }
        const titleInput = document.getElementById('saveTitle');
        const title = titleInput.value.trim();
        if (!title) { alert("ì €ì¥ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
        const ids = ['countryInput', 'ex', 'cost', 'margin', 'fixedPrice', 'shipType', 'w', 'x', 'y', 'z', 'local', 'pack', 'duty', 'buffer'];
        const values = {}; ids.forEach(id => { const el = document.getElementById(id); if(el) values[id] = el.value; });
        const now = new Date(); const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const dateStr = `${now.getFullYear().toString().slice(2)}.${now.getMonth()+1}.${now.getDate()}(${days[now.getDay()]}) ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        const item = { id: Date.now(), title: title, date: dateStr, img: currentImgBase64, data: values, lastField: lastField };
        let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        lib.unshift(item);
        localStorage.setItem('nanaLibrary', JSON.stringify(lib));
        renderLibrary();
        if (currentImgBase64 && navigator.share) {
            try {
                const blob = await (await fetch(currentImgBase64)).blob();
                const file = new File([blob], `ë‚˜ë‚˜_${title}.jpg`, { type: 'image/jpeg' });
                await navigator.share({ files: [file], title: 'ë‚˜ë‚˜ ê²°ê³¼ ì „ì†¡' });
            } catch (e) {}
        }
        titleInput.value = ""; document.getElementById('preview-container').innerHTML = "ë¯¸ë¦¬ë³´ê¸°"; currentImgBase64 = "";
        alert("ì „ì†¡ ì™„ë£Œ!");
    }

    function openModal(e, imgSrc) { e.stopPropagation(); document.getElementById('img-modal').style.display = "flex"; document.getElementById('modal-img').src = imgSrc; }
    function closeModal() { document.getElementById('img-modal').style.display = "none"; }

    function renderLibrary() {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const listContainer = document.getElementById('library-list');
        listContainer.innerHTML = lib.length ? "" : "<p style='text-align:center; color:#999; font-size:12px; margin-top:20px;'>ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>";
        lib.forEach(item => {
            const div = document.createElement('div'); div.className = 'library-item';
            div.onclick = () => loadItem(item.id);
            div.innerHTML = `<img src="${item.img || ''}" onclick="openModal(event, '${item.img}')">` +
                            `<div class="library-info"><div class="library-title">${item.title}</div>` +
                            `<div class="library-date">${item.date}</div></div>` +
                            `<div class="del-btn" onclick="deleteItem(event, ${item.id})">Ã—</div>`;
            listContainer.appendChild(div);
        });
    }

    function loadItem(id) {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const item = lib.find(i => i.id === id);
        if (item) {
            currentLoadedId = id;
            Object.keys(item.data).forEach(k => { const el = document.getElementById(k); if(el) el.value = item.data[k]; });
            lastField = item.lastField;
            document.getElementById('loaded-text').innerText = "ë¶ˆëŸ¬ì˜´: " + item.title;
            document.getElementById('loaded-container').style.display = "flex";
            saveInputs(); switchTab('calc'); doCalc();
        }
    }

    function unloadItem() { 
        currentLoadedId = null; 
        document.getElementById('loaded-container').style.display = "none"; 
        document.getElementById('loaded-text').innerText = "ë¶ˆëŸ¬ì˜´: ì—†ìŒ";
        saveInputs(); 
        doCalc(); 
    }

    function deleteItem(e, id) { e.stopPropagation(); if (confirm("ì‚­ì œí• ê¹Œìš”?")) { let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]"); lib = lib.filter(i => i.id !== id); localStorage.setItem('nanaLibrary', JSON.stringify(lib)); renderLibrary(); if(currentLoadedId === id) unloadItem(); } }

    window.onload = () => { loadInputs(); doCalc(); renderLibrary(); updateClock(); };
</script>
</body>
</html>
