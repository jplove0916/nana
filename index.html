<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</title>
    <style>
        /* [ì˜ì¥ë‹˜ ì „ìš© UI - ëƒ¥ëƒ¥ì´ ê¸°ì¤€ ì½”ë“œ 100% ì¤€ìˆ˜] */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; -webkit-font-smoothing: antialiased; touch-action: manipulation; }
        .nav-tabs { display: flex; width: 320px; margin-bottom: 15px; background: #e0e0e0; border-radius: 10px; padding: 5px; box-sizing: border-box; }
        .nav-tabs button { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; background: none; color: #666; transition: 0.3s; }
        .nav-tabs button.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content { display: none; width: 100%; max-width: 320px; }
        .tab-content.active { display: block; }
        .box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #2c3e50; position: relative; box-sizing: border-box; }
        
        .history-btns { position: absolute; top: 15px; left: 12px; display: flex; flex-direction: column; gap: 4px; z-index: 101; }
        .nav-btn { width: 28px; height: 28px; background: #ffffff; border: 1px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        .nav-btn:hover { background: #f0f2f5; border-color: #bbb; }
        .nav-btn:active { transform: scale(0.92); background: #e0e0e0; }
        .nav-btn:disabled { color: #ccc; cursor: default; background: #f9f9f9; }

        h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        .section-title { font-size: 11px; color: #27ae60; font-weight: bold; margin: 12px 0 6px 0; display: flex; align-items: center; }
        .section-title::before { content: "â—"; margin-right: 5px; font-size: 7px; }
        label { font-size: 10px; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; width: 100%; }
        
        .size-guide { font-size: 10px; color: #3498db; font-weight: bold; margin-left: 2px; }
        .req-dot { color: red; font-weight: bold; font-size: 26px; line-height: 1; visibility: visible; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 13px; background: #fff; transition: all 0.2s ease; color: #000; -webkit-font-smoothing: antialiased; font-weight: 500; }
        
        input[type="text"], input[type="number"] { -webkit-appearance: none; }
        select { font-weight: 700; color: #000; -webkit-appearance: none; }
        .search-input { border: 2px solid #2c3e50; background: #f9f9f9; font-weight: bold; }
        .dropdown-container { position: relative; }
        .custom-list { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #2c3e50; border-top: none; border-radius: 0 0 5px 5px; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .custom-list div { padding: 10px; font-size: 13px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; }
        
        .row { display: flex; gap: 6px; margin-bottom: 8px; align-items: flex-end; }
        .row div { flex: 1; min-width: 0; }
        .result { margin-top: 15px; padding: 12px; border-radius: 10px; display: none; transition: all 0.3s; border: 1px solid #ccc; }
        .mode-margin { background-color: #f0f7ff !important; border: 2px solid #3498db !important; }
        .mode-price { background-color: #fffdf0 !important; border: 2px solid #f1c40f !important; }
        .price-tag { font-size: 22px; font-weight: bold; color: #000; text-align: center; display: block; margin: 5px 0; word-break: break-all; }
        #fixedPriceInfo, #bepInfo { display: flex; flex-direction: column; align-items: flex-end; font-weight: bold; text-align: right; line-height: 1.3; }
        #fixedPriceInfo { font-size: 13px; margin-bottom: 5px; }
        #bepInfo { font-size: 13px; color: #e65100; }
        .price-sub { font-size: 13px; white-space: nowrap; }
        #resMarginInfo { text-align: center; font-size: 15px; font-weight: bold; margin-bottom: 8px; }
        #loaded-container { position: absolute; top: -10px; right: 5px; display: none; align-items: flex-start; background: #454d55; color: #f8f9fa; padding: 4px 10px; border-radius: 6px; z-index: 100; max-width: 170px; border: 1px solid #343a40; }
        #loaded-text { font-size: 11px; font-weight: 500; margin-right: 8px; word-break: break-all; white-space: normal; line-height: 1.1; }
        #close-loaded { cursor: pointer; font-size: 16px; font-weight: bold; line-height: 1; flex-shrink: 0; color: #adb5bd; margin-top: -2px; }
        
        #liveDetail { margin-top: 10px; padding: 10px; background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; font-size: 13px; color: #444; line-height: 1.6; display: none; }

        .save-box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #27ae60; box-sizing: border-box; }
        #live-clock { font-size: 13px; color: #1e8449; font-weight: 800; display: block; margin: -5px 0 15px 0; text-align: center; background: #eafaf1; padding: 4px; border-radius: 5px; border: 1px solid #27ae60; }
        
        #preview-container { width: 100%; min-height: 100px; border: 1px dashed #ccc; margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; border-radius: 5px; background: #fafafa; box-sizing: border-box; align-items: flex-start; }
        .thumb-box { position: relative; width: 60px; height: 60px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; background: #eee; }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-del { position: absolute; top: -2px; right: -2px; background: rgba(0,0,0,0.6); color: white; width: 18px; height: 18px; font-size: 12px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }

        .library-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; cursor: pointer; background: #fff; box-sizing: border-box; position: relative; min-height: 72px; }
        .library-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; margin-right: 10px; flex-shrink: 0; }
        .library-info { flex: 1; min-width: 0; }
        .library-title { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 3px; }
        .library-date { font-size: 10px; color: #999; }
        .check-wrapper { width: 35px; display: none; align-items: center; justify-content: center; flex-shrink: 0; margin-right: 5px; }
        .item-checkbox { width: 18px; height: 18px; cursor: pointer; appearance: none; -webkit-appearance: none; border: 2px solid #ccc; border-radius: 4px; background-color: #fff; position: relative; }
        .item-checkbox:checked { background-color: #3498db; border-color: #3498db; }
        .item-checkbox:checked::after { content: 'âœ”'; position: absolute; color: white; font-size: 12px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .unit-selector { display: flex; gap: 8px; align-items: center; background: #f8f9fa; padding: 2px 6px; border-radius: 4px; border: 1px solid #eee; margin-left: 10px; }
        .unit-selector input[type="radio"] { width: 13px; height: 13px; margin: 0; cursor: pointer; border: 1px solid #ccc; -webkit-appearance: radio !important; appearance: radio !important; }
        .unit-label { font-size: 9px; font-weight: bold; color: #555; cursor: pointer; margin-left: -4px; }

        /* [ì˜ì¥ë‹˜ ìš”ì²­: ë·°ì–´ ì „ìš© ìŠ¤íƒ€ì¼ - ìŠ¤ì™€ì´í”„ ì „ìš©] */
        #img-modal { display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); align-items:center; justify-content:center; touch-action: none; }
        #modal-img-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #modal-img { max-width:100%; max-height:100%; border-radius:4px; object-fit: contain; }
        .viewer-hint { position: absolute; bottom: 30px; color: #fff; font-size: 12px; opacity: 0.6; }
    </style>
</head>
<body>

<div id="img-modal" onclick="closeModal()">
    <div id="modal-img-container">
        <img id="modal-img" src="">
    </div>
    <div class="viewer-hint">ì¢Œìš°ë¡œ ìŠ¤ì™€ì´í”„í•˜ì—¬ ë„˜ê¸°ê¸°</div>
</div>

<div class="nav-tabs">
    <button id="tab-calc-btn" class="active" onclick="switchTab('calc')">ê³„ì‚°ê¸°</button>
    <button id="tab-lib-btn" onclick="switchTab('lib')">ìƒí’ˆ ì €ì¥ì†Œ</button>
</div>

<div id="tab-calc" class="tab-content active">
    <div class="box">
        <div class="history-btns">
            <button class="nav-btn" onclick="goBack()" title="ë’¤ë¡œê°€ê¸°">â®</button>
            <button class="nav-btn" onclick="goForward()" title="ì•ìœ¼ë¡œê°€ê¸°">â¯</button>
        </div>
        <div id="loaded-container"><span id="loaded-text">ë¶ˆëŸ¬ì˜´: ì—†ìŒ</span><span id="close-loaded" onclick="unloadItem()">Ã—</span></div>
        <h3>âš¡ ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</h3>
        <div class="row">
            <div style="flex: 1.4;" class="dropdown-container">
                <label><span>ëª©ì ì§€ êµ­ê°€ ê²€ìƒ‰</span><span id="dot_countryInput" class="req-dot">.</span></label>
                <input type="text" id="countryInput" class="search-input" value="ë¯¸êµ­ (USA)" onfocus="clearField(this)" oninput="filterList(); onInputChange();" autocomplete="off">
                <div id="customList" class="custom-list"></div>
            </div>
            <div>
                <label><span>ì ìš© í™˜ìœ¨</span><span id="dot_ex" class="req-dot">.</span></label>
                <input type="number" id="ex" value="1450" onfocus="clearField(this)" oninput="onInputChange()">
            </div>
        </div>
        <div class="section-title">ê¸°ë³¸ ìˆ˜ìµ ì„¤ì •</div>
        <div class="row">
            <div><label><span>ìƒí’ˆ ì›ê°€ <small>(ì›)</small></span><span id="dot_cost" class="req-dot">.</span></label><input type="number" id="cost" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label><span>í¬ë§ ë§ˆì§„ <small>(ì›)</small></span><span id="dot_margin" class="req-dot">.</span></label><input type="number" id="margin" value="0" onfocus="clearField(this, 'margin')" oninput="updateLast('margin'); onInputChange();"></div>
        </div>
        <div class="row">
            <div>
                <label style="display: flex; justify-content: flex-start; align-items: center;">
                    <span>í¬ë§ íŒë§¤ê°€</span>
                    <div class="unit-selector">
                        <input type="radio" id="unitKrw" name="priceUnit" value="krw" checked onclick="convertUnitPrice('krw')">
                        <label for="unitKrw" class="unit-label">ì›</label>
                        <input type="radio" id="unitUsd" name="priceUnit" value="usd" onclick="convertUnitPrice('usd')">
                        <label for="unitUsd" class="unit-label">ë‹¬ëŸ¬</label>
                    </div>
                </label>
                <input type="number" id="fixedPrice" onfocus="clearField(this, 'price')" oninput="updatePriceInput(this.value); onInputChange();">
            </div>
            <div style="flex: 1.1; display: flex; flex-direction: column; justify-content: flex-end;">
                <div id="fixedPriceInfo"></div>
                <div id="bepInfo"></div>
            </div>
        </div>
        <div class="section-title">ìƒí’ˆ ê·œê²© ë° ë°°ì†¡</div>
        <div class="row">
            <div style="flex: 1.2;"><label>ë°°ì†¡ íƒ€ì…</label><select id="shipType" onchange="onInputChange()"><option value="6000">ì¼ë°˜ (/6000)</option><option value="5000">íŠ¹ì†¡ (/5000)</option></select></div>
            <div><label><span>ë¬´ê²Œ<small>(kg)</small> <span id="boxGuide" class="size-guide"></span></span><span id="dot_w" class="req-dot">.</span></label><input type="number" id="w" step="0.01" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div class="row">
            <div><label>ê°€ë¡œ<small>(cm)</small></label><input type="number" id="x" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label>ì„¸ë¡œ<small>(cm)</small></label><input type="number" id="y" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label>ë†’ì´<small>(cm)</small></label><input type="number" id="z" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div id="liveDetail"></div>
        <div class="section-title">ê¸°íƒ€ ë¶€ìˆ˜ ë¹„ìš©</div>
        <div class="row">
            <div><label><span>êµ­ë‚´ ë°°ì†¡ë¹„ <small>(ì›)</small></span><span id="dot_local" class="req-dot">.</span></label><input type="number" id="local" value="3000" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label><span>í¬ì¥ë¹„ <small>(ì›)</small></span><span id="dot_pack" class="req-dot">.</span></label><input type="number" id="pack" value="1000" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div class="row">
            <div><label>ê´€ì„¸ <small>(ì›/ì„ íƒ)</small></label><input type="number" id="duty" placeholder="0" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label><span>ìˆ˜ìˆ˜ë£Œ ë²„í¼ <small>(%)</small></span><span id="dot_buffer" class="req-dot">.</span></label><input type="number" id="buffer" value="20" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div id="resultArea" class="result">
            <label id="resTitle" style="color:#2c3e50; display:block; text-align:center; font-size:11px; font-weight:bold;">ì´ë² ì´ íŒë§¤ê°€</label>
            <span id="resPrice" class="price-tag">$0.00</span>
            <div id="resMarginInfo"></div>
        </div>
    </div>
</div>

<div id="tab-lib" class="tab-content">
    <div class="save-box">
        <h3>ğŸ“ ìƒí’ˆ ì €ì¥ì†Œ</h3>
        <div id="live-clock"></div>
        <label>ìƒí’ˆ ì €ì¥ ì œëª©</label>
        <input type="text" id="saveTitle" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        <div id="preview-container">ì¤€ë¹„ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="btn-row" style="display:flex; gap:6px; margin-top:10px;">
            <button style="flex:1; padding:12px; background:#27ae60; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;" onclick="capturePhoto()">ğŸ“· ì‚¬ì§„ì°ê¸°</button>
            <button style="flex:1; padding:12px; background:#f0f2f5; color:#333; border:1px solid #ccc; border-radius:5px; font-weight:bold; cursor:pointer;" onclick="openGallery()">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬</button>
        </div>
        <button id="batch-save-btn" style="width:100%; margin-top:8px; padding:14px; background:#3498db; color:white; border:none; border-radius:5px; font-weight:800; cursor:pointer; display:none;" onclick="saveToLibrary()">ğŸ’¾ ì´ êµ¬ì„±ìœ¼ë¡œ ì €ì¥í•˜ê¸°</button>
        
        <input type="file" id="photoCamera" accept="image/*" capture="environment" style="display:none;" onchange="handleImg(this)">
        <input type="file" id="photoGallery" accept="image/*" style="display:none;" onchange="handleImg(this)">
        <hr style="margin:20px 0 10px 0; border:0; border-top:1px solid #eee;">
        <div class="lib-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <span style="font-size: 12px; font-weight: bold; color: #27ae60;">ì €ì¥ ëª©ë¡</span>
            <button id="edit-mode-btn" style="font-size: 12px; padding: 4px 10px; background: #eee; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold;" onclick="toggleEditMode()">í¸ì§‘</button>
        </div>
        <div id="library-list"></div>
    </div>
</div>

<script>
    const NATION_MAP = { "ë¯¸êµ­": "USA", "ë…ì¼": "DE", "í”„ë‘ìŠ¤": "FR", "í˜¸ì£¼": "AU", "ì˜êµ­": "GB", "ìºë‚˜ë‹¤": "CA", "ê·¸ë¦¬ìŠ¤": "GR", "ë„¤ëœë€ë“œ": "NL", "ë´ë§ˆí¬": "DK", "ë¼íŠ¸ë¹„ì•„": "LV", "ë£¨ë§ˆë‹ˆì•„": "RO", "ë£©ì…ˆë¶€ë¥´í¬": "LU", "ë¦¬íˆ¬ì•„ë‹ˆì•„": "LT", "ëª°íƒ€": "MT", "ë²¨ê¸°ì—": "BE", "ë¶ˆê°€ë¦¬ì•„": "BG", "ìŠ¤ì›¨ë´": "SE", "ìŠ¤í˜ì¸": "ES", "ìŠ¬ë¡œë°”í‚¤ì•„": "SK", "ìŠ¬ë¡œë² ë‹ˆì•„": "SI", "ì•„ì¼ëœë“œ": "IE", "ì—ìŠ¤í† ë‹ˆì•„": "EE", "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„": "AT", "ì´íƒˆë¦¬ì•„": "IT", "ì²´ì½”": "CZ", "í¬ë¡œì•„í‹°ì•„": "HR", "í‚¤í”„ë¡œìŠ¤": "CY", "í¬ë¥´íˆ¬ê°ˆ": "PT", "í´ë€ë“œ": "PL", "í•€ë€ë“œ": "FI", "í—ê°€ë¦¬": "HU" };
    const HIGHLIGHTS = ["ë¯¸êµ­", "ë…ì¼", "í”„ë‘ìŠ¤", "í˜¸ì£¼", "ì˜êµ­", "ìºë‚˜ë‹¤"];
    const RATES = { "GB": { step: 0.1, base: [5700,7000,8200,9400,10600,11900,13100,14300,15500,16700,18000,19200,20400,21600,22900,24100,25300,26500,27700,29000], overStep: 0.5, overFee: 6100 }, "USA": { step: 0.1, base: [7500,9100,10800,12500,14900,16200,17500,18800,20100,21400,23000,24300,25600,27200,28400,30200,31400,32700,34300,35500], overStep: 0.5, overFee: 6350 }, "CA": { step: 0.1, base: [7200,8300,10000,11300,12600,14400,15400,16500,17600,18600,20500,21600,22700,23700,24800,27800,28800,29900,31000,32000], overStep: 0.5, overFee: 5500 } /* ... ê¸°íƒ€ êµ­ê°€ ìš”ìœ¨í‘œ ìœ ì§€ ... */ };

    let currentImgStack = []; let currentLoadedId = null; let lastField = 'margin'; let lastBackup = null; let isEditMode = false;
    let historyStack = []; let futureStack = []; let isNavigating = false;
    let prevUnit = 'krw'; let preciseKrwValue = 0; 
    let modalImgIdx = 0; let modalImgList = [];
    let viewerStartX = 0;

    // [ì˜ì¥ë‹˜ ì „ìš© ìŠ¤ì™€ì´í”„ ë¡œì§ - 60px]
    let touchStartX = 0; let touchEndX = 0;
    document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
    document.addEventListener('touchend', e => { 
        touchEndX = e.changedTouches[0].screenX; 
        const diff = touchEndX - touchStartX;
        if (Math.abs(diff) > 60) {
            const currentTab = document.getElementById('tab-calc').classList.contains('active') ? 'calc' : 'lib';
            if (document.getElementById('img-modal').style.display === "flex") {
                if (diff < 0) changeModalImg(1); else changeModalImg(-1);
            } else {
                if (diff < 0 && currentTab === 'calc') switchTab('lib'); else if (diff > 0 && currentTab === 'lib') switchTab('calc');
            }
        }
    }, {passive: true});

    function capturePhoto() { document.getElementById('photoCamera').click(); }
    function openGallery() { document.getElementById('photoGallery').click(); }
    
    // [ì˜ì¥ë‹˜ ìš”ì²­: ì´¬ì˜ í›„ ë°”ë¡œ ë³µê·€í•˜ì—¬ ì—°ì† ì´¬ì˜ ì¤€ë¹„]
    function handleImg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const width = 400; canvas.width = width; canvas.height = img.height * (width / img.width);
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    const b64 = canvas.toDataURL('image/jpeg', 0.7);
                    currentImgStack.push(b64);
                    renderPreviews();
                    // ì´¬ì˜ ë²„íŠ¼ì„ ë‹¤ì‹œ í™œì„±í™”í•˜ì—¬ ë°”ë¡œ ë‹¤ìŒ ì‚¬ì§„ì„ ì°ì„ ìˆ˜ ìˆëŠ” ìƒíƒœ ìœ ì§€
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function renderPreviews() {
        const container = document.getElementById('preview-container');
        const saveBtn = document.getElementById('batch-save-btn');
        if (currentImgStack.length === 0) { container.innerHTML = "ì¤€ë¹„ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤"; saveBtn.style.display = "none"; return; }
        container.innerHTML = "";
        currentImgStack.forEach((img, idx) => {
            const box = document.createElement('div'); box.className = 'thumb-box';
            box.innerHTML = `<img src="${img}"><div class="thumb-del" onclick="removeThumb(${idx})">Ã—</div>`;
            container.appendChild(box);
        });
        saveBtn.style.display = "block";
    }

    function openModalWithList(e, list) {
        e.stopPropagation(); if(!list || list.length === 0) return;
        modalImgList = list; modalImgIdx = 0;
        showModalImg(); document.getElementById('img-modal').style.display = "flex";
    }
    
    function showModalImg() { 
        document.getElementById('modal-img').src = modalImgList[modalImgIdx]; 
    }

    function changeModalImg(dir) { 
        modalImgIdx += dir; 
        if(modalImgIdx < 0) modalImgIdx = modalImgList.length - 1; 
        if(modalImgIdx >= modalImgList.length) modalImgIdx = 0; 
        showModalImg(); 
    }

    function closeModal() { document.getElementById('img-modal').style.display = "none"; }

    // [ê¸°ì¡´ ê³„ì‚° ë¡œì§ ë° UI í•¸ë“¤ëŸ¬ - 1%ë„ ìˆ˜ì • ì—†ìŒ]
    function updateLocationAddress() {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&addressdetails=1`);
                const data = await res.json();
                if (data && data.address) {
                    const road = data.address.road || ""; const houseNumber = data.address.house_number || ""; const suburb = data.address.suburb || "";
                    let fullAddr = `${road} ${houseNumber} ${suburb} `.trim();
                    if(fullAddr) { const titleInput = document.getElementById('saveTitle'); if(!titleInput.value) titleInput.value = fullAddr; }
                }
            } catch (e) {}
        }, null, { enableHighAccuracy: true, timeout: 5000 });
    }

    function onInputChange() { if (!isNavigating) { const data = saveInputs(); historyStack.push(JSON.parse(JSON.stringify(data))); if (historyStack.length > 30) historyStack.shift(); futureStack = []; } doCalc(); }
    function updatePriceInput(val) { lastField = 'price'; const ex = parseFloat(document.getElementById('ex').value) || 1; const isUsd = document.getElementById('unitUsd').checked; const numVal = parseFloat(val) || 0; preciseKrwValue = isUsd ? numVal * ex : numVal; }
    function doCalc() {
        const exVal = parseFloat(document.getElementById('ex').value) || 0;
        const countryVal = document.getElementById('countryInput').value;
        const shipType = parseFloat(document.getElementById('shipType').value);
        const w = parseFloat(document.getElementById('w').value) || 0;
        const x = parseFloat(document.getElementById('x').value) || 0;
        const y = parseFloat(document.getElementById('y').value) || 0;
        const z = parseFloat(document.getElementById('z').value) || 0;
        const volW = Math.round((x * y * z / shipType) * 100) / 100;
        const finalW = Math.max(w, volW);
        const cost = parseFloat(document.getElementById('cost').value) || 0;
        const local = parseFloat(document.getElementById('local').value) || 0;
        const pack = parseFloat(document.getElementById('pack').value) || 0;
        const duty = parseFloat(document.getElementById('duty').value) || 0;
        const buffer = parseFloat(document.getElementById('buffer').value) || 0;
        
        let shipKrw = 0;
        let selectedCode = ""; for (let key in NATION_MAP) { if (countryVal.includes(key)) { selectedCode = NATION_MAP[key]; break; } }
        if (selectedCode && RATES[selectedCode]) {
            const data = RATES[selectedCode];
            if (finalW <= 2.0) shipKrw = data.base[Math.ceil(Math.round(finalW * 10) / 10 / data.step) - 1] || data.base[0];
            else shipKrw = data.base[data.base.length-1] + (Math.ceil((Math.round(finalW * 10) / 10 - 2.0) / data.overStep) * data.overFee);
        }

        const expenseSum = cost + local + pack + duty + shipKrw;
        const liveDetail = document.getElementById('liveDetail');
        if (finalW > 0) {
            liveDetail.innerHTML = `â€¢ ì ìš©ë¬´ê²Œ: <b>${finalW.toFixed(2)}kg</b> | ë°°ì†¡ë¹„: <b>${shipKrw.toLocaleString()}ì›</b><br>â€¢ ì§€ì¶œí•©ê³„: <b>${Math.round(expenseSum).toLocaleString()}ì›</b>`;
            liveDetail.style.display = 'block';
        }

        const bufferRate = (100 - buffer) / 100;
        const bepKrw = expenseSum / bufferRate;
        document.getElementById('bepInfo').innerHTML = `ë¶„ê¸°ì : $${(bepKrw/exVal).toFixed(2)} (${Math.round(bepKrw).toLocaleString()}ì›)`;

        if (lastField === 'margin') {
            const margin = parseFloat(document.getElementById('margin').value) || 0;
            const priceKrw = (expenseSum + margin) / bufferRate;
            document.getElementById('resPrice').innerText = `$${(priceKrw/exVal).toFixed(2)} (${Math.round(priceKrw).toLocaleString()}ì›)`;
            document.getElementById('resultArea').style.display = 'block';
        } else {
            const priceKrw = preciseKrwValue;
            const margin = (priceKrw * bufferRate) - expenseSum;
            document.getElementById('resMarginInfo').innerText = `ì˜ˆìƒ ë§ˆì§„: ${Math.round(margin).toLocaleString()}ì›`;
            document.getElementById('resultArea').style.display = 'block';
        }
    }

    function saveInputs() { const ids = ['countryInput', 'ex', 'cost', 'margin', 'fixedPrice', 'shipType', 'w', 'x', 'y', 'z', 'local', 'pack', 'buffer', 'duty']; const data = {}; ids.forEach(id => { data[id] = document.getElementById(id).value; }); return data; }
    function switchTab(tab) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active')); document.getElementById('tab-' + tab).classList.add('active'); document.getElementById('tab-' + tab + '-btn').classList.add('active'); if (tab === 'lib') { updateLocationAddress(); renderLibrary(); } else { doCalc(); } }
    function updateClock() { const now = new Date(); document.getElementById('live-clock').innerText = `ğŸ“… ${now.toLocaleDateString()} â° ${now.toLocaleTimeString()}`; }
    setInterval(updateClock, 1000);

    function renderLibrary() {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const listContainer = document.getElementById('library-list');
        listContainer.innerHTML = "";
        lib.forEach(item => {
            const div = document.createElement('div'); div.className = 'library-item';
            div.onclick = () => openModalWithList(event, item.imgList);
            const firstImg = item.imgList[0] || '';
            div.innerHTML = `<img src="${firstImg}"><div class="library-info"><div class="library-title">${item.title}</div><div class="library-date">${item.date} (${item.imgList.length}ì¥)</div></div>`;
            listContainer.appendChild(div);
        });
    }

    function saveToLibrary() {
        const title = document.getElementById('saveTitle').value || "ìƒˆ ìƒí’ˆ";
        const now = new Date();
        const item = { id: Date.now(), title: title, date: now.toLocaleString(), imgList: [...currentImgStack], data: saveInputs() };
        let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        lib.unshift(item);
        localStorage.setItem('nanaLibrary', JSON.stringify(lib));
        currentImgStack = []; renderPreviews(); document.getElementById('saveTitle').value = "";
    }

    window.onload = () => { updateClock(); doCalc(); };
</script>
</body>
</html>
