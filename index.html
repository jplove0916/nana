<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</title>
    <style>
        /* [ì˜ì¥ë‹˜ ì „ìš© UI - ëƒ¥ëƒ¥ì´ ê¸°ì¤€ ì½”ë“œ 100% ì¤€ìˆ˜] */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; -webkit-font-smoothing: antialiased; touch-action: pan-y; }
        .nav-tabs { display: flex; width: 320px; margin-bottom: 15px; background: #e0e0e0; border-radius: 10px; padding: 5px; box-sizing: border-box; }
        .nav-tabs button { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; background: none; color: #666; transition: 0.3s; }
        .nav-tabs button.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content { display: none; width: 100%; max-width: 320px; }
        .tab-content.active { display: block; }
        .box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #2c3e50; position: relative; box-sizing: border-box; }
        
        .history-btns { position: absolute; top: 15px; left: 12px; display: flex; flex-direction: column; gap: 4px; z-index: 101; }
        .nav-btn { 
            width: 28px; height: 28px; 
            background: #ffffff; border: 1px solid #ddd; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 12px; cursor: pointer; color: #2c3e50; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease;
        }
        .nav-btn:hover { background: #f0f2f5; border-color: #bbb; }
        .nav-btn:active { transform: scale(0.92); background: #e0e0e0; }
        .nav-btn:disabled { color: #ccc; cursor: default; background: #f9f9f9; }

        h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        .section-title { font-size: 11px; color: #27ae60; font-weight: bold; margin: 12px 0 6px 0; display: flex; align-items: center; }
        .section-title::before { content: "â—"; margin-right: 5px; font-size: 7px; }
        label { font-size: 10px; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; width: 100%; }
        
        .size-guide { font-size: 10px; color: #3498db; font-weight: bold; margin-left: 2px; }
        .req-dot { color: red; font-weight: bold; font-size: 26px; line-height: 1; visibility: visible; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 13px; background: #fff; transition: all 0.2s ease; color: #000; -webkit-font-smoothing: antialiased; font-weight: 500; }
        
        input[type="text"], input[type="number"] { -webkit-appearance: none; }
        
        select { font-weight: 700; color: #000; -webkit-appearance: none; }
        .search-input { border: 2px solid #2c3e50; background: #f9f9f9; font-weight: bold; }
        .dropdown-container { position: relative; }
        .custom-list { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #2c3e50; border-top: none; border-radius: 0 0 5px 5px; z-index: 1000; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .custom-list div { padding: 10px; font-size: 13px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; }
        .custom-list div.highlight-country { background-color: #eafaf1; font-weight: bold; }
        
        .row { display: flex; gap: 6px; margin-bottom: 8px; align-items: flex-end; }
        .row div { flex: 1; min-width: 0; }
        .result { margin-top: 15px; padding: 12px; border-radius: 10px; display: none; transition: all 0.3s; border: 1px solid #ccc; }
        .mode-margin { background-color: #f0f7ff !important; border: 2px solid #3498db !important; }
        .mode-price { background-color: #fffdf0 !important; border: 2px solid #f1c40f !important; }
        .price-tag { font-size: 22px; font-weight: bold; color: #000; text-align: center; display: block; margin: 5px 0; word-break: break-all; }
        .footer-note { margin-top: 15px; font-size: 10px; color: #777; line-height: 1.5; border-top: 1px solid #eee; padding-top: 12px; }
        #fixedPriceInfo, #bepInfo { display: flex; flex-direction: column; align-items: flex-end; font-weight: bold; text-align: right; line-height: 1.3; }
        #fixedPriceInfo { font-size: 13px; margin-bottom: 5px; }
        #bepInfo { font-size: 13px; color: #e65100; }
        .price-sub { font-size: 13px; white-space: nowrap; }
        #resMarginInfo { text-align: center; font-size: 15px; font-weight: bold; margin-bottom: 8px; }
        #loaded-container { position: absolute; top: -10px; right: 5px; display: none; align-items: flex-start; background: #454d55; color: #f8f9fa; padding: 4px 10px; border-radius: 6px; z-index: 100; max-width: 170px; border: 1px solid #343a40; }
        #loaded-text { font-size: 11px; font-weight: 500; margin-right: 8px; word-break: break-all; white-space: normal; line-height: 1.1; }
        #close-loaded { cursor: pointer; font-size: 16px; font-weight: bold; line-height: 1; flex-shrink: 0; color: #adb5bd; margin-top: -2px; }
        
        /* [ì˜ì¥ë‹˜ ìš”ì²­: ì‹¤ì‹œê°„ ë¬´ê²Œ/ë°°ì†¡ë¹„ ì •ë³´ì°½ ìŠ¤íƒ€ì¼] */
        #liveDetail { margin-top: 10px; padding: 10px; background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; font-size: 13px; color: #444; line-height: 1.6; display: none; }
        #liveDetail span { font-size: 13.5px; } /* í°íŠ¸ 1.3ë°° ìˆ˜ì¤€ ì¡°ì • */

        .save-box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #27ae60; box-sizing: border-box; }
        #live-clock { font-size: 13px; color: #1e8449; font-weight: 800; display: block; margin: -5px 0 15px 0; text-align: center; background: #eafaf1; padding: 4px; border-radius: 5px; border: 1px solid #27ae60; }
        .library-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; cursor: pointer; background: #fff; box-sizing: border-box; position: relative; min-height: 72px; }
        .library-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; margin-right: 10px; flex-shrink: 0; }
        .library-info { flex: 1; min-width: 0; }
        .library-title { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 3px; }
        .library-date { font-size: 10px; color: #999; }
        .check-wrapper { width: 35px; display: none; align-items: center; justify-content: center; flex-shrink: 0; margin-right: 5px; }
        .item-checkbox { width: 18px; height: 18px; cursor: pointer; appearance: none; -webkit-appearance: none; border: 2px solid #ccc; border-radius: 4px; background-color: #fff; position: relative; }
        .item-checkbox:checked { background-color: #3498db; border-color: #3498db; }
        .item-checkbox:checked::after { content: 'âœ”'; position: absolute; color: white; font-size: 12px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .unit-selector { display: flex; gap: 8px; align-items: center; background: #f8f9fa; padding: 2px 6px; border-radius: 4px; border: 1px solid #eee; margin-left: 10px; }
        .unit-selector input[type="radio"] { width: 13px; height: 13px; margin: 0; cursor: pointer; border: 1px solid #ccc; -webkit-appearance: radio !important; appearance: radio !important; }
        .unit-label { font-size: 9px; font-weight: bold; color: #555; cursor: pointer; margin-left: -4px; }
    </style>
</head>
<body>

<div id="img-modal" onclick="closeModal()" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); align-items:center; justify-content:center;"><img id="modal-img" src="" style="max-width:95%; max-height:85%; border-radius:8px;"></div>

<div class="nav-tabs">
    <button id="tab-calc-btn" class="active" onclick="switchTab('calc')">ê³„ì‚°ê¸°</button>
    <button id="tab-lib-btn" onclick="switchTab('lib')">ìƒí’ˆ ì €ì¥ì†Œ</button>
</div>

<div id="tab-calc" class="tab-content active">
    <div class="box">
        <div class="history-btns">
            <button class="nav-btn" onclick="goBack()" title="ë’¤ë¡œê°€ê¸°">â®</button>
            <button class="nav-btn" onclick="goForward()" title="ì•ìœ¼ë¡œê°€ê¸°">â¯</button>
        </div>

        <div id="loaded-container">
            <span id="loaded-text">ë¶ˆëŸ¬ì˜´: ì—†ìŒ</span>
            <span id="close-loaded" onclick="unloadItem()">Ã—</span>
        </div>
        <h3>âš¡ ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</h3>
        <div class="row">
            <div style="flex: 1.4;" class="dropdown-container">
                <label><span>ëª©ì ì§€ êµ­ê°€ ê²€ìƒ‰</span><span id="dot_countryInput" class="req-dot">.</span></label>
                <input type="text" id="countryInput" class="search-input" value="ë¯¸êµ­ (USA)" onfocus="clearField(this)" oninput="filterList(); onInputChange();" autocomplete="off">
                <div id="customList" class="custom-list"></div>
            </div>
            <div>
                <label><span>ì ìš© í™˜ìœ¨</span><span id="dot_ex" class="req-dot">.</span></label>
                <input type="number" id="ex" value="1450" onfocus="clearField(this)" oninput="onInputChange()">
            </div>
        </div>
        <div class="section-title">ê¸°ë³¸ ìˆ˜ìµ ì„¤ì •</div>
        <div class="row">
            <div><label><span>ìƒí’ˆ ì›ê°€ <small>(ì›)</small></span><span id="dot_cost" class="req-dot">.</span></label><input type="number" id="cost" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label><span>í¬ë§ ë§ˆì§„ <small>(ì›)</small></span><span id="dot_margin" class="req-dot">.</span></label><input type="number" id="margin" value="0" onfocus="clearField(this, 'margin')" oninput="updateLast('margin'); onInputChange();"></div>
        </div>
        <div class="row">
            <div>
                <label style="display: flex; justify-content: flex-start; align-items: center;">
                    <span>í¬ë§ íŒë§¤ê°€</span>
                    <div class="unit-selector">
                        <input type="radio" id="unitKrw" name="priceUnit" value="krw" checked onclick="convertUnitPrice('krw')">
                        <label for="unitKrw" class="unit-label">ì›</label>
                        <input type="radio" id="unitUsd" name="priceUnit" value="usd" onclick="convertUnitPrice('usd')">
                        <label for="unitUsd" class="unit-label">ë‹¬ëŸ¬</label>
                    </div>
                </label>
                <input type="number" id="fixedPrice" onfocus="clearField(this, 'price')" oninput="updatePriceInput(this.value); onInputChange();">
            </div>
            <div style="flex: 1.1; display: flex; flex-direction: column; justify-content: flex-end;">
                <div id="fixedPriceInfo"></div>
                <div id="bepInfo"></div>
            </div>
        </div>
        <div class="section-title">ìƒí’ˆ ê·œê²© ë° ë°°ì†¡</div>
        <div class="row">
            <div style="flex: 1.2;"><label>ë°°ì†¡ íƒ€ì…</label><select id="shipType" onchange="onInputChange()"><option value="6000">ì¼ë°˜ (/6000)</option><option value="5000">íŠ¹ì†¡ (/5000)</option></select></div>
            <div>
                <label>
                    <span>ë¬´ê²Œ<small>(kg)</small> <span id="boxGuide" class="size-guide"></span></span>
                    <span id="dot_w" class="req-dot">.</span>
                </label>
                <input type="number" id="w" step="0.01" onfocus="clearField(this)" oninput="onInputChange()">
            </div>
        </div>
        <div class="row">
            <div><label>ê°€ë¡œ<small>(cm)</small></label><input type="number" id="x" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label>ì„¸ë¡œ<small>(cm)</small></label><input type="number" id="y" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label>ë†’ì´<small>(cm)</small></label><input type="number" id="z" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        
        <div id="liveDetail"></div>

        <div class="section-title">ê¸°íƒ€ ë¶€ìˆ˜ ë¹„ìš©</div>
        <div class="row">
            <div><label><span>êµ­ë‚´ ë°°ì†¡ë¹„ <small>(ì›)</small></span><span id="dot_local" class="req-dot">.</span></label><input type="number" id="local" value="3000" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label><span>í¬ì¥ë¹„ <small>(ì›)</small></span><span id="dot_pack" class="req-dot">.</span></label><input type="number" id="pack" value="1000" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div class="row">
            <div><label>ê´€ì„¸ <small>(ì›/ì„ íƒ)</small></label><input type="number" id="duty" placeholder="0" onfocus="clearField(this)" oninput="onInputChange()"></div>
            <div><label><span>ìˆ˜ìˆ˜ë£Œ ë²„í¼ <small>(%)</small></span><span id="dot_buffer" class="req-dot">.</span></label><input type="number" id="buffer" value="20" onfocus="clearField(this)" oninput="onInputChange()"></div>
        </div>
        <div id="resultArea" class="result">
            <label id="resTitle" style="color:#2c3e50; display:block; text-align:center; font-size:11px; font-weight:bold;">ì´ë² ì´ íŒë§¤ê°€</label>
            <span id="resPrice" class="price-tag">$0.00</span>
            <div id="resMarginInfo"></div>
        </div>
        <div class="footer-note"><strong>* ì •ì‹ ìš”ìœ¨í‘œ ë¡œì§ ì ìš© ì™„ë£Œ</strong></div>
    </div>
</div>

<div id="tab-lib" class="tab-content">
    <div class="save-box">
        <h3>ğŸ“ ìƒí’ˆ ì €ì¥ì†Œ</h3>
        <div id="live-clock"></div>
        <label>ìƒí’ˆ ì €ì¥ ì œëª©</label>
        <input type="text" id="saveTitle" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        <div id="preview-container" style="width: 100%; height: 120px; border: 1px dashed #ccc; margin-top: 8px; display: flex; align-items: center; justify-content: center; border-radius: 5px; background: #fafafa; font-size: 12px; color: #999;">ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="btn-row" style="display:flex; gap:6px; margin-top:10px;">
            <button style="flex:1; padding:12px; background:#27ae60; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;" onclick="capturePhoto()">ğŸ“· ì‚¬ì§„ì°ê¸°</button>
            <button style="flex:1; padding:12px; background:#f0f2f5; color:#333; border:1px solid #ccc; border-radius:5px; font-weight:bold; cursor:pointer;" onclick="openGallery()">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬</button>
        </div>
        <input type="file" id="photoCamera" accept="image/*" capture="environment" style="display:none;" onchange="handleImg(this)">
        <input type="file" id="photoGallery" accept="image/*" style="display:none;" onchange="handleImg(this)">
        <hr style="margin:20px 0 10px 0; border:0; border-top:1px solid #eee;">
        <div class="lib-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <span style="font-size: 12px; font-weight: bold; color: #27ae60;">ì €ì¥ ëª©ë¡</span>
            <button id="edit-mode-btn" style="font-size: 12px; padding: 4px 10px; background: #eee; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold;" onclick="toggleEditMode()">í¸ì§‘</button>
        </div>
        <div id="multi-del-row" style="display:none; gap:6px; margin-bottom:10px;">
            <button style="background:#e74c3c; color:white; border:none; padding:6px 12px; border-radius:4px; font-size:12px; font-weight:bold; cursor:pointer; flex:1;" onclick="deleteSelected()">ì„ íƒ ì‚­ì œ</button>
            <button style="background:#95a5a6; color:white; border:none; padding:6px 12px; border-radius:4px; font-size:12px; font-weight:bold; cursor:pointer;" onclick="toggleEditMode()">ì·¨ì†Œ</button>
        </div>
        <div id="library-list"></div>
    </div>
</div>

<script>
    const NATION_MAP = { "ë¯¸êµ­": "USA", "ë…ì¼": "DE", "í”„ë‘ìŠ¤": "FR", "í˜¸ì£¼": "AU", "ì˜êµ­": "GB", "ìºë‚˜ë‹¤": "CA", "ê·¸ë¦¬ìŠ¤": "GR", "ë„¤ëœë€ë“œ": "NL", "ë´ë§ˆí¬": "DK", "ë¼íŠ¸ë¹„ì•„": "LV", "ë£¨ë§ˆë‹ˆì•„": "RO", "ë£©ì…ˆë¶€ë¥´í¬": "LU", "ë¦¬íˆ¬ì•„ë‹ˆì•„": "LT", "ëª°íƒ€": "MT", "ë²¨ê¸°ì—": "BE", "ë¶ˆê°€ë¦¬ì•„": "BG", "ìŠ¤ì›¨ë´": "SE", "ìŠ¤í˜ì¸": "ES", "ìŠ¬ë¡œë°”í‚¤ì•„": "SK", "ìŠ¬ë¡œë² ë‹ˆì•„": "SI", "ì•„ì¼ëœë“œ": "IE", "ì—ìŠ¤í† ë‹ˆì•„": "EE", "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„": "AT", "ì´íƒˆë¦¬ì•„": "IT", "ì²´ì½”": "CZ", "í¬ë¡œì•„í‹°ì•„": "HR", "í‚¤í”„ë¡œìŠ¤": "CY", "í¬ë¥´íˆ¬ê°ˆ": "PT", "í´ë€ë“œ": "PL", "í•€ë€ë“œ": "FI", "í—ê°€ë¦¬": "HU" };
    const HIGHLIGHTS = ["ë¯¸êµ­", "ë…ì¼", "í”„ë‘ìŠ¤", "í˜¸ì£¼", "ì˜êµ­", "ìºë‚˜ë‹¤"];
    const RATES = { "GB": { step: 0.1, base: [5700,7000,8200,9400,10600,11900,13100,14300,15500,16700,18000,19200,20400,21600,22900,24100,25300,26500,27700,29000], overStep: 0.5, overFee: 6100 }, "USA": { step: 0.1, base: [7500,9100,10800,12500,14900,16200,17500,18800,20100,21400,23000,24300,25600,27200,28400,30200,31400,32700,34300,35500], overStep: 0.5, overFee: 6350 }, "CA": { step: 0.1, base: [7200,8300,10000,11300,12600,14400,15400,16500,17600,18600,20500,21600,22700,23700,24800,27800,28800,29900,31000,32000], overStep: 0.5, overFee: 5500 }, "DE": { step: 0.5, base: [11700, 26100, 54300, 101000], overStep: 0.5, overFee: 4800 }, "FR": { step: 0.5, base: [12600, 29200, 61900, 114500], overStep: 0.5, overFee: 5500 }, "BE": { step: 0.5, base: [12100, 27400, 56000, 104000], overStep: 0.5, overFee: 5000 }, "IT": { step: 0.5, base: [14100, 31000, 67000, 122400], overStep: 0.5, overFee: 5800 }, "NL": { step: 0.5, base: [14200, 28300, 56200, 102700], overStep: 0.5, overFee: 4900 }, "GR": { step: 0.5, base: [12400, 33000, 78800, 146300], overStep: 0.5, overFee: 7000 }, "PL": { step: 0.5, base: [12500, 28500, 63600, 117000], overStep: 0.5, overFee: 5600 }, "ES": { step: 0.5, base: [11700, 29900, 64700, 123800], overStep: 0.5, overFee: 6000 }, "AT": { step: 0.5, base: [15300, 31700, 64300, 118800], overStep: 0.5, overFee: 5800 }, "FI": { step: 0.5, base: [20200, 38800, 77700, 140500], overStep: 0.5, overFee: 6800 }, "IE": { step: 0.5, base: [14500, 32300, 67700, 126500], overStep: 0.5, overFee: 6200 }, "SE": { step: 0.5, base: [15500, 34000, 69600, 128900], overStep: 0.5, overFee: 6200 }, "DK": { step: 0.5, base: [14600, 29500, 59300, 109000], overStep: 0.5, overFee: 5200 }, "CZ": { step: 0.5, base: [14000, 31600, 65200, 120300], overStep: 0.5, overFee: 5800 }, "HU": { step: 0.5, base: [11600, 28500, 62500, 119100], overStep: 0.5, overFee: 6000 }, "RO": { step: 0.5, base: [11800, 28900, 63400, 119000], overStep: 0.5, overFee: 5800 }, "SK": { step: 0.5, base: [11800, 25200, 51900, 96600], overStep: 0.5, overFee: 4800 }, "SI": { step: 0.5, base: [22600, 40000, 74800, 132800], overStep: 0.5, overFee: 6200 } };

    let currentImgBase64 = ""; let currentLoadedId = null; let lastField = 'margin'; let lastBackup = null; let isEditMode = false;
    let historyStack = []; let futureStack = []; let isNavigating = false;
    let prevUnit = 'krw'; let preciseKrwValue = 0; 
    
    // [ì˜ì¥ë‹˜ ì§€ì‹œ: ìŠ¤ë§ˆíŠ¸ ì¡°ì‘ ê°ì§€ - í™•ëŒ€ ì‹œ ìŠ¤ì™€ì´í”„ ì°¨ë‹¨ & ì„ê³„ê°’ 60px]
    let touchStartX = 0; let touchEndX = 0; const swipeThreshold = 60; 
    document.addEventListener('touchstart', e => { 
        if (e.touches.length > 1) { touchStartX = 0; return; }
        touchStartX = e.changedTouches[0].screenX; 
    }, {passive: true});
    
    document.addEventListener('touchend', e => { 
        if (touchStartX === 0) return;
        touchEndX = e.changedTouches[0].screenX; 
        
        const currentZoom = (window.visualViewport) ? window.visualViewport.scale : 1;
        if (currentZoom <= 1.05) { handleSwipe(); }
    }, {passive: true});

    function handleSwipe() {
        const diff = touchEndX - touchStartX;
        const currentTab = document.getElementById('tab-calc').classList.contains('active') ? 'calc' : 'lib';
        if (Math.abs(diff) > swipeThreshold) {
            if (diff < 0 && currentTab === 'calc') { switchTab('lib'); } 
            else if (diff > 0 && currentTab === 'lib') { switchTab('calc'); }
        }
    }

    function updateLocationAddress() {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&addressdetails=1`);
                const data = await res.json();
                if (data && data.address) {
                    const road = data.address.road || ""; const houseNumber = data.address.house_number || ""; const suburb = data.address.suburb || "";
                    let fullAddr = `${road} ${houseNumber} ${suburb} `.trim();
                    if(fullAddr) { const titleInput = document.getElementById('saveTitle'); if(!titleInput.value) titleInput.value = fullAddr; }
                }
            } catch (e) {}
        }, null, { enableHighAccuracy: true, timeout: 5000 });
    }

    function updateBoxGuide() {
        const w = parseFloat(document.getElementById('w').value) || 0;
        const div = parseFloat(document.getElementById('shipType').value) || 6000;
        const guideEl = document.getElementById('boxGuide');
        if (w > 0) { const maxVol = w * div; const side = Math.pow(maxVol, 1/3); const totalSum = Math.floor(side * 3); guideEl.innerText = `[í¬ê¸°: ${totalSum}cm]`; } else { guideEl.innerText = ""; }
    }

    function onInputChange() {
        if (!isNavigating) {
            const data = saveInputs();
            if (historyStack.length === 0 || JSON.stringify(historyStack[historyStack.length-1]) !== JSON.stringify(data)) {
                historyStack.push(JSON.parse(JSON.stringify(data)));
                if (historyStack.length > 30) historyStack.shift();
                futureStack = []; 
            }
        }
        doCalc();
    }

    function updatePriceInput(val) { lastField = 'price'; const ex = parseFloat(document.getElementById('ex').value) || 1; const isUsd = document.getElementById('unitUsd').checked; const numVal = parseFloat(val) || 0; if (isUsd) { preciseKrwValue = numVal * ex; } else { preciseKrwValue = numVal; } }
    function convertUnitPrice(newUnit) { if (prevUnit === newUnit) return; const priceInput = document.getElementById('fixedPrice'); const ex = parseFloat(document.getElementById('ex').value) || 1; if (preciseKrwValue > 0) { if (newUnit === 'usd') { priceInput.value = (preciseKrwValue / ex).toFixed(2); } else { priceInput.value = Math.round(preciseKrwValue); } lastField = 'price'; } prevUnit = newUnit; onInputChange(); }

    function applyState(state) {
        Object.keys(state).forEach(k => {
            const el = document.getElementById(k);
            if(el) { if(el.type === 'radio') { if(el.value === state[k]) { el.checked = true; if(k === 'priceUnit') prevUnit = state[k]; } } else { el.value = state[k]; } }
            if(k === 'lastField') lastField = state[k];
        });
        const ex = parseFloat(state['ex']) || 1; const isUsd = state['priceUnit'] === 'usd'; const fp = parseFloat(state['fixedPrice']) || 0;
        preciseKrwValue = isUsd ? fp * ex : fp; localStorage.setItem('nanaCalcData', JSON.stringify(state)); doCalc();
    }

    function goBack() { if (historyStack.length > 1) { isNavigating = true; const current = historyStack.pop(); futureStack.push(current); applyState(historyStack[historyStack.length - 1]); isNavigating = false; } else { switchTab('lib'); } }
    function goForward() { if (futureStack.length > 0) { isNavigating = true; const nextState = futureStack.pop(); historyStack.push(nextState); applyState(nextState); isNavigating = false; } }

    function doCalc() {
        updateBoxGuide();
        const marginInput = document.getElementById('margin'); const priceInput = document.getElementById('fixedPrice');
        const exInput = document.getElementById('ex'); const countryInput = document.getElementById('countryInput');
        const packInput = document.getElementById('pack'); const resultArea = document.getElementById('resultArea');
        const fInfo = document.getElementById('fixedPriceInfo'); const bInfo = document.getElementById('bepInfo');
        const liveDetail = document.getElementById('liveDetail');

        let selectedCode = ""; for (let key in NATION_MAP) { if (countryInput.value.includes(key)) { selectedCode = NATION_MAP[key]; break; } }
        document.getElementById('dot_countryInput').style.visibility = !selectedCode ? "visible" : "hidden";
        const exValRaw = exInput.value.trim(); const ex = parseFloat(exValRaw); const isExEmpty = (exValRaw === "" || isNaN(ex) || ex <= 0);
        document.getElementById('dot_ex').style.visibility = isExEmpty ? "visible" : "hidden";
        document.getElementById('dot_pack').style.visibility = (packInput.value.trim() === "") ? "visible" : "hidden";
        ['cost', 'w', 'local', 'buffer'].forEach(id => {
            const input = document.getElementById(id); const dot = document.getElementById('dot_' + id);
            const val = input.value.trim(); let isInvalid = (id === 'w') ? (val === "" || parseFloat(val) <= 0) : (val === "");
            dot.style.visibility = isInvalid ? "visible" : "hidden";
        });
        const hasRevenueInput = (marginInput.value.trim() !== "" || priceInput.value.trim() !== "");
        document.getElementById('dot_margin').style.visibility = !hasRevenueInput ? "visible" : "hidden";
        
        if (!selectedCode || isExEmpty) { resultArea.style.display = 'none'; fInfo.innerHTML = ''; bInfo.innerHTML = ''; liveDetail.style.display = 'none'; return; }
        
        const div = parseFloat(document.getElementById('shipType').value) || 6000;
        const cost = parseFloat(document.getElementById('cost').value) || 0;
        const local = parseFloat(document.getElementById('local').value) || 0;
        const pack = parseFloat(packInput.value) || 0;
        const buffer = parseFloat(document.getElementById('buffer').value) || 0;
        const duty = parseFloat(document.getElementById('duty').value) || 0;
        const w = parseFloat(document.getElementById('w').value) || 0;
        const x = parseFloat(document.getElementById('x').value) || 0;
        const y = parseFloat(document.getElementById('y').value) || 0;
        const z = parseFloat(document.getElementById('z').value) || 0;
        const volW = Math.round((x * y * z / div) * 100) / 100;
        const finalW = Math.max(w, volW); const data = RATES[selectedCode];
        
        let shipKrw = (finalW <= 2.0) ? (data.base[Math.ceil(Math.round(finalW * 10) / 10 / data.step) - 1] || data.base[0]) : (data.base[data.base.length-1] + (Math.ceil((Math.round(finalW * 10) / 10 - 2.0) / data.overStep) * data.overFee));
        const bufferRate = (100 - buffer) / 100; const expenseSum = cost + local + pack + duty + shipKrw; const bepKrw = (expenseSum / bufferRate);
        
        // [ì˜ì¥ë‹˜ ìš”ì²­: ì‹¤ì‹œê°„ ì¤‘ëŸ‰ ë¹„êµ ìƒ‰ìƒ ê°•ì¡°]
        const wColor = (w >= volW) ? "color:#27ae60; font-weight:bold;" : "color:#444;";
        const volColor = (volW > w) ? "color:#27ae60; font-weight:bold;" : "color:#444;";
        
        liveDetail.innerHTML = `
            <span>â€¢ ì‹¤ì¤‘ëŸ‰: <span style="${wColor}">${w.toFixed(2)}kg</span> / ë¶€í”¼ë¬´ê²Œ: <span style="${volColor}">${volW.toFixed(2)}kg</span></span><br>
            <span>â€¢ ë°°ì†¡ë¹„: <b>${shipKrw.toLocaleString()}ì›</b> / ì§€ì¶œí•©ê³„: <b>${Math.round(expenseSum).toLocaleString()}ì›</b></span>
        `;
        liveDetail.style.display = 'block';

        if (!hasRevenueInput) { resultArea.style.display = 'none'; fInfo.innerHTML = ''; bInfo.innerHTML = ''; return; }

        const marginVal = parseFloat(marginInput.value) || 0; const fixedPriceVal = preciseKrwValue;
        let finalPriceKrw = (lastField === 'price' && fixedPriceVal > 0) ? fixedPriceVal : (expenseSum + marginVal) / bufferRate;
        let actualMargin = (lastField === 'price' && fixedPriceVal > 0) ? (fixedPriceVal * bufferRate) - expenseSum : marginVal;
        const marginColor = (actualMargin < 0) ? "#d32f2f" : "#2e7d32"; const marginText = (actualMargin < 0) ? "ì†í•´" : "ì˜ˆìƒ ë§ˆì§„";
        
        document.getElementById('resMarginInfo').style.color = marginColor;
        document.getElementById('resMarginInfo').innerText = `${marginText}: $${(actualMargin / ex).toFixed(2)} (${Math.round(actualMargin).toLocaleString()}ì›)`;
        fInfo.style.color = marginColor;
        fInfo.innerHTML = lastField === 'price' ? `<span>${marginText}: $${(actualMargin / ex).toFixed(2)}</span><span class="price-sub">(${Math.round(actualMargin).toLocaleString()}ì›)</span>` : `<span>ì˜ˆìƒ íŒë§¤ê°€: $${(finalPriceKrw / ex).toFixed(2)}</span><span class="price-sub">(${Math.round(finalPriceKrw).toLocaleString()}ì›)</span>`;
        bInfo.innerHTML = `<span>ë¶„ê¸°ì : $${(bepKrw/ex).toFixed(2)}</span><span class="price-sub">(${Math.round(bepKrw).toLocaleString()}ì›)</span>`;
        document.getElementById('resPrice').innerText = "$" + (finalPriceKrw / ex).toFixed(2) + " (" + Math.round(finalPriceKrw).toLocaleString() + "ì›)";
        marginInput.classList.toggle('mode-margin', lastField === 'margin'); priceInput.classList.toggle('mode-price', lastField === 'price');
        resultArea.className = 'result ' + (lastField === 'margin' ? 'mode-margin' : 'mode-price'); resultArea.style.display = 'block';
    }

    function saveInputs() { const ids = ['countryInput', 'ex', 'cost', 'margin', 'fixedPrice', 'shipType', 'w', 'x', 'y', 'z', 'local', 'pack', 'buffer', 'duty']; const data = {}; ids.forEach(id => { const el = document.getElementById(id); if(el) data[id] = el.value; }); const unitEl = document.querySelector('input[name="priceUnit"]:checked'); data['priceUnit'] = unitEl ? unitEl.value : 'krw'; data['lastField'] = lastField; data['currentLoadedId'] = currentLoadedId; localStorage.setItem('nanaCalcData', JSON.stringify(data)); return data; }
    function loadInputs() { const saved = localStorage.getItem('nanaCalcData'); if (saved) { const data = JSON.parse(saved); applyState(data); if (data.currentLoadedId) { const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]"); const item = lib.find(i => i.id === data.currentLoadedId); if(item) { document.getElementById('loaded-text').innerText = "ë¶ˆëŸ¬ì˜´: " + item.title; document.getElementById('loaded-container').style.display = "flex"; currentLoadedId = data.currentLoadedId; } } } }
    function switchTab(tab) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active')); document.getElementById('tab-' + tab).classList.add('active'); document.getElementById('tab-' + tab + '-btn').classList.add('active'); if (tab === 'lib') { isEditMode = false; updateLocationAddress(); renderLibrary(); } else { loadInputs(); doCalc(); } }
    function updateClock() { const now = new Date(); const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ']; const clockEl = document.getElementById('live-clock'); if(clockEl) clockEl.innerHTML = `ğŸ“… ${now.toLocaleDateString()} (${days[now.getDay()]}) &nbsp; â° ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`; }
    setInterval(updateClock, 1000);
    function clearField(el, type) { el.value = ''; if (type) lastField = type; if (type === 'price') preciseKrwValue = 0; if (el.id === 'countryInput') showList(); onInputChange(); }
    function showList() { const listEl = document.getElementById('customList'); listEl.innerHTML = ''; Object.keys(NATION_MAP).forEach(name => { const div = document.createElement('div'); div.innerText = `${name} (${NATION_MAP[name]})`; if (HIGHLIGHTS.includes(name)) div.classList.add('highlight-country'); div.onclick = () => { document.getElementById('countryInput').value = div.innerText; listEl.style.display = 'none'; onInputChange(); }; listEl.appendChild(div); }); listEl.style.display = 'block'; }
    function filterList() { const val = document.getElementById('countryInput').value.toLowerCase(); const items = document.getElementById('customList').querySelectorAll('div'); items.forEach(item => { item.style.display = item.innerText.toLowerCase().includes(val) ? 'block' : 'none'; }); }
    document.addEventListener('click', (e) => { if (!e.target.closest('.dropdown-container')) document.getElementById('customList').style.display = 'none'; });
    function updateLast(type) { lastField = type; onInputChange(); }
    function capturePhoto() { document.getElementById('photoCamera').click(); }
    function openGallery() { document.getElementById('photoGallery').click(); }
    function handleImg(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const width = 400; canvas.width = width; canvas.height = img.height * (width / img.width); canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height); currentImgBase64 = canvas.toDataURL('image/jpeg', 0.7); document.getElementById('preview-container').innerHTML = `<img src="${currentImgBase64}" style="height:100%;">`; saveToLibrary(); }; img.src = e.target.result; }; reader.readAsDataURL(input.files[0]); } }
    function saveToLibrary() { const title = document.getElementById('saveTitle').value.trim() || "ìƒˆ ìƒí’ˆ"; const now = new Date(); const dateStr = `${now.getFullYear().toString().slice(2)}.${now.getMonth()+1}.${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`; const item = { id: Date.now(), title: title, date: dateStr, img: currentImgBase64, data: saveInputs(), lastField: lastField }; let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]"); lib.unshift(item); localStorage.setItem('nanaLibrary', JSON.stringify(lib)); renderLibrary(); document.getElementById('saveTitle').value = ""; document.getElementById('preview-container').innerHTML = "ë¯¸ë¦¬ë³´ê¸°"; currentImgBase64 = ""; }
    function renderLibrary() { const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]"); const listContainer = document.getElementById('library-list'); listContainer.innerHTML = lib.length ? "" : "<p style='text-align:center; color:#999; font-size:12px; margin-top:20px;'>ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>"; lib.forEach(item => { const div = document.createElement('div'); div.className = 'library-item'; div.onclick = (e) => { if(!isEditMode) loadItem(item.id); else { const cb = div.querySelector('.item-checkbox'); if(e.target !== cb) cb.checked = !cb.checked; } }; const displayStyle = isEditMode ? 'flex' : 'none'; div.innerHTML = `<div class="check-wrapper" style="display:${displayStyle}"><input type="checkbox" class="item-checkbox" value="${item.id}" onclick="event.stopPropagation()"></div><img src="${item.img || ''}" onclick="openModal(event, '${item.img}')"><div class="library-info"><div class="library-title">${item.title}</div><div class="library-date">${item.date}</div></div><div style="display:${isEditMode ? 'none' : 'flex'}; gap:5px;"><button style="background:#fee500; color:#3c1e1e; border:none; padding:6px 8px; border-radius:4px; font-size:11px; font-weight:bold; cursor:pointer;" onclick="shareSNS(event, ${item.id})">SNS</button><div style="color:#ccc; font-size:18px; cursor:pointer; padding:0 5px;" onclick="deleteItem(event, ${item.id})">Ã—</div></div>`; listContainer.appendChild(div); }); }
    function loadItem(id) { const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]"); const item = lib.find(i => i.id === id); if (item) { if (!currentLoadedId) lastBackup = saveInputs(); currentLoadedId = id; applyState(item.data); lastField = item.lastField || 'margin'; document.getElementById('loaded-text').innerText = "ë¶ˆëŸ¬ì˜´: " + item.title; document.getElementById('loaded-container').style.display = "flex"; onInputChange(); switchTab('calc'); } }
    function unloadItem() { currentLoadedId = null; document.getElementById('loaded-container').style.display = "none"; if (lastBackup) { applyState(lastBackup); lastBackup = null; } onInputChange(); }
    function deleteItem(e, id) { e.stopPropagation(); if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]"); lib = lib.filter(i => i.id !== id); localStorage.setItem('nanaLibrary', JSON.stringify(lib)); renderLibrary(); } }
    function toggleEditMode() { isEditMode = !isEditMode; document.getElementById('edit-mode-btn').style.display = isEditMode ? 'none' : 'block'; document.getElementById('multi-del-row').style.display = isEditMode ? 'flex' : 'none'; renderLibrary(); }
    function deleteSelected() { const selected = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => parseInt(cb.value)); if (selected.length === 0) return; if (confirm(`${selected.length}ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]"); lib = lib.filter(item => !selected.includes(item.id)); localStorage.setItem('nanaLibrary', JSON.stringify(lib)); toggleEditMode(); } }
    async function shareSNS(e, id) { e.stopPropagation(); const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]"); const item = lib.find(i => i.id === id); if (item && item.img && navigator.share) { try { const blob = await (await fetch(item.img)).blob(); const file = new File([blob], `nana_${item.title}.jpg`, { type: 'image/jpeg' }); await navigator.share({ files: [file], title: 'ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°', text: `ìƒí’ˆëª…: ${item.title}` }); } catch (err) {} } else alert("ê³µìœ  ë¯¸ì§€ì› í™˜ê²½ì…ë‹ˆë‹¤."); }
    function openModal(e, src) { e.stopPropagation(); document.getElementById('img-modal').style.display = "flex"; document.getElementById('modal-img').src = src; }
    function closeModal() { document.getElementById('img-modal').style.display = "none"; }
    window.onload = () => { loadInputs(); updateClock(); onInputChange(); };
</script>
</body>
</html>
