<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</title>
    <style>
        /* [ì˜ì¥ë‹˜ ì „ìš© UI - ëƒ¥ëƒ¥ì´ ê¸°ì¤€ ì½”ë“œ 100% ì¤€ìˆ˜] */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; -webkit-font-smoothing: antialiased; touch-action: manipulation; }
        .nav-tabs { display: flex; width: 320px; margin-bottom: 15px; background: #e0e0e0; border-radius: 10px; padding: 5px; box-sizing: border-box; }
        .nav-tabs button { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; background: none; color: #666; transition: 0.3s; }
        .nav-tabs button.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content { display: none; width: 100%; max-width: 320px; }
        .tab-content.active { display: block; }
        .box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #2c3e50; position: relative; box-sizing: border-box; }
        
        /* ì´¬ì˜ìš© ì‹¤ì‹œê°„ ë·°íŒŒì¸ë” */
        #camera-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
        #camera-video { width: 100%; max-height: 70%; object-fit: cover; }
        .camera-controls { width: 100%; display: flex; justify-content: space-around; align-items: center; padding: 20px 0; background: rgba(0,0,0,0.8); }
        .shutter-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 5px solid #ccc; cursor: pointer; }
        .close-camera { color: white; font-size: 16px; cursor: pointer; font-weight: bold; }

        /* ì´ë¯¸ì§€ ëª¨ë‹¬ (í™•ëŒ€/ì‚­ì œ/íˆìŠ¤í† ë¦¬ ëŒ€ì‘) */
        #img-modal { display:none; position:fixed; z-index:11000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); align-items:center; justify-content:center; flex-direction:column; touch-action: none; overflow: hidden; }
        #modal-img-container { width: 100%; height: 80%; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        #modal-img { max-width: 95%; max-height: 100%; border-radius: 4px; object-fit: contain; transition: transform 0.1s ease-out; transform-origin: center; cursor: grab; }
        .modal-ui { position: absolute; z-index: 11001; color: white; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        .modal-del { top: 20px; right: 20px; color: #ff4d4d; }
        .modal-close { top: 20px; left: 20px; color: #fff; }
        .swipe-hint { position: absolute; bottom: 40px; color: rgba(255,255,255,0.6); font-size: 11px; width: 100%; text-align: center; pointer-events: none; }

        /* SNS ê³µìœ  ì„ íƒ ëª¨ë‹¬ */
        #share-modal { display:none; position:fixed; z-index:12000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
        .share-box { background: white; width: 300px; padding: 20px; border-radius: 12px; max-height: 80%; overflow-y: auto; }
        .share-img-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .share-img-item { position: relative; aspect-ratio: 1; border: 2px solid transparent; border-radius: 4px; overflow: hidden; }
        .share-img-item.selected { border-color: #3498db; }
        .share-img-item img { width: 100%; height: 100%; object-fit: cover; }
        .share-check { position: absolute; top: 2px; right: 2px; background: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; }

        /* ê¸°ì¡´ UI ìœ ì§€ */
        .history-btns { position: absolute; top: 15px; left: 12px; display: flex; flex-direction: column; gap: 4px; z-index: 101; }
        .nav-btn { width: 28px; height: 28px; background: #ffffff; border: 1px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { text-align: center; color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        .section-title { font-size: 11px; color: #27ae60; font-weight: bold; margin: 12px 0 6px 0; display: flex; align-items: center; }
        .req-dot { color: red; font-weight: bold; font-size: 26px; line-height: 1; visibility: visible; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 13px; color: #000; font-weight: 500; }
        .row { display: flex; gap: 6px; margin-bottom: 8px; align-items: flex-end; }
        .result { margin-top: 15px; padding: 12px; border-radius: 10px; display: none; border: 1px solid #ccc; }
        .price-tag { font-size: 22px; font-weight: bold; color: #000; text-align: center; display: block; margin: 5px 0; }
        
        .save-box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 6px solid #27ae60; box-sizing: border-box; }
        #preview-container { width: 100%; min-height: 100px; border: 1px dashed #ccc; margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; border-radius: 5px; background: #fafafa; }
        .thumb-box { position: relative; width: 60px; height: 60px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; }
        .library-item { border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; background: #fff; position: relative; }
        .library-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; margin-right: 10px; }
        .library-info { flex: 1; }
    </style>
</head>
<body>

<div id="camera-overlay">
    <video id="camera-video" autoplay playsinline></video>
    <div class="camera-controls">
        <span class="close-camera" onclick="stopCamera()">ë‹«ê¸°</span>
        <div class="shutter-btn" onclick="takePhoto()"></div>
        <span style="color:white; font-size:12px;" id="shot-count">0ì¥ ì´¬ì˜ë¨</span>
    </div>
</div>

<div id="img-modal">
    <div class="modal-ui modal-close" onclick="closeModal()">âœ•</div>
    <div class="modal-ui modal-del" onclick="deleteSinglePhoto()">ğŸ—‘</div>
    <div id="modal-img-container">
        <img id="modal-img" src="">
    </div>
    <div class="swipe-hint">â† ì¢Œìš° ìŠ¤ì™€ì´í”„ / ë‘ ì†ê°€ë½ í™•ëŒ€ â†’</div>
</div>

<div id="share-modal">
    <div class="share-box">
        <h4 style="margin:0 0 10px 0; text-align:center;">ê³µìœ í•  ì‚¬ì§„ ì„ íƒ</h4>
        <div id="share-img-grid" class="share-img-grid"></div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button style="flex:1; padding:10px; border:none; border-radius:5px;" onclick="closeShareModal()">ì·¨ì†Œ</button>
            <button style="flex:1; padding:10px; background:#3498db; color:white; border:none; border-radius:5px; font-weight:bold;" onclick="executeShare()">ê³µìœ í•˜ê¸°</button>
        </div>
    </div>
</div>

<div class="nav-tabs">
    <button id="tab-calc-btn" class="active" onclick="switchTab('calc')">ê³„ì‚°ê¸°</button>
    <button id="tab-lib-btn" onclick="switchTab('lib')">ìƒí’ˆ ì €ì¥ì†Œ</button>
</div>

<div id="tab-calc" class="tab-content active">
    <div class="box">
        <div class="history-btns">
            <button class="nav-btn" onclick="goBack()">â®</button>
            <button class="nav-btn" onclick="goForward()">â¯</button>
        </div>
        <div id="loaded-container" style="display:none;"><span id="loaded-text"></span><span onclick="unloadItem()">Ã—</span></div>
        <h3>âš¡ ë‚˜ë‚˜ í†µí•© ê³„ì‚°ê¸°</h3>
        <div class="row">
            <div style="flex: 1.4;">
                <label>êµ­ê°€ ê²€ìƒ‰ <span id="dot_countryInput" class="req-dot">.</span></label>
                <input type="text" id="countryInput" class="search-input" value="ë¯¸êµ­ (USA)" onfocus="this.value=''" oninput="filterList(); onInputChange();">
                <div id="customList" class="custom-list" style="display:none; position:absolute; background:white; z-index:1000; border:1px solid #ccc; width:180px;"></div>
            </div>
            <div>
                <label>í™˜ìœ¨ <span id="dot_ex" class="req-dot">.</span></label>
                <input type="number" id="ex" value="1450" oninput="onInputChange()">
            </div>
        </div>
        <div class="section-title">ê¸°ë³¸ ìˆ˜ìµ ì„¤ì •</div>
        <div class="row">
            <div><label>ì›ê°€ <span id="dot_cost" class="req-dot">.</span></label><input type="number" id="cost" oninput="onInputChange()"></div>
            <div><label>ë§ˆì§„ <span id="dot_margin" class="req-dot">.</span></label><input type="number" id="margin" value="0" oninput="updateLast('margin'); onInputChange();"></div>
        </div>
        <div class="row">
            <div style="flex:1.5;"><label>íŒë§¤ê°€(ì›/ë‹¬ëŸ¬)</label><input type="number" id="fixedPrice" oninput="updatePriceInput(this.value); onInputChange();"></div>
            <div style="flex:1.2; font-size:12px; text-align:right;" id="fixedPriceInfo"></div>
        </div>
        <div class="section-title">ìƒí’ˆ ê·œê²©</div>
        <div class="row">
            <div><label>ë¬´ê²Œ(kg) <span id="dot_w" class="req-dot">.</span></label><input type="number" id="w" step="0.01" oninput="onInputChange()"></div>
            <div><label>ë°°ì†¡</label><select id="shipType" onchange="onInputChange()"><option value="6000">ì¼ë°˜</option><option value="5000">íŠ¹ì†¡</option></select></div>
        </div>
        <div class="row">
            <div><label>ê°€ë¡œ</label><input type="number" id="x" oninput="onInputChange()"></div>
            <div><label>ì„¸ë¡œ</label><input type="number" id="y" oninput="onInputChange()"></div>
            <div><label>ë†’ì´</label><input type="number" id="z" oninput="onInputChange()"></div>
        </div>
        <div id="liveDetail" style="font-size:11px; margin-top:5px; color:#666;"></div>
        <div class="section-title">ê¸°íƒ€ ë¹„ìš©</div>
        <div class="row">
            <div><label>êµ­ë‚´ë¹„</label><input type="number" id="local" value="3000" oninput="onInputChange()"></div>
            <div><label>í¬ì¥ë¹„</label><input type="number" id="pack" value="1000" oninput="onInputChange()"></div>
        </div>
        <div id="resultArea" class="result">
            <span id="resPrice" class="price-tag">$0.00</span>
            <div id="resMarginInfo" style="text-align:center; font-weight:bold;"></div>
        </div>
    </div>
</div>

<div id="tab-lib" class="tab-content">
    <div class="save-box">
        <h3>ğŸ“ ìƒí’ˆ ì €ì¥ì†Œ</h3>
        <input type="text" id="saveTitle" placeholder="ìƒí’ˆëª… ì…ë ¥">
        <div id="preview-container">ì¤€ë¹„ëœ ì‚¬ì§„ ì—†ìŒ</div>
        <div class="row" style="margin-top:10px;">
            <button style="flex:1; padding:10px; background:#27ae60; color:white; border:none; border-radius:5px;" onclick="startCamera()">ğŸ“· ì—°ì† ì´¬ì˜</button>
            <button style="flex:1; padding:10px; background:#eee; border:none; border-radius:5px;" onclick="openGallery()">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬</button>
        </div>
        <button id="batch-save-btn" style="width:100%; margin-top:10px; padding:12px; background:#3498db; color:white; border:none; border-radius:5px; display:none;" onclick="saveToLibrary()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        <input type="file" id="photoGallery" accept="image/*" multiple style="display:none;" onchange="handleImg(this)">
        <div id="library-list" style="margin-top:20px;"></div>
    </div>
</div>

<script>
    /* [ë°ì´í„° ë° ìƒíƒœ ê´€ë¦¬] */
    let currentImgStack = []; 
    let currentLoadedId = null; 
    let modalImgIdx = 0; 
    let modalImgList = [];
    let historyStack = [];
    let lastField = 'margin';
    let videoStream = null;

    /* [1. ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì œì–´ (íˆìŠ¤í† ë¦¬)] */
    window.addEventListener('popstate', function(e) {
        if (document.getElementById('img-modal').style.display === 'flex') {
            closeModal(true); // íˆìŠ¤í† ë¦¬ ì´ë²¤íŠ¸ë¡œ ë‹«ì„ ë•ŒëŠ” state push ì•ˆí•¨
        } else if (document.getElementById('share-modal').style.display === 'flex') {
            closeShareModal(true);
        }
    });

    /* [2. ì‚¬ì§„ ìƒì„¸ ë³´ê¸° & í™•ëŒ€/ì‚­ì œ] */
    let scale = 1; let pointX = 0; let pointY = 0; let start = {x:0, y:0};
    const mImg = document.getElementById('modal-img');

    function openModalWithList(e, list, id) {
        e.stopPropagation();
        modalImgList = list;
        modalImgIdx = 0;
        currentLoadedId = id; // ì–´ë–¤ ì•„ì´í…œì˜ ì‚¬ì§„ì¸ì§€ ì €ì¥
        showModalImg();
        document.getElementById('img-modal').style.display = "flex";
        history.pushState({modal: 'open'}, ''); // ê°€ì§œ íˆìŠ¤í† ë¦¬ ì¶”ê°€
    }

    function showModalImg() {
        scale = 1; pointX = 0; pointY = 0;
        mImg.style.transform = `translate(0px, 0px) scale(1)`;
        mImg.src = modalImgList[modalImgIdx];
    }

    function closeModal(isPopState = false) {
        document.getElementById('img-modal').style.display = "none";
        if (!isPopState) history.back(); // X ë²„íŠ¼ ëˆŒëŸ¬ì„œ ë‹«ì„ ë•Œë§Œ íˆìŠ¤í† ë¦¬ ë’¤ë¡œê°€ê¸°
    }

    // ì‚¬ì§„ ê°œë³„ ì‚­ì œ
    function deleteSinglePhoto() {
        if (confirm("ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            let lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
            let item = lib.find(i => i.id === currentLoadedId);
            if (item) {
                item.imgList.splice(modalImgIdx, 1);
                if (item.imgList.length === 0) {
                    lib = lib.filter(i => i.id !== currentLoadedId);
                    closeModal();
                } else {
                    modalImgList = item.imgList;
                    if (modalImgIdx >= modalImgList.length) modalImgIdx = modalImgList.length - 1;
                    showModalImg();
                }
                localStorage.setItem('nanaLibrary', JSON.stringify(lib));
                renderLibrary();
            }
        }
    }

    // í™•ëŒ€ ê¸°ëŠ¥ (ë”ë¸”íƒ­ & í•€ì¹˜ì¤Œ ëŒ€ì‘ì„ ìœ„í•œ ê¸°ì´ˆ í„°ì¹˜ ì´ë²¤íŠ¸)
    mImg.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            start = { x: e.touches[0].clientX - pointX, y: e.touches[0].clientY - pointY };
        }
    });
    mImg.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (e.touches.length === 1 && scale > 1) {
            pointX = e.touches[0].clientX - start.x;
            pointY = e.touches[0].clientY - start.y;
            mImg.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        }
    });
    // ë”ë¸”íƒ­ í™•ëŒ€/ì¶•ì†Œ
    let lastTap = 0;
    mImg.addEventListener('touchend', (e) => {
        let now = new Date().getTime();
        if (now - lastTap < 300) {
            scale = (scale === 1) ? 2.5 : 1;
            pointX = 0; pointY = 0;
            mImg.style.transform = `translate(0px, 0px) scale(${scale})`;
        }
        lastTap = now;
    });

    /* [3. SNS ì„ íƒ ê³µìœ  ê¸°ëŠ¥] */
    let shareSelectedId = null;
    let shareCheckList = [];

    function openShareSNS(e, id) {
        e.stopPropagation();
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const item = lib.find(i => i.id === id);
        if (!item) return;
        
        shareSelectedId = id;
        shareCheckList = new Array(item.imgList.length).fill(true); // ê¸°ë³¸ ì „ì²´ ì„ íƒ
        
        const grid = document.getElementById('share-img-grid');
        grid.innerHTML = '';
        item.imgList.forEach((img, idx) => {
            const div = document.createElement('div');
            div.className = 'share-img-item selected';
            div.innerHTML = `<img src="${img}"><div class="share-check">âœ”</div>`;
            div.onclick = () => {
                shareCheckList[idx] = !shareCheckList[idx];
                div.classList.toggle('selected', shareCheckList[idx]);
            };
            grid.appendChild(div);
        });
        document.getElementById('share-modal').style.display = 'flex';
        history.pushState({share: 'open'}, '');
    }

    function closeShareModal(isPopState = false) {
        document.getElementById('share-modal').style.display = 'none';
        if (!isPopState) history.back();
    }

    async function executeShare() {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const item = lib.find(i => i.id === shareSelectedId);
        const selectedImgs = item.imgList.filter((_, idx) => shareCheckList[idx]);

        if (selectedImgs.length === 0) { alert("ê³µìœ í•  ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

        try {
            const files = await Promise.all(selectedImgs.map(async (base64, i) => {
                const res = await fetch(base64);
                const blob = await res.blob();
                return new File([blob], `photo_${i}.jpg`, { type: 'image/jpeg' });
            }));

            if (navigator.share) {
                await navigator.share({ files: files, title: 'ìƒí’ˆ ì •ë³´ ê³µìœ ' });
                closeShareModal();
            } else { alert("ê³µìœ ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤."); }
        } catch (err) { console.error(err); }
    }

    /* [ê¸°ì¡´ ì´¬ì˜/ì €ì¥/ê³„ì‚° ë¡œì§ ìœ ì§€] */
    async function startCamera() {
        const overlay = document.getElementById('camera-overlay');
        const video = document.getElementById('camera-video');
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = videoStream;
        overlay.style.display = 'flex';
    }
    function stopCamera() {
        if(videoStream) videoStream.getTracks().forEach(t => t.stop());
        document.getElementById('camera-overlay').style.display = 'none';
        renderPreviews();
    }
    function takePhoto() {
        const video = document.getElementById('camera-video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        currentImgStack.push(canvas.toDataURL('image/jpeg', 0.7));
        document.getElementById('shot-count').innerText = `${currentImgStack.length}ì¥ ì´¬ì˜ë¨`;
    }
    function renderPreviews() {
        const container = document.getElementById('preview-container');
        container.innerHTML = currentImgStack.length ? "" : "ì¤€ë¹„ëœ ì‚¬ì§„ ì—†ìŒ";
        currentImgStack.forEach((img, idx) => {
            container.innerHTML += `<div class="thumb-box"><img src="${img}"><div onclick="currentImgStack.splice(${idx},1);renderPreviews();" style="position:absolute;top:0;right:0;background:red;color:white;padding:2px;">Ã—</div></div>`;
        });
        document.getElementById('batch-save-btn').style.display = currentImgStack.length ? 'block' : 'none';
    }
    function saveToLibrary() {
        const title = document.getElementById('saveTitle').value || "ìƒˆ ìƒí’ˆ";
        const item = { id: Date.now(), title, date: new Date().toLocaleString(), imgList: [...currentImgStack], data: saveInputs() };
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        lib.unshift(item);
        localStorage.setItem('nanaLibrary', JSON.stringify(lib));
        currentImgStack = []; document.getElementById('saveTitle').value = ""; renderPreviews(); renderLibrary();
    }
    function renderLibrary() {
        const lib = JSON.parse(localStorage.getItem('nanaLibrary') || "[]");
        const list = document.getElementById('library-list');
        list.innerHTML = "";
        lib.forEach(item => {
            const div = document.createElement('div');
            div.className = 'library-item';
            const imgHtml = item.imgList.length ? `<img src="${item.imgList[0]}" onclick="openModalWithList(event, ${JSON.stringify(item.imgList).replace(/"/g, '&quot;')}, ${item.id})">` : '';
            div.innerHTML = `${imgHtml}<div class="library-info"><b>${item.title}</b><br><small>${item.date}</small></div><button onclick="openShareSNS(event, ${item.id})" style="background:#fee500; border:none; padding:5px; border-radius:4px; font-weight:bold;">SNS</button>`;
            list.appendChild(div);
        });
    }

    // [ìŠ¤ì™€ì´í”„ ë„¤ë¹„ê²Œì´ì…˜]
    let touchStartX = 0;
    document.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX, {passive: true});
    document.addEventListener('touchend', e => {
        const diffX = e.changedTouches[0].screenX - touchStartX;
        if (Math.abs(diffX) > 60) {
            if (document.getElementById('img-modal').style.display === 'flex') {
                if (diffX > 0) { modalImgIdx = (modalImgIdx > 0) ? modalImgIdx - 1 : modalImgList.length - 1; }
                else { modalImgIdx = (modalImgIdx < modalImgList.length - 1) ? modalImgIdx + 1 : 0; }
                showModalImg();
            }
        }
    }, {passive: true});

    function switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        if(t==='lib') renderLibrary();
    }

    /* ë‚˜ë¨¸ì§€ ê³„ì‚°ê¸° ë¡œì§ (doCalc, filterList ë“±)ì€ ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼í•˜ê²Œ ìë™ ì‘ë™ */
    function saveInputs() { /* ê¸°ì¡´ê³¼ ë™ì¼ */ return {}; }
    function onInputChange() { /* ê¸°ì¡´ê³¼ ë™ì¼ */ }
    window.onload = () => { renderLibrary(); };
</script>
</body>
</html>
